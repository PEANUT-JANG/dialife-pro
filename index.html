<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1형 당뇨 관리</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        const STORAGE_KEYS = {
            USERS: 'diabetes_app_users',
            CURRENT_USER: 'diabetes_app_current_user',
            DISCLAIMER: 'diabetes_app_disclaimer_accepted'
        };

        // 간단한 해시 함수 (실제 운영환경에서는 더 강력한 해싱 필요)
        const simpleHash = (str) => {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString(36);
        };

        function DiabetesApp() {
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [currentUser, setCurrentUser] = useState(null);
            const [showLoginModal, setShowLoginModal] = useState(true);
            const [isSignupMode, setIsSignupMode] = useState(false);
            const [loginForm, setLoginForm] = useState({ username: '', password: '' });
            const [disclaimerAccepted, setDisclaimerAccepted] = useState(false);
            const [profiles, setProfiles] = useState([]);
            const [currentProfile, setCurrentProfile] = useState(null);
            const [currentTab, setCurrentTab] = useState('dashboard');
            const [showRecordModal, setShowRecordModal] = useState(false);
            const [showExerciseModal, setShowExerciseModal] = useState(false);
            const [showCalculatorModal, setShowCalculatorModal] = useState(false);
            const [showSettingsModal, setShowSettingsModal] = useState(false);

            const [recordForm, setRecordForm] = useState({
                bloodSugar: '', insulin: '', food: '', exercise: '', note: ''
            });

            const [exerciseForm, setExerciseForm] = useState({
                type: '헬스', intensity: '중간', startBG: ''
            });

            const [calculatorForm, setCalculatorForm] = useState({
                currentBG: '', foodName: '', carbs: ''
            });
            const [calculatedInsulin, setCalculatedInsulin] = useState(null);

            // 초기 로딩 플래그
            const isInitialLoad = useRef(true);

            // 사용자 데이터 저장 함수 (useCallback으로 최적화)
            const saveUserData = useCallback(() => {
                if (!currentUser || !currentProfile || !profiles.length || isInitialLoad.current) {
                    return;
                }
                try {
                    const userDataKey = `diabetes_data_${currentUser.username}`;
                    const userData = {
                        profiles: profiles,
                        currentProfile: currentProfile
                    };
                    localStorage.setItem(userDataKey, JSON.stringify(userData));
                } catch (error) {
                    console.error('저장 오류:', error);
                }
            }, [currentUser, currentProfile, profiles]);

            // 초기 로딩
            useEffect(() => {
                try {
                    // 면책 조항 확인
                    const disclaimerStatus = localStorage.getItem(STORAGE_KEYS.DISCLAIMER);
                    if (disclaimerStatus === 'accepted') {
                        setDisclaimerAccepted(true);
                    }

                    // 로그인 상태 확인
                    const savedUser = localStorage.getItem(STORAGE_KEYS.CURRENT_USER);
                    if (savedUser) {
                        const user = JSON.parse(savedUser);
                        setCurrentUser(user);
                        setIsLoggedIn(true);
                        setShowLoginModal(false);
                        loadUserData(user.username);
                    }
                } catch (error) {
                    console.error('로딩 오류:', error);
                }
            }, []);

            // 데이터 변경 시 자동 저장 (초기 로딩 이후)
            useEffect(() => {
                if (!isInitialLoad.current) {
                    saveUserData();
                }
            }, [currentProfile, profiles, saveUserData]);

            const loadUserData = (username) => {
                try {
                    const userDataKey = `diabetes_data_${username}`;
                    const savedData = localStorage.getItem(userDataKey);
                    
                    if (savedData) {
                        const userData = JSON.parse(savedData);
                        setProfiles(userData.profiles || []);
                        setCurrentProfile(userData.currentProfile || userData.profiles[0]);
                    } else {
                        // 새 사용자 데이터 초기화
                        const defaultProfile = {
                            id: Date.now().toString(),
                            name: '내 프로필',
                            createdAt: new Date().toISOString(),
                            settings: { icr: 10, isf: 50, targetBG: 120 },
                            records: [],
                            exerciseSessions: []
                        };
                        setProfiles([defaultProfile]);
                        setCurrentProfile(defaultProfile);
                        
                        // 새 사용자는 즉시 저장
                        setTimeout(() => {
                            const userData = {
                                profiles: [defaultProfile],
                                currentProfile: defaultProfile
                            };
                            localStorage.setItem(userDataKey, JSON.stringify(userData));
                        }, 100);
                    }
                    
                    // 초기 로딩 완료
                    setTimeout(() => {
                        isInitialLoad.current = false;
                    }, 200);
                } catch (error) {
                    console.error('사용자 데이터 로딩 오류:', error);
                }
            };

            const handleLogin = () => {
                if (!loginForm.username || !loginForm.password) {
                    alert('아이디와 비밀번호를 입력해주세요.');
                    return;
                }

                if (loginForm.username.length < 3) {
                    alert('아이디는 3자 이상이어야 합니다.');
                    return;
                }

                if (loginForm.password.length < 4) {
                    alert('비밀번호는 4자 이상이어야 합니다.');
                    return;
                }

                try {
                    const usersData = localStorage.getItem(STORAGE_KEYS.USERS);
                    const users = usersData ? JSON.parse(usersData) : {};

                    if (isSignupMode) {
                        // 회원가입
                        if (users[loginForm.username]) {
                            alert('이미 존재하는 아이디입니다.');
                            return;
                        }
                        users[loginForm.username] = {
                            username: loginForm.username,
                            passwordHash: simpleHash(loginForm.password),
                            createdAt: new Date().toISOString()
                        };
                        localStorage.setItem(STORAGE_KEYS.USERS, JSON.stringify(users));
                        alert('회원가입이 완료되었습니다. 로그인해주세요.');
                        setIsSignupMode(false);
                        setLoginForm({ username: loginForm.username, password: '' });
                    } else {
                        // 로그인
                        const user = users[loginForm.username];
                        if (!user || user.passwordHash !== simpleHash(loginForm.password)) {
                            alert('아이디 또는 비밀번호가 올바르지 않습니다.');
                            return;
                        }
                        
                        setCurrentUser(user);
                        setIsLoggedIn(true);
                        setShowLoginModal(false);
                        localStorage.setItem(STORAGE_KEYS.CURRENT_USER, JSON.stringify(user));
                        isInitialLoad.current = true; // 로그인 시 초기 로딩 플래그 리셋
                        loadUserData(user.username);
                    }
                } catch (error) {
                    console.error('로그인 오류:', error);
                    alert('로그인 중 오류가 발생했습니다.');
                }
            };

            const handleLogout = () => {
                if (confirm('로그아웃 하시겠습니까?')) {
                    // 현재 데이터 최종 저장
                    if (currentUser && currentProfile && profiles.length > 0) {
                        const userDataKey = `diabetes_data_${currentUser.username}`;
                        const userData = {
                            profiles: profiles,
                            currentProfile: currentProfile
                        };
                        localStorage.setItem(userDataKey, JSON.stringify(userData));
                    }
                    
                    // 상태 초기화
                    localStorage.removeItem(STORAGE_KEYS.CURRENT_USER);
                    setIsLoggedIn(false);
                    setCurrentUser(null);
                    setProfiles([]);
                    setCurrentProfile(null);
                    setShowLoginModal(true);
                    setLoginForm({ username: '', password: '' });
                    setCurrentTab('dashboard');
                    isInitialLoad.current = true;
                }
            };

            const addRecord = () => {
                if (!recordForm.bloodSugar && !recordForm.insulin && !recordForm.food) {
                    alert('최소 하나의 정보를 입력해주세요.');
                    return;
                }
                const newRecord = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    ...recordForm
                };
                setCurrentProfile({
                    ...currentProfile,
                    records: [...(currentProfile.records || []), newRecord]
                });
                setRecordForm({ bloodSugar: '', insulin: '', food: '', exercise: '', note: '' });
                setShowRecordModal(false);
            };

            const deleteRecord = (id) => {
                if (confirm('이 기록을 삭제하시겠습니까?')) {
                    setCurrentProfile({
                        ...currentProfile,
                        records: currentProfile.records.filter(r => r.id !== id)
                    });
                }
            };

            const addExerciseSession = () => {
                if (!exerciseForm.startBG) {
                    alert('시작 혈당을 입력해주세요.');
                    return;
                }
                const newSession = {
                    id: Date.now(),
                    type: exerciseForm.type,
                    startTime: new Date().toISOString(),
                    endTime: '',
                    intensity: exerciseForm.intensity,
                    bgRecords: [{
                        timestamp: new Date().toISOString(),
                        value: exerciseForm.startBG,
                        label: '운동 시작'
                    }],
                    note: '',
                    status: 'active'
                };
                setCurrentProfile({
                    ...currentProfile,
                    exerciseSessions: [...(currentProfile.exerciseSessions || []), newSession]
                });
                setExerciseForm({ type: '헬스', intensity: '중간', startBG: '' });
                setShowExerciseModal(false);
            };

            const deleteExerciseSession = (id) => {
                if (confirm('이 운동 세션을 삭제하시겠습니까?')) {
                    setCurrentProfile({
                        ...currentProfile,
                        exerciseSessions: currentProfile.exerciseSessions.filter(s => s.id !== id)
                    });
                }
            };

            const calculateInsulin = () => {
                if (!calculatorForm.currentBG || !calculatorForm.carbs) {
                    alert('현재 혈당과 탄수화물을 입력해주세요.');
                    return;
                }
                const bg = parseFloat(calculatorForm.currentBG);
                const carbs = parseFloat(calculatorForm.carbs);
                const settings = currentProfile.settings;

                const carbInsulin = carbs / settings.icr;
                const correctionInsulin = (bg - settings.targetBG) / settings.isf;
                const totalInsulin = Math.max(0, carbInsulin + correctionInsulin);

                setCalculatedInsulin({
                    carb: carbInsulin.toFixed(1),
                    correction: correctionInsulin.toFixed(1),
                    total: totalInsulin.toFixed(1),
                    rounded: Math.round(totalInsulin * 2) / 2
                });
            };

            const saveCalculatorAsRecord = () => {
                const newRecord = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    bloodSugar: calculatorForm.currentBG,
                    insulin: calculatedInsulin.rounded.toString(),
                    food: calculatorForm.foodName ? `${calculatorForm.foodName} (탄${calculatorForm.carbs}g)` : `탄수화물 ${calculatorForm.carbs}g`,
                    exercise: '',
                    note: '인슐린 계산기로 추가됨'
                };
                setCurrentProfile({
                    ...currentProfile,
                    records: [...(currentProfile.records || []), newRecord]
                });
                setShowCalculatorModal(false);
                setCalculatorForm({ currentBG: '', foodName: '', carbs: '' });
                setCalculatedInsulin(null);
            };

            const exportData = () => {
                const dataStr = JSON.stringify(currentProfile, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `diabetes-${currentProfile.name}-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
            };

            if (!disclaimerAccepted) {
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div className="bg-white rounded-lg max-w-2xl w-full p-6">
                            <h2 className="text-xl font-bold text-red-600 mb-4">⚠️ 의료 면책조항</h2>
                            <ul className="list-disc pl-5 space-y-2 text-sm mb-6">
                                <li>본 앱은 1형 당뇨병 관리를 돕기 위한 <strong>보조 도구</strong>입니다.</li>
                                <li>인슐린 투여량 계산은 <strong>참고용</strong>이며, 실제 투여 전 반드시 주치의와 상담하세요.</li>
                                <li>응급 상황 시 즉시 의료기관을 방문하세요.</li>
                                <li>대한당뇨병학회 및 보건복지부 지침을 참고하여 제작되었습니다.</li>
                            </ul>
                            <button
                                onClick={() => {
                                    setDisclaimerAccepted(true);
                                    localStorage.setItem(STORAGE_KEYS.DISCLAIMER, 'accepted');
                                }}
                                className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700"
                            >
                                동의하고 시작하기
                            </button>
                        </div>
                    </div>
                );
            }

            if (showLoginModal || !isLoggedIn) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center p-4">
                        <div className="bg-white rounded-lg max-w-md w-full p-8 shadow-2xl">
                            <div className="text-center mb-8">
                                <h1 className="text-3xl font-bold text-gray-800 mb-2">🩺 1형 당뇨 관리</h1>
                                <p className="text-gray-600">{isSignupMode ? '새 계정을 만들어주세요' : '로그인하여 시작하세요'}</p>
                            </div>
                            
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">아이디</label>
                                    <input
                                        type="text"
                                        value={loginForm.username}
                                        onChange={(e) => setLoginForm({...loginForm, username: e.target.value})}
                                        onKeyDown={(e) => e.key === 'Enter' && handleLogin()}
                                        className="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="아이디를 입력하세요 (3자 이상)"
                                        autoComplete="username"
                                    />
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">비밀번호</label>
                                    <input
                                        type="password"
                                        value={loginForm.password}
                                        onChange={(e) => setLoginForm({...loginForm, password: e.target.value})}
                                        onKeyDown={(e) => e.key === 'Enter' && handleLogin()}
                                        className="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="비밀번호를 입력하세요 (4자 이상)"
                                        autoComplete={isSignupMode ? "new-password" : "current-password"}
                                    />
                                </div>
                                
                                <button
                                    onClick={handleLogin}
                                    className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition"
                                >
                                    {isSignupMode ? '회원가입' : '로그인'}
                                </button>
                                
                                <div className="text-center">
                                    <button
                                        onClick={() => {
                                            setIsSignupMode(!isSignupMode);
                                            setLoginForm({ username: '', password: '' });
                                        }}
                                        className="text-blue-600 hover:text-blue-700 text-sm font-medium"
                                    >
                                        {isSignupMode ? '이미 계정이 있으신가요? 로그인' : '계정이 없으신가요? 회원가입'}
                                    </button>
                                </div>
                            </div>
                            
                            <div className="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                                <p className="text-xs text-yellow-800">
                                    <strong>⚠️ 주의:</strong> 이 앱은 브라우저 로컬 저장소를 사용합니다. 
                                    브라우저 데이터를 삭제하면 기록이 손실될 수 있습니다.
                                </p>
                            </div>
                        </div>
                    </div>
                );
            }

            if (!currentProfile) {
                return <div className="flex items-center justify-center h-screen">로딩중...</div>;
            }

            const records = currentProfile.records || [];
            const exerciseSessions = currentProfile.exerciseSessions || [];
            const settings = currentProfile.settings || { icr: 10, isf: 50, targetBG: 120 };

            const latestBG = records.filter(r => r.bloodSugar).sort((a, b) => 
                new Date(b.timestamp) - new Date(a.timestamp)
            )[0];

            return (
                <div className="min-h-screen bg-gray-50">
                    <header className="bg-blue-600 text-white p-4 shadow-lg">
                        <div className="max-w-6xl mx-auto flex items-center justify-between">
                            <div>
                                <h1 className="text-2xl font-bold">1형 당뇨 관리</h1>
                                <p className="text-sm">👤 {currentUser?.username} | 프로필: {currentProfile.name}</p>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => setShowSettingsModal(true)} className="p-2 hover:bg-blue-700 rounded" title="설정">⚙️</button>
                                <button onClick={exportData} className="p-2 hover:bg-blue-700 rounded" title="내보내기">⬇️</button>
                                <button onClick={handleLogout} className="px-3 py-2 bg-blue-700 hover:bg-blue-800 rounded font-medium text-sm" title="로그아웃">🚪 로그아웃</button>
                            </div>
                        </div>
                    </header>

                    <div className="bg-white shadow">
                        <div className="max-w-6xl mx-auto flex">
                            <button onClick={() => setCurrentTab('dashboard')} className={`flex-1 py-3 font-medium ${currentTab === 'dashboard' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'}`}>대시보드</button>
                            <button onClick={() => setCurrentTab('records')} className={`flex-1 py-3 font-medium ${currentTab === 'records' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'}`}>기록 관리</button>
                            <button onClick={() => setCurrentTab('exercise')} className={`flex-1 py-3 font-medium ${currentTab === 'exercise' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'}`}>운동 추적</button>
                        </div>
                    </div>

                    <main className="max-w-6xl mx-auto p-4 space-y-4">
                        {currentTab === 'dashboard' && (
                            <>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div className="bg-white rounded-lg shadow p-4">
                                        <p className="text-sm text-gray-600 mb-2">최근 혈당</p>
                                        <p className={`text-3xl font-bold ${latestBG ? (parseFloat(latestBG.bloodSugar) < 70 ? 'text-red-600' : parseFloat(latestBG.bloodSugar) > 180 ? 'text-orange-600' : 'text-green-600') : 'text-gray-400'}`}>
                                            {latestBG ? `${latestBG.bloodSugar} mg/dL` : '기록 없음'}
                                        </p>
                                    </div>
                                    <div className="bg-white rounded-lg shadow p-4">
                                        <p className="text-sm text-gray-600 mb-2">총 기록</p>
                                        <p className="text-3xl font-bold text-blue-600">{records.length}건</p>
                                    </div>
                                    <div className="bg-white rounded-lg shadow p-4">
                                        <p className="text-sm text-gray-600 mb-2">운동 세션</p>
                                        <p className="text-3xl font-bold text-purple-600">{exerciseSessions.length}건</p>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <button onClick={() => setShowRecordModal(true)} className="bg-blue-600 text-white p-4 rounded-lg font-semibold hover:bg-blue-700">➕ 혈당 기록 추가</button>
                                    <button onClick={() => setShowCalculatorModal(true)} className="bg-green-600 text-white p-4 rounded-lg font-semibold hover:bg-green-700">🍎 인슐린 계산기</button>
                                    <button onClick={() => setShowExerciseModal(true)} className="bg-purple-600 text-white p-4 rounded-lg font-semibold hover:bg-purple-700">🏋️ 운동 시작</button>
                                </div>

                                <div className="bg-white rounded-lg shadow p-4">
                                    <h2 className="text-lg font-bold mb-4">최근 기록</h2>
                                    {records.length === 0 ? (
                                        <p className="text-gray-500 text-center py-8">기록이 없습니다. 첫 기록을 추가해보세요!</p>
                                    ) : (
                                        <div className="space-y-2">
                                            {records.slice(-5).reverse().map(record => (
                                                <div key={record.id} className="border rounded p-3 flex justify-between items-start">
                                                    <div className="flex-1">
                                                        <p className="text-sm text-gray-600">{new Date(record.timestamp).toLocaleString('ko-KR')}</p>
                                                        {record.bloodSugar && <p className="font-semibold">혈당: {record.bloodSugar} mg/dL</p>}
                                                        {record.insulin && <p className="text-blue-600">인슐린: {record.insulin}U</p>}
                                                        {record.food && <p className="text-sm">🍽️ {record.food}</p>}
                                                    </div>
                                                    <button onClick={() => deleteRecord(record.id)} className="text-red-600 hover:text-red-800">🗑️</button>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </>
                        )}

                        {currentTab === 'records' && (
                            <div className="bg-white rounded-lg shadow p-4">
                                <h2 className="text-lg font-bold mb-4">전체 기록 ({records.length}건)</h2>
                                {records.length === 0 ? (
                                    <p className="text-gray-500 text-center py-8">기록이 없습니다.</p>
                                ) : (
                                    <div className="space-y-2 max-h-96 overflow-y-auto">
                                        {records.slice().reverse().map(record => (
                                            <div key={record.id} className="border rounded p-3 flex justify-between items-start">
                                                <div className="flex-1">
                                                    <p className="text-sm text-gray-600">{new Date(record.timestamp).toLocaleString('ko-KR')}</p>
                                                    {record.bloodSugar && <p className="font-semibold">혈당: {record.bloodSugar} mg/dL</p>}
                                                    {record.insulin && <p className="text-blue-600">인슐린: {record.insulin}U</p>}
                                                    {record.food && <p className="text-sm">🍽️ {record.food}</p>}
                                                    {record.exercise && <p className="text-sm">💪 {record.exercise}</p>}
                                                    {record.note && <p className="text-xs text-gray-500 mt-1">{record.note}</p>}
                                                </div>
                                                <button onClick={() => deleteRecord(record.id)} className="text-red-600 hover:text-red-800">🗑️</button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {currentTab === 'exercise' && (
                            <div className="bg-white rounded-lg shadow p-4">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-lg font-bold">운동 세션 ({exerciseSessions.length}건)</h2>
                                    <button onClick={() => setShowExerciseModal(true)} className="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">➕ 새 세션</button>
                                </div>
                                {exerciseSessions.length === 0 ? (
                                    <p className="text-gray-500 text-center py-8">운동 세션이 없습니다. 첫 운동을 시작해보세요!</p>
                                ) : (
                                    <div className="space-y-3">
                                        {exerciseSessions.slice().reverse().map(session => (
                                            <div key={session.id} className="border rounded p-4">
                                                <div className="flex justify-between items-start">
                                                    <div className="flex-1">
                                                        <div className="flex items-center gap-2 mb-2">
                                                            <span>🏋️</span>
                                                            <span className="font-semibold">{session.type}</span>
                                                            <span className="text-sm text-gray-600">({session.intensity})</span>
                                                        </div>
                                                        <p className="text-sm text-gray-600">{new Date(session.startTime).toLocaleString('ko-KR')}</p>
                                                        {session.bgRecords && session.bgRecords.length > 0 && (
                                                            <div className="mt-2 bg-purple-50 rounded p-2">
                                                                <p className="text-xs font-medium mb-1">혈당 변화</p>
                                                                {session.bgRecords.map((bg, idx) => (
                                                                    <span key={idx} className="text-xs bg-white px-2 py-1 rounded mr-2">
                                                                        {bg.label}: {bg.value} mg/dL
                                                                    </span>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                    <button onClick={() => deleteExerciseSession(session.id)} className="text-red-600 hover:text-red-800">🗑️</button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}
                    </main>

                    {showRecordModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-lg max-w-md w-full p-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-xl font-bold">혈당 기록 추가</h2>
                                    <button onClick={() => setShowRecordModal(false)} className="text-gray-500 hover:text-gray-700">❌</button>
                                </div>
                                <div className="space-y-3">
                                    <input type="number" placeholder="혈당 (mg/dL)" value={recordForm.bloodSugar} onChange={(e) => setRecordForm({...recordForm, bloodSugar: e.target.value})} className="w-full border rounded px-3 py-2" />
                                    <input type="number" placeholder="인슐린 (단위)" value={recordForm.insulin} onChange={(e) => setRecordForm({...recordForm, insulin: e.target.value})} className="w-full border rounded px-3 py-2" step="0.5" />
                                    <input type="text" placeholder="음식" value={recordForm.food} onChange={(e) => setRecordForm({...recordForm, food: e.target.value})} className="w-full border rounded px-3 py-2" />
                                    <input type="text" placeholder="운동" value={recordForm.exercise} onChange={(e) => setRecordForm({...recordForm, exercise: e.target.value})} className="w-full border rounded px-3 py-2" />
                                    <textarea placeholder="메모 (선택사항)" value={recordForm.note} onChange={(e) => setRecordForm({...recordForm, note: e.target.value})} className="w-full border rounded px-3 py-2" rows="2"></textarea>
                                    <button onClick={addRecord} className="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">저장</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showExerciseModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-lg max-w-md w-full p-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-xl font-bold">운동 세션 시작</h2>
                                    <button onClick={() => setShowExerciseModal(false)} className="text-gray-500 hover:text-gray-700">❌</button>
                                </div>
                                <div className="space-y-3">
                                    <select value={exerciseForm.type} onChange={(e) => setExerciseForm({...exerciseForm, type: e.target.value})} className="w-full border rounded px-3 py-2">
                                        <option value="헬스">헬스</option>
                                        <option value="유산소">유산소</option>
                                        <option value="요가">요가</option>
                                        <option value="수영">수영</option>
                                        <option value="걷기">걷기</option>
                                        <option value="자전거">자전거</option>
                                    </select>
                                    <select value={exerciseForm.intensity} onChange={(e) => setExerciseForm({...exerciseForm, intensity: e.target.value})} className="w-full border rounded px-3 py-2">
                                        <option value="낮음">낮음</option>
                                        <option value="중간">중간</option>
                                        <option value="높음">높음</option>
                                    </select>
                                    <input type="number" placeholder="시작 혈당 (mg/dL)" value={exerciseForm.startBG} onChange={(e) => setExerciseForm({...exerciseForm, startBG: e.target.value})} className="w-full border rounded px-3 py-2" />
                                    <button onClick={addExerciseSession} className="w-full bg-purple-600 text-white py-2 rounded hover:bg-purple-700">운동 시작</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showCalculatorModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-lg max-w-lg w-full p-6 max-h-screen overflow-y-auto">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-xl font-bold">🍎 인슐린 계산기</h2>
                                    <button onClick={() => {
                                        setShowCalculatorModal(false);
                                        setCalculatedInsulin(null);
                                    }} className="text-gray-500 hover:text-gray-700">❌</button>
                                </div>
                                <div className="bg-yellow-50 border border-yellow-200 rounded p-3 mb-4 text-sm">
                                    <p className="font-medium text-yellow-800">⚠️ 계산 결과는 참고용입니다</p>
                                    <p className="text-yellow-700">실제 인슐린 투여 전 반드시 주치의와 상담하세요.</p>
                                </div>
                                <div className="space-y-3">
                                    <input type="number" placeholder="현재 혈당 (mg/dL)" value={calculatorForm.currentBG} onChange={(e) => setCalculatorForm({...calculatorForm, currentBG: e.target.value})} className="w-full border rounded px-3 py-2" />
                                    <input type="text" placeholder="음식 이름 (선택사항)" value={calculatorForm.foodName} onChange={(e) => setCalculatorForm({...calculatorForm, foodName: e.target.value})} className="w-full border rounded px-3 py-2" />
                                    <input type="number" placeholder="탄수화물 (g)" value={calculatorForm.carbs} onChange={(e) => setCalculatorForm({...calculatorForm, carbs: e.target.value})} className="w-full border rounded px-3 py-2" step="0.1" />
                                    <button onClick={calculateInsulin} className="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">인슐린 계산하기</button>
                                    
                                    {calculatedInsulin && (
                                        <div className="bg-blue-50 border border-blue-200 rounded p-4">
                                            <h3 className="font-semibold mb-2">계산 결과</h3>
                                            <div className="space-y-1 text-sm">
                                                <p>• 탄수화물 처리: {calculatedInsulin.carb} 단위</p>
                                                <p>• 혈당 보정: {calculatedInsulin.correction} 단위</p>
                                                <p>• 합계: {calculatedInsulin.total} 단위</p>
                                                <p className="text-lg font-bold text-blue-600 mt-2">→ 권장 투여량: {calculatedInsulin.rounded} 단위</p>
                                            </div>
                                            <button onClick={saveCalculatorAsRecord} className="w-full mt-3 bg-green-600 text-white py-2 rounded hover:bg-green-700">✅ 기록으로 저장</button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {showSettingsModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-lg max-w-md w-full p-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-xl font-bold">설정</h2>
                                    <button onClick={() => setShowSettingsModal(false)} className="text-gray-500 hover:text-gray-700">❌</button>
                                </div>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">인슐린-탄수화물 비율 (ICR)</label>
                                        <input type="number" value={settings.icr} onChange={(e) => { const newSettings = {...settings, icr: parseFloat(e.target.value) || 10}; setCurrentProfile({...currentProfile, settings: newSettings}); }} className="w-full border rounded px-3 py-2" step="0.5" min="1" />
                                        <p className="text-xs text-gray-500 mt-1">1단위 인슐린이 처리하는 탄수화물(g)</p>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">인슐린 민감도 계수 (ISF)</label>
                                        <input type="number" value={settings.isf} onChange={(e) => { const newSettings = {...settings, isf: parseFloat(e.target.value) || 50}; setCurrentProfile({...currentProfile, settings: newSettings}); }} className="w-full border rounded px-3 py-2" min="1" />
                                        <p className="text-xs text-gray-500 mt-1">1단위 인슐린으로 낮출 수 있는 혈당(mg/dL)</p>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">목표 혈당 (mg/dL)</label>
                                        <input type="number" value={settings.targetBG} onChange={(e) => { const newSettings = {...settings, targetBG: parseFloat(e.target.value) || 120}; setCurrentProfile({...currentProfile, settings: newSettings}); }} className="w-full border rounded px-3 py-2" min="70" max="180" />
                                    </div>
                                    <button onClick={() => setShowSettingsModal(false)} className="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">저장</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <footer className="mt-8 py-4 text-center text-sm text-gray-500 bg-white">
                        <p>본 애플리케이션은 의료 전문가의 조언을 대체할 수 없습니다.</p>
                        <p className="mt-1">대한당뇨병학회 및 보건복지부 지침을 참고하여 제작되었습니다.</p>
                    </footer>
                </div>
            );
        }

        ReactDOM.render(<DiabetesApp />, document.getElementById('root'));
    </script>
</body>
</html>
