<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DiaLife Pro - í†µí•© ë‹¹ë‡¨ ê´€ë¦¬</title>
  <!-- React Production ë²„ì „ ì‚¬ìš© -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ë¡œë”© ì¤‘ í‘œì‹œë¥¼ ìœ„í•œ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
    }
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <div id="root">
    <div class="loading">ì•±ì„ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...</div>
  </div>

  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;

    // ìŒì‹ ë°ì´í„°ë² ì´ìŠ¤
    const FOOD_DATABASE = {
      'ë°¥': { carbs: 23, category: 'ì£¼ì‹' },
      'ì‚¬ê³¼': { carbs: 14, category: 'ê³¼ì¼' },
      'ë°”ë‚˜ë‚˜': { carbs: 23, category: 'ê³¼ì¼' },
      'ë¼ë©´': { carbs: 55, category: 'ë©´ë¥˜' },
      'ì´ˆì½œë¦¿': { carbs: 57, category: 'ê°„ì‹' },
      'ë¹µ': { carbs: 50, category: 'ì£¼ì‹' },
      'ìš°ìœ ': { carbs: 5, category: 'ìœ ì œí’ˆ' },
      'ê°ì': { carbs: 17, category: 'ì±„ì†Œ' }
    };

    // localStorage ì•ˆì „ ì ‘ê·¼ í•¨ìˆ˜ë“¤
    const safeLocalStorage = {
      getItem: (key) => {
        try {
          if (typeof Storage !== 'undefined' && window.localStorage) {
            return localStorage.getItem(key);
          }
        } catch (error) {
          console.warn('localStorage ì ‘ê·¼ ì‹¤íŒ¨:', error);
        }
        return null;
      },
      setItem: (key, value) => {
        try {
          if (typeof Storage !== 'undefined' && window.localStorage) {
            localStorage.setItem(key, value);
            return true;
          }
        } catch (error) {
          console.warn('localStorage ì €ì¥ ì‹¤íŒ¨:', error);
        }
        return false;
      }
    };

    const App = () => {
      // ìƒíƒœ ì´ˆê¸°í™”
      const [records, setRecords] = useState([]);
      const [isLoaded, setIsLoaded] = useState(false);
      const [newRecord, setNewRecord] = useState({
        glucose: '', 
        food: '', 
        amount: '', 
        insulin: '', 
        timestamp: ''
      });
      const [editingId, setEditingId] = useState(null);
      const [editData, setEditData] = useState({ 
        glucose: '', 
        food: '', 
        amount: '', 
        insulin: '' 
      });

      // ë°ì´í„° ë¡œë“œ
      useEffect(() => {
        try {
          const saved = safeLocalStorage.getItem('glucose_records');
          if (saved) {
            const parsed = JSON.parse(saved);
            if (Array.isArray(parsed)) {
              setRecords(parsed);
            }
          }
        } catch (error) {
          console.warn('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
        } finally {
          setIsLoaded(true);
        }
      }, []);

      // í˜„ì¬ ì‹œê°„ ì—…ë°ì´íŠ¸
      useEffect(() => {
        const updateTimestamp = () => {
          setNewRecord(prev => ({
            ...prev,
            timestamp: new Date().toISOString()
          }));
        };
        
        updateTimestamp();
        const interval = setInterval(updateTimestamp, 60000); // 1ë¶„ë§ˆë‹¤ ì—…ë°ì´íŠ¸
        
        return () => clearInterval(interval);
      }, []);

      // íƒ„ìˆ˜í™”ë¬¼ ê³„ì‚°
      const calculateCarbs = useCallback((food, amount) => {
        if (!food || !amount || !FOOD_DATABASE[food]) return 0;
        const numAmount = parseFloat(amount);
        if (isNaN(numAmount)) return 0;
        return Math.round((FOOD_DATABASE[food].carbs * numAmount) / 100);
      }, []);

      // ê¸°ë¡ ì €ì¥
      const handleSave = useCallback(() => {
        if (!newRecord.glucose || !newRecord.food) {
          alert('í˜ˆë‹¹ê³¼ ìŒì‹ ì´ë¦„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
          return;
        }

        const record = {
          ...newRecord,
          id: Date.now() + Math.random(), // ë” ê³ ìœ í•œ ID ìƒì„±
          carbs: calculateCarbs(newRecord.food, newRecord.amount),
          timestamp: new Date().toISOString()
        };
        
        const updated = [...records, record];
        setRecords(updated);
        
        // localStorageì— ì €ì¥
        safeLocalStorage.setItem('glucose_records', JSON.stringify(updated));
        
        // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        setNewRecord({ 
          glucose: '', 
          food: '', 
          amount: '', 
          insulin: '', 
          timestamp: new Date().toISOString() 
        });
      }, [newRecord, records, calculateCarbs]);

      // ê¸°ë¡ ì‚­ì œ
      const handleDelete = useCallback((id) => {
        if (!confirm('ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        
        const updated = records.filter(r => r.id !== id);
        setRecords(updated);
        safeLocalStorage.setItem('glucose_records', JSON.stringify(updated));
      }, [records]);

      // ìˆ˜ì • ì‹œì‘
      const startEdit = useCallback((record) => {
        setEditingId(record.id);
        setEditData({
          glucose: record.glucose || '',
          food: record.food || '',
          amount: record.amount || '',
          insulin: record.insulin || ''
        });
      }, []);

      // ìˆ˜ì • í™•ì¸
      const confirmEdit = useCallback((id) => {
        const updated = records.map(r =>
          r.id === id ? {
            ...r,
            ...editData,
            carbs: calculateCarbs(editData.food, editData.amount)
          } : r
        );
        setRecords(updated);
        safeLocalStorage.setItem('glucose_records', JSON.stringify(updated));
        setEditingId(null);
        setEditData({ glucose: '', food: '', amount: '', insulin: '' });
      }, [records, editData, calculateCarbs]);

      // ìˆ˜ì • ì·¨ì†Œ
      const cancelEdit = useCallback(() => {
        setEditingId(null);
        setEditData({ glucose: '', food: '', amount: '', insulin: '' });
      }, []);

      // ë¡œë”© ì¤‘ì¼ ë•Œ
      if (!isLoaded) {
        return (
          <div className="loading">
            ì•±ì„ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gray-50">
          <div className="max-w-4xl mx-auto py-8 px-4">
            <header className="text-center mb-8">
              <h1 className="text-3xl font-bold text-gray-800 mb-2">
                DiaLife Pro ğŸš
              </h1>
              <p className="text-gray-600">ë‹¹ë‡¨ ê´€ë¦¬ë¥¼ ìœ„í•œ í˜ˆë‹¹ ê¸°ë¡ ì•±</p>
            </header>

            {/* ìƒˆ ê¸°ë¡ ì…ë ¥ */}
            <div className="bg-white shadow-lg rounded-xl p-6 mb-8">
              <h2 className="text-xl font-semibold mb-4 text-gray-800">ìƒˆ ê¸°ë¡ ì¶”ê°€</h2>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    í˜ˆë‹¹ (mg/dL) *
                  </label>
                  <input 
                    type="number" 
                    className="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                    placeholder="í˜ˆë‹¹ ìˆ˜ì¹˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                    value={newRecord.glucose}
                    onChange={(e) => setNewRecord({ ...newRecord, glucose: e.target.value })} 
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    ìŒì‹ ì´ë¦„ *
                  </label>
                  <input 
                    type="text" 
                    className="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                    placeholder="ìŒì‹ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
                    value={newRecord.food}
                    onChange={(e) => setNewRecord({ ...newRecord, food: e.target.value })} 
                    list="foodList"
                  />
                  <datalist id="foodList">
                    {Object.keys(FOOD_DATABASE).map(food => (
                      <option key={food} value={food} />
                    ))}
                  </datalist>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    ì„­ì·¨ëŸ‰ (g)
                  </label>
                  <input 
                    type="number" 
                    className="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                    placeholder="ì„­ì·¨ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”"
                    value={newRecord.amount}
                    onChange={(e) => setNewRecord({ ...newRecord, amount: e.target.value })} 
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    ì¸ìŠë¦° ìš©ëŸ‰ (ë‹¨ìœ„)
                  </label>
                  <input 
                    type="number" 
                    className="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                    placeholder="ì¸ìŠë¦° ìš©ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”"
                    value={newRecord.insulin}
                    onChange={(e) => setNewRecord({ ...newRecord, insulin: e.target.value })} 
                  />
                </div>
              </div>
              
              {newRecord.food && FOOD_DATABASE[newRecord.food] && newRecord.amount && (
                <div className="mt-4 p-3 bg-blue-50 rounded-lg">
                  <p className="text-sm text-blue-700">
                    ì˜ˆìƒ íƒ„ìˆ˜í™”ë¬¼: <strong>{calculateCarbs(newRecord.food, newRecord.amount)}g</strong>
                  </p>
                </div>
              )}
              
              <button 
                onClick={handleSave} 
                className="w-full bg-blue-500 text-white rounded-lg py-3 px-4 mt-6 hover:bg-blue-600 transition-colors font-medium"
              >
                ê¸°ë¡ ì €ì¥í•˜ê¸°
              </button>
            </div>

            {/* ê¸°ë¡ ëª©ë¡ */}
            <div className="bg-white shadow-lg rounded-xl p-6">
              <h2 className="text-xl font-semibold mb-4 text-gray-800">
                ê¸°ë¡ ëª©ë¡ ({records.length}ê°œ)
              </h2>
              
              {records.length === 0 ? (
                <div className="text-center py-8">
                  <p className="text-gray-500 text-lg">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                  <p className="text-gray-400 text-sm mt-2">ìœ„ì—ì„œ ì²« ë²ˆì§¸ ê¸°ë¡ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>
                </div>
              ) : (
                <div className="space-y-4">
                  {records.slice().reverse().map(record => (
                    <div key={record.id} className="bg-gray-50 border border-gray-200 rounded-xl p-4">
                      {editingId === record.id ? (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <input 
                            type="number" 
                            value={editData.glucose} 
                            onChange={(e) => setEditData({ ...editData, glucose: e.target.value })} 
                            className="border border-gray-300 p-2 rounded-lg" 
                            placeholder="í˜ˆë‹¹"
                          />
                          <input 
                            type="text" 
                            value={editData.food} 
                            onChange={(e) => setEditData({ ...editData, food: e.target.value })} 
                            className="border border-gray-300 p-2 rounded-lg" 
                            placeholder="ìŒì‹"
                          />
                          <input 
                            type="number" 
                            value={editData.amount} 
                            onChange={(e) => setEditData({ ...editData, amount: e.target.value })} 
                            className="border border-gray-300 p-2 rounded-lg" 
                            placeholder="ì„­ì·¨ëŸ‰"
                          />
                          <input 
                            type="number" 
                            value={editData.insulin} 
                            onChange={(e) => setEditData({ ...editData, insulin: e.target.value })} 
                            className="border border-gray-300 p-2 rounded-lg" 
                            placeholder="ì¸ìŠë¦°"
                          />
                          <div className="col-span-full flex gap-2">
                            <button 
                              onClick={() => confirmEdit(record.id)} 
                              className="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors"
                            >
                              ì €ì¥
                            </button>
                            <button 
                              onClick={cancelEdit} 
                              className="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors"
                            >
                              ì·¨ì†Œ
                            </button>
                          </div>
                        </div>
                      ) : (
                        <div className="flex justify-between items-start">
                          <div className="flex-1">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                              <div>
                                <p className="text-lg"><strong>í˜ˆë‹¹:</strong> <span className="text-blue-600">{record.glucose} mg/dL</span></p>
                                <p><strong>ìŒì‹:</strong> {record.food} ({record.amount || 0}g)</p>
                              </div>
                              <div>
                                <p><strong>íƒ„ìˆ˜í™”ë¬¼:</strong> <span className="text-green-600">{record.carbs || 0}g</span></p>
                                <p><strong>ì¸ìŠë¦°:</strong> {record.insulin || 0} ë‹¨ìœ„</p>
                              </div>
                            </div>
                            <p className="text-sm text-gray-500 mt-2">
                              {new Date(record.timestamp).toLocaleString('ko-KR', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                              })}
                            </p>
                          </div>
                          <div className="flex gap-2 ml-4">
                            <button 
                              onClick={() => startEdit(record)} 
                              className="text-blue-600 hover:text-blue-800 px-3 py-1 rounded hover:bg-blue-50 transition-colors"
                            >
                              ìˆ˜ì •
                            </button>
                            <button 
                              onClick={() => handleDelete(record.id)} 
                              className="text-red-600 hover:text-red-800 px-3 py-1 rounded hover:bg-red-50 transition-colors"
                            >
                              ì‚­ì œ
                            </button>
                          </div>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    // ì—ëŸ¬ ê²½ê³„ ì²˜ë¦¬
    class ErrorBoundary extends React.Component {
      constructor(props) {
        super(props);
        this.state = { hasError: false, error: null };
      }

      static getDerivedStateFromError(error) {
        return { hasError: true, error };
      }

      componentDidCatch(error, errorInfo) {
        console.error('React Error:', error, errorInfo);
      }

      render() {
        if (this.state.hasError) {
          return (
            <div className="max-w-2xl mx-auto py-10 px-4 text-center">
              <h1 className="text-2xl font-bold text-red-600 mb-4">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</h1>
              <p className="text-gray-600 mb-4">í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ ì£¼ì„¸ìš”.</p>
              <button 
                onClick={() => window.location.reload()} 
                className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
              >
                ìƒˆë¡œê³ ì¹¨
              </button>
            </div>
          );
        }

        return this.props.children;
      }
    }

    // ì•± ë Œë”ë§
    try {
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(
        <ErrorBoundary>
          <App />
        </ErrorBoundary>
      );
    } catch (error) {
      console.error('ì•± ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
      document.getElementById('root').innerHTML = `
        <div style="text-align: center; padding: 50px;">
          <h1 style="color: red;">ì•± ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</h1>
          <p>í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ ì£¼ì„¸ìš”.</p>
          <button onclick="window.location.reload()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px;">
            ìƒˆë¡œê³ ì¹¨
          </button>
        </div>
      `;
    }
  </script>
</body>
</html>
