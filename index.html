<h3 style="color: #059669; margin-bottom: 0.5rem;">ğŸ‘¨â€âš•ï¸ ë‹´ë‹¹ ì˜ì‚¬</h3>
              <p style="font-size: 1rem;">${user.medicalInfo?.doctorContact || 'ì„¤ì •ì—ì„œ ë“±ë¡í•˜ì„¸ìš”'}</p>
            </div>
            <div style="text-align: center; padding: 1rem; background: #fefce8; border: 1px solid #fde68a; border-radius: 0.75rem;">
              <h3 style="color: #d97706; margin-bottom: 0.5rem;">ğŸ‘ª ë³´í˜¸ì</h3>
              <p style="font-size: 1rem;">${user.medicalInfo?.emergencyContact || 'ì„¤ì •ì—ì„œ ë“±ë¡í•˜ì„¸ìš”'}</p>
            </div>
          </div>
          
          <div style="margin-top: 2rem; padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 0.75rem;">
            <h4 style="margin-bottom: 0.5rem; color: #1d4ed8;">ğŸ“‹ ì¤‘ìš” ì•ˆë‚´ì‚¬í•­</h4>
            <ul style="margin-left: 1rem; line-height: 1.8; color: #6b7280;">
              <li>ì˜ì‹ì„ ìƒì€ ê²½ìš° ì ˆëŒ€ ìŒì‹ë¬¼ì„ ì…ì— ë„£ì§€ ë§ˆì„¸ìš”</li>
              <li>ê¸€ë£¨ì¹´ê³¤ ì£¼ì‚¬ê°€ ìˆë‹¤ë©´ ì¦‰ì‹œ íˆ¬ì—¬í•˜ê³  119ì— ì‹ ê³ í•˜ì„¸ìš”</li>
              <li>í˜¼ì ìˆì„ ë•ŒëŠ” ì£¼ë³€ì— ë¯¸ë¦¬ ì•Œë ¤ë‘ì„¸ìš”</li>
              <li>ì •ê¸°ì ì¸ í˜ˆë‹¹ ì¸¡ì •ìœ¼ë¡œ ì‘ê¸‰ìƒí™©ì„ ì˜ˆë°©í•˜ì„¸ìš”</li>
            </ul>
          </div>
        </div>
      `;
    }

    function renderAnalysis(container, user) {
      const data = user.personalizedData;
      
      container.innerHTML = `
        <div class="card full-width">
          <h2>ğŸ“ˆ ê°œì¸ í˜ˆë‹¹ íŒ¨í„´ ë¶„ì„</h2>
          
          ${user.records.length < 10 ? `
            <div style="text-align: center; padding: 2rem; background: #f8fafc; border-radius: 1rem; margin-bottom: 2rem;">
              <h3 style="color: #6b7280; margin-bottom: 1rem;">ğŸ“Š ë” ì •í™•í•œ ë¶„ì„ì„ ìœ„í•´</h3>
              <p style="color: #6b7280;">í˜„ì¬ ${user.records.length}ê°œì˜ ê¸°ë¡ì´ ìˆìŠµë‹ˆë‹¤. 10ê°œ ì´ìƒì˜ ê¸°ë¡ì´ ìˆì–´ì•¼ ë” ì •í™•í•œ íŒ¨í„´ ë¶„ì„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
              <div style="margin-top: 1rem;">
                <button onclick="switchTab('record')" class="btn btn-primary">ì²« ê¸°ë¡ ì¶”ê°€í•˜ê¸°</button>
              </div>
            </div>
          ` : ''}
          
          <div class="main-grid">
            <div class="card">
              <h3>ğŸ¯ í˜ˆë‹¹ ë²”ìœ„ ë¶„ì„</h3>
              ${analyzeGlucoseRanges(user.records)}
            </div>
            
            <div class="card">
              <h3>ğŸ“Š ì›”ê°„ íŠ¸ë Œë“œ</h3>
              ${analyzeMonthlyTrend(user.records)}
            </div>
          </div>
          
          <div class="main-grid">
            <div class="card">
              <h3>ğŸ’‰ ì¸ìŠë¦° íš¨ìœ¨ì„± ë¶„ì„</h3>
              ${analyzeInsulinEfficiency(user.records)}
            </div>
            
            <div class="card">
              <h3>ğŸ† ëª©í‘œ ë‹¬ì„±ë¥ </h3>
              ${analyzeGoalAchievement(user.personalizedData)}
            </div>
          </div>
        </div>
      `;
    }

    function analyzeGlucoseRanges(records) {
      if (records.length === 0) return '<p style="color: #6b7280;">ë¶„ì„í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      
      const ranges = {
        low: records.filter(r => parseFloat(r.glucose) < 70).length,
        normal: records.filter(r => parseFloat(r.glucose) >= 80 && parseFloat(r.glucose) <= 180).length,
        high: records.filter(r => parseFloat(r.glucose) > 180).length,
        severe: records.filter(r => parseFloat(r.glucose) > 250).length
      };
      
      const total = records.length;
      
      return `
        <div>
          <div class="pattern-item">
            <div style="display: flex; justify-content: space-between;">
              <span>ğŸ”´ ì €í˜ˆë‹¹ (&lt;70mg/dL)</span>
              <strong style="color: #ef4444;">${ranges.low}íšŒ (${Math.round(ranges.low/total*100)}%)</strong>
            </div>
          </div>
          <div class="pattern-item">
            <div style="display: flex; justify-content: space-between;">
              <span>ğŸŸ¢ ëª©í‘œë²”ìœ„ (80-180mg/dL)</span>
              <strong style="color: #10b981;">${ranges.normal}íšŒ (${Math.round(ranges.normal/total*100)}%)</strong>
            </div>
          </div>
          <div class="pattern-item">
            <div style="display: flex; justify-content: space-between;">
              <span>ğŸŸ¡ ê³ í˜ˆë‹¹ (&gt;180mg/dL)</span>
              <strong style="color: #f59e0b;">${ranges.high}íšŒ (${Math.round(ranges.high/total*100)}%)</strong>
            </div>
          </div>
          <div class="pattern-item">
            <div style="display: flex; justify-content: space-between;">
              <span>ğŸ”´ ì‹¬ê°í•œ ê³ í˜ˆë‹¹ (&gt;250mg/dL)</span>
              <strong style="color: #ef4444;">${ranges.severe}íšŒ (${Math.round(ranges.severe/total*100)}%)</strong>
            </div>
          </div>
        </div>
      `;
    }

    function analyzeMonthlyTrend(records) {
      if (records.length === 0) return '<p style="color: #6b7280;">ë¶„ì„í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      
      const now = new Date();
      const thisMonth = records.filter(r => {
        const recordDate = new Date(r.timestamp);
        return recordDate.getMonth() === now.getMonth() && recordDate.getFullYear() === now.getFullYear();
      });
      
      const lastMonth = records.filter(r => {
        const recordDate = new Date(r.timestamp);
        const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1);
        return recordDate.getMonth() === lastMonthDate.getMonth() && recordDate.getFullYear() === lastMonthDate.getFullYear();
      });
      
      const thisMonthAvg = thisMonth.length > 0 ? 
        Math.round(thisMonth.reduce((sum, r) => sum + parseFloat(r.glucose), 0) / thisMonth.length) : 0;
      const lastMonthAvg = lastMonth.length > 0 ? 
        Math.round(lastMonth.reduce((sum, r) => sum + parseFloat(r.glucose), 0) / lastMonth.length) : 0;
      
      const trend = thisMonthAvg - lastMonthAvg;
      
      return `
        <div>
          <div class="pattern-item">
            <div style="display: flex; justify-content: space-between;">
              <span>ì´ë²ˆ ë‹¬ í‰ê· </span>
              <strong>${thisMonthAvg}mg/dL (${thisMonth.length}íšŒ)</strong>
            </div>
          </div>
          ${lastMonth.length > 0 ? `
          <div class="pattern-item">
            <div style="display: flex; justify-content: space-between;">
              <span>ì§€ë‚œ ë‹¬ í‰ê· </span>
              <strong>${lastMonthAvg}mg/dL (${lastMonth.length}íšŒ)</strong>
            </div>
          </div>
          <div class="pattern-item">
            <div style="display: flex; justify-content: space-between;">
              <span>ë³€í™”ëŸ‰</span>
              <strong style="color: ${trend > 0 ? '#f59e0b' : trend < 0 ? '#10b981' : '#6b7280'};">
                ${trend > 0 ? '+' : ''}${trend}mg/dL ${trend > 0 ? 'ğŸ“ˆ' : trend < 0 ? 'ğŸ“‰' : 'â¡ï¸'}
              </strong>
            </div>
          </div>
          ` : '<div class="pattern-item">ì§€ë‚œ ë‹¬ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.</div>'}
        </div>
      `;
    }

    function analyzeInsulinEfficiency(records) {
      const recordsWithInsulin = records.filter(r => r.insulin > 0 && r.carbs > 0);
      
      if (recordsWithInsulin.length < 5) {
        return '<p style="color: #6b7280;">ì¸ìŠë¦° íš¨ìœ¨ì„± ë¶„ì„ì„ ìœ„í•´ ë” ë§ì€ ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.</p>';
      }
      
      const avgICR = recordsWithInsulin.reduce((sum, r) => sum + (r.carbs / r.insulin), 0) / recordsWithInsulin.length;
      const consistency = recordsWithInsulin.map(r => r.carbs / r.insulin);
      const stdDev = Math.sqrt(consistency.reduce((sum, val) => sum + Math.pow(val - avgICR, 2), 0) / consistency.length);
      
      return `
        <div>
          <div class="pattern-item">
            <div style="display: flex; justify-content: space-between;">
              <span>ê°œì¸ ICR (í‰ê· )</span>
              <strong>${Math.round(avgICR * 10) / 10}g/ë‹¨ìœ„</strong>
            </div>
          </div>
          <div class="pattern-item">
            <div style="display: flex; justify-content: space-between;">
              <span>ì¼ê´€ì„± ì ìˆ˜</span>
              <strong style="color: ${stdDev < 3 ? '#10b981' : stdDev < 5 ? '#f59e0b' : '#ef4444'};">
                ${stdDev < 3 ? 'ìš°ìˆ˜' : stdDev < 5 ? 'ë³´í†µ' : 'ê°œì„ í•„ìš”'}
              </strong>
            </div>
          </div>
          <div class="pattern-item">
            <div style="display: flex; justify-content: space-between;">
              <span>ë¶„ì„ ë°ì´í„° ìˆ˜</span>
              <strong>${recordsWithInsulin.length}ê°œ ê¸°ë¡</strong>
            </div>
          </div>
        </div>
      `;
    }

    function analyzeGoalAchievement(personalizedData) {
      const tir = personalizedData.timeInRange || 0;
      const avgGlucose = personalizedData.avgGlucose || 0;
      
      return `
        <div>
          <div class="pattern-item">
            <div style="display: flex; justify-content: space-between;">
              <span>TIR ëª©í‘œ (70% ì´ìƒ)</span>
              <strong style="color: ${tir >= 70 ? '#10b981' : tir >= 50 ? '#f59e0b' : '#ef4444'};">
                ${tir}% ${tir >= 70 ? 'âœ…' : tir >= 50 ? 'âš ï¸' : 'âŒ'}
              </strong>
            </div>
          </div>
          <div class="pattern-item">
            <div style="display: flex; justify-content: space-between;">
              <span>í‰ê·  í˜ˆë‹¹ ëª©í‘œ (80-180mg/dL)</span>
              <strong style="color: ${avgGlucose >= 80 && avgGlucose <= 180 ? '#10b981' : '#f59e0b'};">
                ${avgGlucose}mg/dL ${avgGlucose >= 80 && avgGlucose <= 180 ? 'âœ…' : 'âš ï¸'}
              </strong>
            </div>
          </div>
          <div class="pattern-item">
            <div style="display: flex; justify-content: space-between;">
              <span>ì „ë°˜ì  ê´€ë¦¬ ìƒíƒœ</span>
              <strong style="color: ${tir >= 70 && avgGlucose >= 80 && avgGlucose <= 180 ? '#10b981' : '#f59e0b'};">
                ${tir >= 70 && avgGlucose >= 80 && avgGlucose <= 180 ? 'ìš°ìˆ˜ ğŸ†' : 'ê°œì„  ì¤‘ ğŸ“ˆ'}
              </strong>
            </div>
          </div>
        </div>
      `;
    }

    function renderFoodPatterns(container, user) {
      const foodReactions = user.personalizedData.foodReactions;
      
      container.innerHTML = `
        <div class="card full-width">
          <h2>ğŸ½ï¸ ê°œì¸ë³„ ìŒì‹ ë°˜ì‘ íŒ¨í„´</h2>
          ${Object.keys(foodReactions).length === 0 ? 
            '<p style="color: #6b7280; text-align: center; padding: 2rem;">ì•„ì§ ì¶©ë¶„í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë” ë§ì€ ê¸°ë¡ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.</p>' :
            `<div style="margin-bottom: 1rem;">
              <p style="color: #6b7280;">ì´ ${Object.keys(foodReactions).length}ì¢…ë¥˜ì˜ ìŒì‹ ë°ì´í„°ê°€ ë¶„ì„ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            </div>
            
            <div style="margin-bottom: 2rem;">
              <h3>âš ï¸ ì£¼ì˜ ìŒì‹ (ê³ í˜ˆë‹¹ ìœ„í—˜)</h3>
              ${Object.entries(foodReactions)
                .filter(([food, reaction]) => reaction.riskLevel === 'high')
                .sort((a, b) => b[1].avgGlucose - a[1].avgGlucose)
                .slice(0, 3)
                .map(([food, reaction]) => `
                  <div class="pattern-item" style="border-left: 4px solid #ef4444;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                      <h4>${food}</h4>
                      <div class="trend-indicator trend-danger"></div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem; margin-bottom: 0.5rem;">
                      <div><strong>${reaction.count}íšŒ</strong><br><small>ì„­ì·¨</small></div>
                      <div><strong>${reaction.avgGlucose}mg/dL</strong><br><small>í‰ê·  í˜ˆë‹¹</small></div>
                      <div><strong>${reaction.avgInsulin}ë‹¨ìœ„</strong><br><small>í‰ê·  ì¸ìŠë¦°</small></div>
                      <div><strong>${reaction.avgCarbs}g</strong><br><small>í‰ê·  íƒ„ìˆ˜í™”ë¬¼</small></div>
                    </div>
                    <div style="font-size: 0.875rem; color: #dc2626;">
                      âš ï¸ ì´ ìŒì‹ì€ í˜ˆë‹¹ì„ í¬ê²Œ ìƒìŠ¹ì‹œí‚µë‹ˆë‹¤. ì¸ìŠë¦° ìš©ëŸ‰ ì¡°ì •ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </div>
                  </div>
                `).join('') || '<p style="color: #10b981;">â­ ê³ ìœ„í—˜ ìŒì‹ì´ ì—†ìŠµë‹ˆë‹¤!</p>'
              }
            </div>
            
            <div style="margin-bottom: 2rem;">
              <h3>âœ… ì•ˆì „ ìŒì‹ (ë‚®ì€ í˜ˆë‹¹ ìƒìŠ¹)</h3>
              ${Object.entries(foodReactions)
                .filter(([food, reaction]) => reaction.riskLevel === 'low')
                .sort((a, b) => a[1].avgGlucose - b[1].avgGlucose)
                .slice(0, 5)
                .map(([food, reaction]) => `
                  <div class="pattern-item" style="border-left: 4px solid #10b981;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                      <h4>${food}</h4>
                      <div class="trend-indicator trend-good"></div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem;">
                      <div><strong>${reaction.count}íšŒ</strong><br><small>ì„­ì·¨</small></div>
                      <div><strong>${reaction.avgGlucose}mg/dL</strong><br><small>í‰ê·  í˜ˆë‹¹</small></div>
                      <div><strong>${reaction.avgInsulin}ë‹¨ìœ„</strong><br><small>í‰ê·  ì¸ìŠë¦°</small></div>
                      <div><strong>${reaction.avgCarbs}g</strong><br><small>í‰ê·  íƒ„ìˆ˜í™”ë¬¼</small></div>
                    </div>
                  </div>
                `).join('') || '<p style="color: #6b7280;">ì•ˆì „í•œ ìŒì‹ íŒ¨í„´ì„ ì°¾ê¸° ìœ„í•´ ë” ë§ì€ ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.</p>'
              }
            </div>
            
            <div>
              <h3>ğŸ“Š ì „ì²´ ìŒì‹ íŒ¨í„´</h3>
              ${Object.entries(foodReactions)
                .sort((a, b) => b[1].count - a[1].count)
                .map(([food, reaction]) => `
                  <div class="pattern-item">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                      <h4>${food}</h4>
                      <div class="trend-indicator ${getTrendClass(reaction.avgGlucose)}"></div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem; margin-bottom: 0.5rem;">
                      <div><strong>${reaction.count}íšŒ</strong><br><small>ì„­ì·¨</small></div>
                      <div><strong>${reaction.avgGlucose}mg/dL</strong><br><small>í‰ê·  í˜ˆë‹¹</small></div>
                      <div><strong>${reaction.avgInsulin}ë‹¨ìœ„</strong><br><small>í‰ê·  ì¸ìŠë¦°</small></div>
                      <div><strong>${reaction.avgCarbs}g</strong><br><small>í‰ê·  íƒ„ìˆ˜í™”ë¬¼</small></div>
                    </div>
                    <div style="font-size: 0.875rem; color: #6b7280;">
                      ${KOREAN_FOOD_DATABASE[food] ? `GI ${KOREAN_FOOD_DATABASE[food].glycemicIndex} â€¢ ${KOREAN_FOOD_DATABASE[food].category} â€¢ ${KOREAN_FOOD_DATABASE[food].source} ë°ì´í„°` : 'ì‚¬ìš©ì ì…ë ¥ ìŒì‹'}
                    </div>
                  </div>
                `).join('')}`
          }
        </div>
      `;
    }

    function renderProfile(container, user) {
      container.innerHTML = `
        <div class="main-grid">
          <div class="card">
            <h2>ğŸ‘¤ í”„ë¡œí•„ ì •ë³´</h2>
            <form id="profileForm">
              <div class="form-grid">
                <div class="form-group">
                  <label for="profileName">ì´ë¦„</label>
                  <input type="text" id="profileName" value="${user.name || ''}" placeholder="ì´ë¦„">
                </div>
                <div class="form-group">
                  <label for="profileAge">ë‚˜ì´</label>
                  <input type="number" id="profileAge" value="${user.age || ''}" placeholder="ë‚˜ì´" min="1" max="120">
                </div>
                <div class="form-group">
                  <label for="profileWeight">ì²´ì¤‘ (kg)</label>
                  <input type="number" id="profileWeight" value="${user.weight || ''}" placeholder="ì²´ì¤‘" step="0.1">
                </div>
                <div class="form-group">
                  <label for="profileHeight">ì‹ ì¥ (cm)</label>
                  <input type="number" id="profileHeight" value="${user.height || ''}" placeholder="ì‹ ì¥">
                </div>
              </div>
              
              <div class="form-group" style="margin: 1rem 0;">
                <label for="diagnosisYear">ì§„ë‹¨ ì—°ë„</label>
                <input type="number" id="diagnosisYear" value="${user.diagnosisYear || ''}" placeholder="YYYY" min="1950" max="2025">
              </div>
              
              <div class="form-group" style="margin: 1rem 0;">
                <label for="emergencyContact">ì‘ê¸‰ ì—°ë½ì²˜</label>
                <input type="tel" id="emergencyContact" value="${user.medicalInfo?.emergencyContact || ''}" placeholder="010-0000-0000">
              </div>
              
              <button type="submit" class="btn btn-success btn-full">
                ğŸ’¾ í”„ë¡œí•„ ì €ì¥
              </button>
            </form>
            
            <div style="margin-top: 1.5rem; padding: 1rem; background: #f8fafc; border-radius: 0.5rem;">
              <h4 style="margin-bottom: 0.5rem;">ğŸ“Š ê³„ì • ì •ë³´</h4>
              <p><strong>ê°€ì…ì¼:</strong> ${formatDate(user.createdAt).split(' ')[0]}</p>
              <p><strong>ë§ˆì§€ë§‰ ë¡œê·¸ì¸:</strong> ${formatDate(user.lastLogin)}</p>
              <p><strong>ì‚¬ìš©ìëª…:</strong> ${user.username}</p>
            </div>
          </div>
          
          <div class="card">
            <h2>ğŸ“Š ë°ì´í„° ê´€ë¦¬</h2>
            <div style="margin-bottom: 1rem;">
              <button onclick="exportUserData()" class="btn btn-primary btn-full" style="margin-bottom: 0.5rem;">
                ğŸ“¤ ë‚´ ë°ì´í„° ë‚´ë³´ë‚´ê¸°
              </button>
              
              <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importUserData(event)">
              <button onclick="document.getElementById('importFile').click()" class="btn btn-primary btn-full" style="margin-bottom: 0.5rem;">
                ğŸ“¥ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
              </button>
              
              <button onclick="resetAllData()" class="btn btn-danger btn-full">
                ğŸ—‘ï¸ ëª¨ë“  ë°ì´í„° ì‚­ì œ
              </button>
            </div>
            
            <div style="padding: 1rem; background: #fef2f2; border: 1px solid #fecaca; border-radius: 0.5rem;">
              <h4 style="margin-bottom: 0.5rem; color: #dc2626;">âš ï¸ ì£¼ì˜ì‚¬í•­</h4>
              <ul style="font-size: 0.875rem; color: #6b7280; line-height: 1.6; margin-left: 1rem;">
                <li>ë°ì´í„° ì‚­ì œëŠ” ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</li>
                <li>ì¤‘ìš”í•œ ë°ì´í„°ëŠ” ë¯¸ë¦¬ ë‚´ë³´ë‚´ê¸° í•˜ì„¸ìš”</li>
                <li>ì˜ë£Œ ë°ì´í„°ëŠ” ì•”í˜¸í™”ë˜ì–´ ì €ì¥ë©ë‹ˆë‹¤</li>
              </ul>
            </div>
          </div>
        </div>
        
        <div class="card full-width">
          <h2>ğŸ¯ ê°œì¸í™” ì„¤ì •</h2>
          <div class="form-grid">
            <div class="form-group">
              <label for="targetMin">ëª©í‘œ í˜ˆë‹¹ ìµœì†Œê°’ (mg/dL)</label>
              <input type="number" id="targetMin" value="${user.preferences?.targetGlucose?.min || 80}" min="50" max="150">
            </div>
            <div class="form-group">
              <label for="targetMax">ëª©í‘œ í˜ˆë‹¹ ìµœëŒ€ê°’ (mg/dL)</label>
              <input type="number" id="targetMax" value="${user.preferences?.targetGlucose?.max || 180}" min="100" max="300">
            </div>
            <div class="form-group">
              <label for="targetA1C">ëª©í‘œ ë‹¹í™”í˜ˆìƒ‰ì†Œ (%)</label>
              <input type="number" id="targetA1C" value="${user.preferences?.targetA1C || 7.0}" step="0.1" min="5.0" max="10.0">
            </div>
            <div class="form-group">
              <label for="insulinType">ì‚¬ìš©í•˜ëŠ” ì¸ìŠë¦° ì¢…ë¥˜</label>
              <select id="insulinType">
                <option value="rapid" ${user.preferences?.insulinType === 'rapid' ? 'selected' : ''}>ì´ˆì†íš¨ì„± (íœ´ë§ˆë¡œê·¸, ë…¸ë³´ë˜í”¼ë“œ)</option>
                <option value="short" ${user.preferences?.insulinType === 'short' ? 'selected' : ''}>ì†íš¨ì„± (íœ´ë¬¼ë¦°R)</option>
                <option value="mixed" ${user.preferences?.insulinType === 'mixed' ? 'selected' : ''}>í˜¼í•©í˜•</option>
              </select>
            </div>
          </div>
          
          <button onclick="savePreferences()" class="btn btn-ai btn-full" style="margin-top: 1rem;">
            âš™ï¸ ì„¤ì • ì €ì¥
          </button>
        </div>
      `;

      setupProfileEventListeners();
    }

    function setupProfileEventListeners() {
      const form = document.getElementById('profileForm');
      if (form) {
        form.addEventListener('submit', (e) => {
          e.preventDefault();
          
          const formData = new FormData(form);
          const profileData = {
            name: formData.get('name') || document.getElementById('profileName').value,
            age: document.getElementById('profileAge').value,
            weight: document.getElementById('profileWeight').value,
            height: document.getElementById('profileHeight').value,
            diagnosisYear: document.getElementById('diagnosisYear').value,
            medicalInfo: {
              ...userManager.currentUser.medicalInfo,
              emergencyContact: document.getElementById('emergencyContact').value
            },
            updated: new Date().toISOString()
          };
          
          userManager.updateUserData(profileData);
          alert('í”„ë¡œí•„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        });
      }
    }

    // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë“¤
    function handleLogin() {
      const username = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;
      
      if (!username || !password) {
        alert('ì‚¬ìš©ìëª…ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      const user = userManager.login(username, password);
      if (user) {
        renderMainApp();
      } else {
        alert('ì‚¬ìš©ìëª… ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      }
    }

    function handleRegister() {
      const username = document.getElementById('regUsername').value;
      const password = document.getElementById('regPassword').value;
      const name = document.getElementById('regName').value;
      const age = document.getElementById('regAge').value;
      const weight = document.getElementById('regWeight').value;
      const height = document.getElementById('regHeight').value;
      const diagnosisYear = document.getElementById('regDiagnosis').value;
      const emergencyContact = document.getElementById('emergencyContact').value;
      
      if (!username || !password || !name) {
        alert('í•„ìˆ˜ í•­ëª©(ì‚¬ìš©ìëª…, ë¹„ë°€ë²ˆí˜¸, ì´ë¦„)ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // ì¤‘ë³µ ì‚¬ìš©ìëª… ì²´í¬
      const existingUser = Object.values(userManager.users).find(u => u.username === username);
      if (existingUser) {
        alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì‚¬ìš©ìëª…ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ì‚¬ìš©ìëª…ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      const userData = {
        username: username,
        password: password,
        name: name,
        age: age,
        weight: weight,
        height: height,
        diagnosisYear: diagnosisYear,
        emergencyContact: emergencyContact
      };
      
      const user = userManager.register(userData);
      userManager.currentUser = user;
      alert(`í™˜ì˜í•©ë‹ˆë‹¤, ${name}ë‹˜! íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
      renderMainApp();
    }

    function handleRecordSubmit() {
      const glucose = document.getElementById('glucose').value;
      const food = document.getElementById('food').value;
      const amount = document.getElementById('amount').value || 0;
      const insulin = document.getElementById('insulin').value || 0;
      const timing = document.getElementById('timing').value;
      const postMealGlucose = document.getElementById('postMealGlucose').value;
      const notes = document.getElementById('notes').value;
      
      if (!glucose || !food) {
        alert('í˜ˆë‹¹ê³¼ ìŒì‹ ì´ë¦„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
        return;
      }

      const record = {
        id: Date.now() + Math.random(),
        glucose: glucose,
        food: food,
        amount: amount,
        insulin: insulin,
        carbs: calculateCarbs(food, amount),
        timing: timing,
        postMealGlucose: postMealGlucose,
        notes: notes,
        timestamp: new Date().toISOString()
      };

      userManager.addRecord(record);
      
      // AI ê°œì¸í™” ì¶”ì²œ í‘œì‹œ
      aiEngine.generatePersonalizedRecommendations(record, userManager.currentUser.personalizedData)
        .then(recommendations => {
          if (recommendations && recommendations.length > 0) {
            const aiDiv = document.getElementById('aiRecommendations');
            aiDiv.innerHTML = `
              <div class="ai-recommendations">
                <h3 style="margin-bottom: 1rem;">ğŸ¤– AI ê°œì¸í™” ë¶„ì„ ê²°ê³¼</h3>
                ${recommendations.map(rec => `
                  <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(255, 255, 255, 0.8); border-radius: 0.5rem; border-left: 4px solid ${rec.type === 'emergency' ? '#ef4444' : rec.type === 'warning' ? '#f59e0b' : '#3b82f6'};">
                    <h4 style="margin-bottom: 0.5rem;">${rec.title}</h4>
                    <p style="margin-bottom: 0.5rem;">${rec.message}</p>
                    ${rec.priority === 'critical' ? '<p style="color: #dc2626; font-weight: 600;">âš ï¸ ì¦‰ì‹œ ì¡°ì¹˜ í•„ìš”</p>' : ''}
                  </div>
                `).join('')}
                <div style="margin-top: 1rem; padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 0.5rem;">
                  <p style="font-size: 0.875rem; color: #6b7280;">
                    ğŸ’¡ ì´ ë¶„ì„ì€ ${userManager.currentUser.records.length}ê°œì˜ ê°œì¸ ê¸°ë¡ì„ ë°”íƒ•ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
                  </p>
                </div>
              </div>
            `;
          }
        });
      
      // í¼ ì´ˆê¸°í™”
      document.getElementById('glucose').value = '';
      document.getElementById('food').value = '';
      document.getElementById('amount').value = '';
      document.getElementById('insulin').value = '';
      document.getElementById('postMealGlucose').value = '';
      document.getElementById('notes').value = '';
      updatePersonalizedPreview();
      
      alert('ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
      
      // ëŒ€ì‹œë³´ë“œë¡œ ì´ë™
      setTimeout(() => {
        currentTab = 'dashboard';
        renderMainApp();
      }, 3000);
    }

    function switchTab(tabName) {
      currentTab = tabName;
      renderMainApp();
    }

    function showRegisterForm() {
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('registerForm').classList.remove('hidden');
    }

    function showLoginForm() {
      document.getElementById('registerForm').classList.add('hidden');
      document.getElementById('loginForm').classList.remove('hidden');
    }

    function logout() {
      if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        userManager.currentUser = null;
        currentTab = 'dashboard';
        renderAuthScreen();
      }
    }

    function deleteRecord(recordId) {
      if (confirm('ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        userManager.deleteRecord(recordId);
        renderMainApp();
      }
    }

    function selectFood(foodName) {
      const foodInput = document.getElementById('food');
      if (foodInput) {
        foodInput.value = foodName;
        hideFoodSuggestions();
        updatePersonalizedPreview();
      }
    }

    function selectCalculatorFood(foodName) {
      const foodInput = document.getElementById('calcFood');
      if (foodInput) {
        foodInput.value = foodName;
        hideCalculatorFoodSuggestions();
        updateCalculatorPreview();
      }
    }

    function callEmergency() {
      if (confirm('119 ì‘ê¸‰ì‹¤ì— ì—°ê²°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        window.open('tel:119');
      }
    }

    function exportUserData() {
      const user = userManager.getCurrentUser();
      if (!user) return;
      
      const data = {
        user: user,
        exportDate: new Date().toISOString(),
        version: '2.0',
        app: 'DiaLife Pro'
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `dialife-${user.name}-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function importUserData(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          
          if (data.user && data.user.id) {
            if (confirm('ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ë©´ í˜„ì¬ ì‚¬ìš©ì ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
              userManager.users[data.user.id] = data.user;
              userManager.currentUser = data.user;
              userManager.saveUsers();
              alert('ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤!');
              renderMainApp();
            }
          } else {
            alert('ì˜¬ë°”ë¥´ì§€ ì•Šì€ ë°ì´í„° íŒŒì¼ì…ë‹ˆë‹¤.');
          }
        } catch (error) {
          alert('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      };
      reader.readAsText(file);
    }

    function resetAllData() {
      if (confirm('ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        if (confirm('ë§ˆì§€ë§‰ í™•ì¸: ëª¨ë“  ì‚¬ìš©ì ë°ì´í„°ì™€ ê¸°ë¡ì´ ì˜êµ¬ ì‚­ì œë©ë‹ˆë‹¤.')) {
          localStorage.clear();
          alert('ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          location.reload();
        }
      }
    }

    function savePreferences() {
      const user = userManager.getCurrentUser();
      if (!user) return;

      const preferences = {
        targetGlucose: {
          min: parseInt(document.getElementById('targetMin').value) || 80,
          max: parseInt(document.getElementById('targetMax').value) || 180
        },
        targetA1C: parseFloat(document.getElementById('targetA1C').value) || 7.0,
        insulinType: document.getElementById('insulinType').value || 'rapid'
      };

      user.preferences = { ...user.preferences, ...preferences };
      userManager.updateUserData({ preferences: user.preferences });
      alert('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }

    // ì•± ì‹œì‘
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(initApp, 1000); // ë¡œë”© íš¨ê³¼ë¥¼ ìœ„í•œ ì§€ì—°
    });

    // ì „ì—­ í•¨ìˆ˜ ë“±ë¡ (ë¸Œë¼ìš°ì € í˜¸í™˜ì„±ì„ ìœ„í•´)
    window.handleLogin = handleLogin;
    window.handleRegister = handleRegister;
    window.handleRecordSubmit = handleRecordSubmit;
    window.calculateInsulin = calculateInsulin;
    window.saveCalculation = saveCalculation;
    window.switchTab = switchTab;
    window.showRegisterForm = showRegisterForm;
    window.showLoginForm = showLoginForm;
    window.logout = logout;
    window.deleteRecord = deleteRecord;
    window.selectFood = selectFood;
    window.selectCalculatorFood = selectCalculatorFood;
    window.callEmergency = callEmergency;
    window.exportUserData = exportUserData;
    window.importUserData = importUserData;
    window.resetAllData = resetAllData;
    window.savePreferences = savePreferences;
  </script>
</body>
</html>
