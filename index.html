<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DiaLife Pro - ê°œì¸í™” 1í˜•ë‹¹ë‡¨ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
      line-height: 1.6;
      color: #333;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .auth-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 1rem;
    }

    .auth-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 2rem;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
      padding: 3rem;
      width: 100%;
      max-width: 500px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      text-align: center;
    }

    .auth-header {
      margin-bottom: 2rem;
    }

    .auth-header h1 {
      font-size: 2.5rem;
      font-weight: bold;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.5rem;
    }

    .auth-header p {
      color: #6b7280;
      font-size: 1.1rem;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1rem;
    }

    .header {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 1rem;
      padding: 1.5rem;
      margin-bottom: 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
    }

    .header-left h1 {
      font-size: 2rem;
      font-weight: bold;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      margin-bottom: 0.25rem;
    }

    .header-left .welcome {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .user-info {
      text-align: right;
    }

    .user-info .user-name {
      font-weight: 600;
      font-size: 1.1rem;
    }

    .user-info .user-stats {
      font-size: 0.9rem;
      opacity: 0.8;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 1rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .card h2 {
      font-size: 1.4rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: #1f2937;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-size: 0.875rem;
      font-weight: 500;
      color: #374151;
      margin-bottom: 0.25rem;
    }

    .form-group input, 
    .form-group select,
    .form-group textarea {
      padding: 0.75rem;
      border: 2px solid #e5e7eb;
      border-radius: 0.5rem;
      font-size: 1rem;
      transition: all 0.2s;
      background: white;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    .btn-success {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
    }

    .btn-ai {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      color: white;
    }

    .btn-logout {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
    }

    .btn-full {
      width: 100%;
      justify-content: center;
    }

    .btn-small {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }

    .personalized-insights {
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      border: 2px solid #0284c7;
      border-radius: 1rem;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }

    .insight-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }

    .insight-card {
      background: rgba(255, 255, 255, 0.8);
      padding: 1rem;
      border-radius: 0.75rem;
      border-left: 4px solid #0284c7;
    }

    .insight-title {
      font-weight: 600;
      color: #0c4a6e;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .stats-dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: linear-gradient(135deg, #f8fafc, #e2e8f0);
      padding: 1.5rem;
      border-radius: 1rem;
      text-align: center;
      border: 1px solid #e2e8f0;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
    }

    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: #1f2937;
      margin-bottom: 0.25rem;
    }

    .stat-label {
      font-size: 0.875rem;
      color: #6b7280;
    }

    .pattern-item {
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid #e5e7eb;
      border-radius: 0.75rem;
      padding: 1rem;
      margin-bottom: 1rem;
      transition: all 0.2s;
    }

    .pattern-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .glucose-trend {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .trend-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    .trend-good {
      background: #10b981;
    }

    .trend-warning {
      background: #f59e0b;
    }

    .trend-danger {
      background: #ef4444;
    }

    .tab-container {
      margin-bottom: 2rem;
    }

    .tab-buttons {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      border-radius: 1rem;
      padding: 0.5rem;
    }

    .tab-button {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.75rem;
      background: transparent;
      color: white;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
    }

    .tab-button.active {
      background: rgba(255, 255, 255, 0.95);
      color: #1f2937;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .full-width {
      grid-column: 1 / -1;
    }

    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      padding: 2rem;
      color: #6b7280;
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #e5e7eb;
      border-top: 2px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .preview-box {
      background: linear-gradient(135deg, #eff6ff, #dbeafe);
      border: 2px solid #3b82f6;
      border-radius: 1rem;
      padding: 1rem;
      margin-top: 1rem;
    }

    .personal-analysis {
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      border: 2px solid #0284c7;
      border-radius: 1rem;
      padding: 1rem;
      margin-top: 1rem;
    }

    .ai-recommendations {
      background: linear-gradient(135deg, #f3e8ff, #e9d5ff);
      border: 2px solid #8b5cf6;
      border-radius: 1rem;
      padding: 1.5rem;
      margin-top: 1rem;
    }

    .hidden {
      display: none;
    }

    @media (max-width: 1024px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
      
      .header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 0.5rem;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .insight-grid {
        grid-template-columns: 1fr;
      }
      
      .stats-dashboard {
        grid-template-columns: repeat(2, 1fr);
      }

      .tab-buttons {
        flex-wrap: wrap;
      }

      .tab-button {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="loading">
      <div class="spinner"></div>
      ì‹œìŠ¤í…œì„ ì´ˆê¸°í™”í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...
    </div>
  </div>

  <script>
    // í•œêµ­ ì‹í’ˆ ë°ì´í„°ë² ì´ìŠ¤
    const KOREAN_FOOD_DATABASE = {
      // ì£¼ì‹ë¥˜
      'ë°±ë¯¸ë°¥': { carbs: 23, protein: 2.5, fat: 0.3, category: 'ì£¼ì‹', serving: 100, glycemicIndex: 73 },
      'í˜„ë¯¸ë°¥': { carbs: 22, protein: 2.8, fat: 0.9, category: 'ì£¼ì‹', serving: 100, glycemicIndex: 56 },
      'ë³´ë¦¬ë°¥': { carbs: 21, protein: 3.2, fat: 0.7, category: 'ì£¼ì‹', serving: 100, glycemicIndex: 25 },
      'ê¹€ë°¥': { carbs: 35, protein: 6, fat: 4, category: 'ì£¼ì‹', serving: 100, glycemicIndex: 65 },
      'ë¼ë©´': { carbs: 55, protein: 9, fat: 16, category: 'ë©´ë¥˜', serving: 100, glycemicIndex: 73 },
      'ëƒ‰ë©´': { carbs: 19, protein: 4, fat: 0.5, category: 'ë©´ë¥˜', serving: 100, glycemicIndex: 40 },
      'ìš°ë™': { carbs: 21, protein: 3, fat: 0.4, category: 'ë©´ë¥˜', serving: 100, glycemicIndex: 55 },
      'ì‹ë¹µ': { carbs: 47, protein: 8, fat: 4, category: 'ì£¼ì‹', serving: 100, glycemicIndex: 75 },
      'ì°ë¹µ': { carbs: 45, protein: 6, fat: 2, category: 'ì£¼ì‹', serving: 100, glycemicIndex: 65 },
      
      // ê³¼ì¼ë¥˜
      'ì‚¬ê³¼': { carbs: 14, protein: 0.3, fat: 0.2, category: 'ê³¼ì¼', serving: 100, glycemicIndex: 36 },
      'ë°°': { carbs: 11, protein: 0.3, fat: 0.1, category: 'ê³¼ì¼', serving: 100, glycemicIndex: 33 },
      'ë°”ë‚˜ë‚˜': { carbs: 23, protein: 1, fat: 0.2, category: 'ê³¼ì¼', serving: 100, glycemicIndex: 51 },
      'ì˜¤ë Œì§€': { carbs: 12, protein: 0.9, fat: 0.1, category: 'ê³¼ì¼', serving: 100, glycemicIndex: 42 },
      'í¬ë„': { carbs: 16, protein: 0.6, fat: 0.2, category: 'ê³¼ì¼', serving: 100, glycemicIndex: 46 },
      'ìˆ˜ë°•': { carbs: 8, protein: 0.6, fat: 0.2, category: 'ê³¼ì¼', serving: 100, glycemicIndex: 72 },
      'ë”¸ê¸°': { carbs: 8, protein: 0.7, fat: 0.3, category: 'ê³¼ì¼', serving: 100, glycemicIndex: 40 },
      'ê°': { carbs: 16, protein: 0.5, fat: 0.1, category: 'ê³¼ì¼', serving: 100, glycemicIndex: 55 },
      
      // ì±„ì†Œë¥˜
      'ë°°ì¶”ê¹€ì¹˜': { carbs: 3, protein: 1.1, fat: 0.4, category: 'ì±„ì†Œ', serving: 100, glycemicIndex: 15 },
      'ë¬´': { carbs: 2, protein: 0.5, fat: 0.1, category: 'ì±„ì†Œ', serving: 100, glycemicIndex: 10 },
      'ë‹¹ê·¼': { carbs: 8, protein: 0.7, fat: 0.2, category: 'ì±„ì†Œ', serving: 100, glycemicIndex: 47 },
      'ê°ì': { carbs: 17, protein: 2, fat: 0.1, category: 'ì±„ì†Œ', serving: 100, glycemicIndex: 62 },
      'ê³ êµ¬ë§ˆ': { carbs: 20, protein: 1.2, fat: 0.2, category: 'ì±„ì†Œ', serving: 100, glycemicIndex: 48 },
      'ì˜¥ìˆ˜ìˆ˜': { carbs: 19, protein: 3.2, fat: 1.2, category: 'ì±„ì†Œ', serving: 100, glycemicIndex: 52 },
      
      // ë‹¨ë°±ì§ˆë¥˜
      'ë‹­ê°€ìŠ´ì‚´': { carbs: 0, protein: 23, fat: 1.2, category: 'ë‹¨ë°±ì§ˆ', serving: 100, glycemicIndex: 0 },
      'ê³„ë€': { carbs: 0.7, protein: 13, fat: 11, category: 'ë‹¨ë°±ì§ˆ', serving: 100, glycemicIndex: 0 },
      'ë‘ë¶€': { carbs: 2, protein: 8, fat: 4, category: 'ë‹¨ë°±ì§ˆ', serving: 100, glycemicIndex: 15 },
      'ì‚¼ê²¹ì‚´': { carbs: 0, protein: 17, fat: 28, category: 'ë‹¨ë°±ì§ˆ', serving: 100, glycemicIndex: 0 },
      'ê°ˆë¹„': { carbs: 0, protein: 19, fat: 25, category: 'ë‹¨ë°±ì§ˆ', serving: 100, glycemicIndex: 0 },
      'ìƒì„ ': { carbs: 0, protein: 20, fat: 5, category: 'ë‹¨ë°±ì§ˆ', serving: 100, glycemicIndex: 0 },
      
      // ìœ ì œí’ˆë¥˜
      'ìš°ìœ ': { carbs: 5, protein: 3.3, fat: 3.2, category: 'ìœ ì œí’ˆ', serving: 100, glycemicIndex: 39 },
      'ìš”êµ¬ë¥´íŠ¸': { carbs: 7, protein: 3.5, fat: 3, category: 'ìœ ì œí’ˆ', serving: 100, glycemicIndex: 41 },
      'ì¹˜ì¦ˆ': { carbs: 1, protein: 25, fat: 33, category: 'ìœ ì œí’ˆ', serving: 100, glycemicIndex: 0 },
      
      // ê°„ì‹ë¥˜
      'ì´ˆì½œë¦¿': { carbs: 57, protein: 4, fat: 31, category: 'ê°„ì‹', serving: 100, glycemicIndex: 40 },
      'ì¿ í‚¤': { carbs: 67, protein: 6, fat: 24, category: 'ê°„ì‹', serving: 100, glycemicIndex: 77 },
      'ì•„ì´ìŠ¤í¬ë¦¼': { carbs: 24, protein: 3, fat: 11, category: 'ê°„ì‹', serving: 100, glycemicIndex: 51 },
      'ë–¡': { carbs: 44, protein: 4, fat: 0.5, category: 'ê°„ì‹', serving: 100, glycemicIndex: 83 }
    };

    // ì‚¬ìš©ì ê´€ë¦¬ ì‹œìŠ¤í…œ
    class UserManager {
      constructor() {
        this.currentUser = null;
        this.users = this.loadUsers();
      }

      loadUsers() {
        try {
          const stored = localStorage.getItem('dialife_users');
          return stored ? JSON.parse(stored) : {};
        } catch (error) {
          console.warn('ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
          return {};
        }
      }

      saveUsers() {
        try {
          localStorage.setItem('dialife_users', JSON.stringify(this.users));
        } catch (error) {
          console.warn('ì‚¬ìš©ì ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', error);
        }
      }

      register(userData) {
        const userId = this.generateUserId();
        const user = {
          id: userId,
          ...userData,
          createdAt: new Date().toISOString(),
          lastLogin: new Date().toISOString(),
          records: [],
          preferences: {
            targetGlucose: { min: 80, max: 180 },
            reminderTime: '08:00',
            notifications: true
          },
          personalizedData: {
            avgGlucose: 0,
            totalRecords: 0,
            insulinSensitivity: 0,
            foodReactions: {},
            timePatterns: {},
            weeklyGoals: []
          }
        };
        
        this.users[userId] = user;
        this.saveUsers();
        return user;
      }

      login(username, password) {
        const user = Object.values(this.users).find(u => 
          u.username === username && u.password === password
        );
        
        if (user) {
          user.lastLogin = new Date().toISOString();
          this.currentUser = user;
          this.saveUsers();
          return user;
        }
        return null;
      }

      getCurrentUser() {
        return this.currentUser;
      }

      updateUserData(updates) {
        if (this.currentUser) {
          Object.assign(this.currentUser, updates);
          this.users[this.currentUser.id] = this.currentUser;
          this.saveUsers();
        }
      }

      addRecord(record) {
        if (this.currentUser) {
          this.currentUser.records.push(record);
          this.updatePersonalizedData();
          this.saveUsers();
        }
      }

      deleteRecord(recordId) {
        if (this.currentUser) {
          this.currentUser.records = this.currentUser.records.filter(r => r.id !== recordId);
          this.updatePersonalizedData();
          this.saveUsers();
        }
      }

      updatePersonalizedData() {
        if (!this.currentUser) return;

        const records = this.currentUser.records;
        const personalizedData = this.currentUser.personalizedData;

        // ê¸°ë³¸ í†µê³„ ì—…ë°ì´íŠ¸
        personalizedData.totalRecords = records.length;
        
        if (records.length > 0) {
          personalizedData.avgGlucose = Math.round(
            records.reduce((sum, r) => sum + parseFloat(r.glucose || 0), 0) / records.length
          );

          // ìŒì‹ë³„ ë°˜ì‘ íŒ¨í„´ ë¶„ì„
          personalizedData.foodReactions = {};
          records.forEach(record => {
            const food = record.food;
            if (!food) return;
            
            if (!personalizedData.foodReactions[food]) {
              personalizedData.foodReactions[food] = {
                count: 0,
                avgGlucose: 0,
                glucoseValues: [],
                avgInsulin: 0,
                avgCarbs: 0
              };
            }

            const reaction = personalizedData.foodReactions[food];
            reaction.count++;
            reaction.glucoseValues.push(parseFloat(record.glucose || 0));
            reaction.avgGlucose = Math.round(
              reaction.glucoseValues.reduce((a, b) => a + b, 0) / reaction.glucoseValues.length
            );
            reaction.avgInsulin = Math.round((reaction.avgInsulin * (reaction.count - 1) + parseFloat(record.insulin || 0)) / reaction.count * 10) / 10;
            reaction.avgCarbs = Math.round((reaction.avgCarbs * (reaction.count - 1) + parseFloat(record.carbs || 0)) / reaction.count);
          });

          // ì‹œê°„ëŒ€ë³„ íŒ¨í„´ ë¶„ì„
          personalizedData.timePatterns = {};
          records.forEach(record => {
            const hour = new Date(record.timestamp).getHours();
            const timeSlot = this.getTimeSlot(hour);
            
            if (!personalizedData.timePatterns[timeSlot]) {
              personalizedData.timePatterns[timeSlot] = {
                count: 0,
                avgGlucose: 0,
                records: []
              };
            }

            personalizedData.timePatterns[timeSlot].records.push(parseFloat(record.glucose || 0));
            personalizedData.timePatterns[timeSlot].count++;
            personalizedData.timePatterns[timeSlot].avgGlucose = Math.round(
              personalizedData.timePatterns[timeSlot].records.reduce((a, b) => a + b, 0) / 
              personalizedData.timePatterns[timeSlot].records.length
            );
          });

          // ì¸ìŠë¦° ë¯¼ê°ë„ ì¶”ì •
          this.calculateInsulinSensitivity();
        }
      }

      getTimeSlot(hour) {
        if (hour >= 6 && hour < 12) return 'ì•„ì¹¨';
        if (hour >= 12 && hour < 18) return 'ì ì‹¬';
        if (hour >= 18 && hour < 22) return 'ì €ë…';
        return 'ë°¤';
      }

      calculateInsulinSensitivity() {
        const records = this.currentUser.records;
        if (records.length < 5) return;

        // ê°„ë‹¨í•œ ì¸ìŠë¦° ë¯¼ê°ë„ ê³„ì‚°
        const recentRecords = records.slice(-10);
        let totalCarbToInsulin = 0;
        let validRecords = 0;

        recentRecords.forEach(record => {
          const carbs = parseFloat(record.carbs || 0);
          const insulin = parseFloat(record.insulin || 0);
          if (carbs > 0 && insulin > 0) {
            totalCarbToInsulin += carbs / insulin;
            validRecords++;
          }
        });

        if (validRecords > 0) {
          this.currentUser.personalizedData.insulinSensitivity = 
            Math.round((totalCarbToInsulin / validRecords) * 10) / 10;
        }
      }

      generateUserId() {
        return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      }
    }

    // ê°œì¸í™” ë¶„ì„ ì—”ì§„
    class PersonalizationEngine {
      constructor(userManager) {
        this.userManager = userManager;
      }

      getPersonalizedInsights() {
        const user = this.userManager.getCurrentUser();
        if (!user || user.records.length < 3) return [];

        const insights = [];
        const data = user.personalizedData;
        const records = user.records;

        // í˜ˆë‹¹ íŠ¸ë Œë“œ ë¶„ì„
        if (records.length >= 7) {
          const recentRecords = records.slice(-7);
          const avgRecent = recentRecords.reduce((sum, r) => sum + parseFloat(r.glucose || 0), 0) / recentRecords.length;
          const avgOverall = data.avgGlucose;
          
          if (avgRecent > avgOverall + 20) {
            insights.push({
              type: 'warning',
              title: 'âš ï¸ ìµœê·¼ í˜ˆë‹¹ ìƒìŠ¹ ì£¼ì˜',
              description: `ìµœê·¼ 7ì¼ í‰ê·  í˜ˆë‹¹ì´ ${Math.round(avgRecent)}mg/dLë¡œ ì „ì²´ í‰ê· ë³´ë‹¤ ë†’ìŠµë‹ˆë‹¤.`,
              recommendation: 'ì‹ë‹¨ê³¼ ìš´ë™ íŒ¨í„´ì„ ì ê²€í•´ë³´ì„¸ìš”.'
            });
          } else if (avgRecent < avgOverall - 20) {
            insights.push({
              type: 'positive',
              title: 'ğŸ‘ í˜ˆë‹¹ ê´€ë¦¬ ê°œì„ ',
              description: `ìµœê·¼ 7ì¼ í‰ê·  í˜ˆë‹¹ì´ ${Math.round(avgRecent)}mg/dLë¡œ ê°œì„ ë˜ì—ˆìŠµë‹ˆë‹¤.`,
              recommendation: 'í˜„ì¬ íŒ¨í„´ì„ ìœ ì§€í•˜ì„¸ìš”!'
            });
          }
        }

        // ìŒì‹ë³„ ê°œì¸í™” ì¶”ì²œ
        const problemFoods = Object.entries(data.foodReactions)
          .filter(([food, reaction]) => reaction.avgGlucose > 200 && reaction.count >= 2)
          .sort((a, b) => b[1].avgGlucose - a[1].avgGlucose);

        if (problemFoods.length > 0) {
          insights.push({
            type: 'warning',
            title: 'ğŸ½ï¸ í˜ˆë‹¹ ìƒìŠ¹ ìŒì‹ ì£¼ì˜',
            description: `${problemFoods[0][0]}ì„(ë¥¼) ì„­ì·¨í•  ë•Œ í‰ê·  í˜ˆë‹¹ì´ ${problemFoods[0][1].avgGlucose}mg/dLì…ë‹ˆë‹¤.`,
            recommendation: 'í•´ë‹¹ ìŒì‹ì˜ ì„­ì·¨ëŸ‰ì„ ì¤„ì´ê±°ë‚˜ ì¸ìŠë¦° ìš©ëŸ‰ì„ ì¡°ì •í•´ë³´ì„¸ìš”.'
          });
        }

        // ì‹œê°„ëŒ€ë³„ íŒ¨í„´ ë¶„ì„
        const timePatterns = Object.entries(data.timePatterns);
        if (timePatterns.length > 0) {
          const highestTimeSlot = timePatterns.reduce((max, [time, pattern]) => 
            pattern.avgGlucose > max.avgGlucose ? {time, avgGlucose: pattern.avgGlucose} : max
          , {time: '', avgGlucose: 0});

          if (highestTimeSlot.avgGlucose > 180) {
            insights.push({
              type: 'info',
              title: 'â° ì‹œê°„ëŒ€ë³„ íŒ¨í„´',
              description: `${highestTimeSlot.time} ì‹œê°„ëŒ€ì— í˜ˆë‹¹ì´ ë†’ì€ ê²½í–¥ì´ ìˆìŠµë‹ˆë‹¤.`,
              recommendation: 'í•´ë‹¹ ì‹œê°„ëŒ€ì˜ ì‹ì‚¬ì™€ ì¸ìŠë¦° íƒ€ì´ë°ì„ ê²€í† í•´ë³´ì„¸ìš”.'
            });
          }
        }

        return insights.slice(0, 3); // ìµœëŒ€ 3ê°œê¹Œì§€
      }

      getPersonalizedRecommendations(currentRecord) {
        const user = this.userManager.getCurrentUser();
        if (!user) return '';

        const food = currentRecord.food;
        const glucose = parseFloat(currentRecord.glucose || 0);
        const data = user.personalizedData;
        
        let recommendations = [];

        // ê°œì¸ë³„ ìŒì‹ ë°˜ì‘ ê¸°ë°˜ ì¶”ì²œ
        if (data.foodReactions[food]) {
          const reaction = data.foodReactions[food];
          if (reaction.avgGlucose > glucose + 30) {
            recommendations.push(`âš ï¸ ì´ì „ì— ${food}ì„(ë¥¼) ë“œì…¨ì„ ë•Œ í‰ê·  ${reaction.avgGlucose}mg/dLê¹Œì§€ ìƒìŠ¹í–ˆìŠµë‹ˆë‹¤. ì£¼ì˜í•˜ì„¸ìš”.`);
          } else if (reaction.avgGlucose < glucose - 30) {
            recommendations.push(`âœ… ${food}ì€(ëŠ”) í˜ˆë‹¹ ìƒìŠ¹ì´ ì ì€ ìŒì‹ì…ë‹ˆë‹¤. ì¢‹ì€ ì„ íƒì´ì—ìš”!`);
          }
        }

        // í˜ˆë‹¹ ìˆ˜ì¤€ë³„ ê°œì¸í™” ì¡°ì–¸
        if (glucose < 70) {
          recommendations.push('ğŸš¨ ì €í˜ˆë‹¹ì…ë‹ˆë‹¤. ì¦‰ì‹œ í¬ë„ë‹¹ì´ë‚˜ ë‹¨ìˆœë‹¹ì„ ì„­ì·¨í•˜ê³  15ë¶„ í›„ ì¬ì¸¡ì •í•˜ì„¸ìš”.');
        } else if (glucose > 250) {
          recommendations.push('ğŸš¨ ê³ í˜ˆë‹¹ì…ë‹ˆë‹¤. ì¶©ë¶„í•œ ìˆ˜ë¶„ ì„­ì·¨ì™€ í•¨ê»˜ ì˜ë£Œì§„ì—ê²Œ ì—°ë½í•˜ëŠ” ê²ƒì„ ê³ ë ¤í•˜ì„¸ìš”.');
        } else if (glucose > 180) {
          const avgInsulin = data.foodReactions[food]?.avgInsulin || 0;
          if (avgInsulin > 0) {
            recommendations.push(`ğŸ’‰ ì´ì „ ê¸°ë¡ì„ ë³´ë©´ ${food}ì— ëŒ€í•´ í‰ê·  ${avgInsulin}ë‹¨ìœ„ì˜ ì¸ìŠë¦°ì„ ì‚¬ìš©í•˜ì…¨ìŠµë‹ˆë‹¤.`);
          }
        }

        // ì¸ìŠë¦° ë¯¼ê°ë„ ê¸°ë°˜ ì¶”ì²œ
        if (data.insulinSensitivity > 0) {
          const suggestedRatio = Math.round(data.insulinSensitivity);
          recommendations.push(`ğŸ“Š ê°œì¸ ë°ì´í„° ë¶„ì„ ê²°ê³¼, íƒ„ìˆ˜í™”ë¬¼ ${suggestedRatio}gë‹¹ ì¸ìŠë¦° 1ë‹¨ìœ„ ë¹„ìœ¨ì„ ì°¸ê³ í•˜ì„¸ìš”.`);
        }

        return recommendations.join('\n\n');
      }
    }

    // ì „ì—­ ë³€ìˆ˜ë“¤
    let userManager = new UserManager();
    let personalizationEngine = new PersonalizationEngine(userManager);
    let currentTab = 'dashboard';

    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
    function calculateCarbs(food, amount) {
      if (!food || !amount || !KOREAN_FOOD_DATABASE[food]) return 0;
      const numAmount = parseFloat(amount);
      if (isNaN(numAmount)) return 0;
      return Math.round((KOREAN_FOOD_DATABASE[food].carbs * numAmount) / 100);
    }

    function getGlucoseColor(glucose) {
      const val = parseFloat(glucose);
      if (val < 70) return '#ef4444'; // ì €í˜ˆë‹¹ - ë¹¨ê°•
      if (val > 180) return '#f59e0b'; // ê³ í˜ˆë‹¹ - ì£¼í™©
      return '#10b981'; // ì •ìƒ - ì´ˆë¡
    }

    function getTrendClass(glucose) {
      if (glucose <= 140) return 'trend-good';
      if (glucose <= 180) return 'trend-warning';
      return 'trend-danger';
    }

    function formatDate(timestamp) {
      return new Date(timestamp).toLocaleString('ko-KR', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // ì•± ì´ˆê¸°í™”
    function initApp() {
      const currentUser = userManager.getCurrentUser();
      
      if (!currentUser) {
        renderAuthScreen();
      } else {
        renderMainApp();
      }
    }

    // ì¸ì¦ í™”ë©´ ë Œë”ë§
    function renderAuthScreen() {
      document.getElementById('app').innerHTML = `
        <div class="auth-container">
          <div class="auth-card">
            <div class="auth-header">
              <h1>ğŸš DiaLife Pro</h1>
              <p>ê°œì¸í™”ëœ 1í˜•ë‹¹ë‡¨ ê´€ë¦¬ ì‹œìŠ¤í…œ</p>
            </div>
            
            <div id="authContent">
              <div id="loginForm">
                <h3 style="margin-bottom: 1rem; color: #1f2937;">ë¡œê·¸ì¸</h3>
                <div class="form-group" style="margin-bottom: 1rem;">
                  <label for="loginUsername">ì‚¬ìš©ìëª…</label>
                  <input type="text" id="loginUsername" required placeholder="ì‚¬ìš©ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <div class="form-group" style="margin-bottom: 1.5rem;">
                  <label for="loginPassword">ë¹„ë°€ë²ˆí˜¸</label>
                  <input type="password" id="loginPassword" required placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <button onclick="handleLogin()" class="btn btn-primary btn-full">ë¡œê·¸ì¸</button>
                
                <p style="text-align: center; margin: 1.5rem 0; color: #6b7280;">ë˜ëŠ”</p>
                
                <button onclick="showRegisterForm()" class="btn btn-success btn-full">
                  ìƒˆ ê³„ì • ë§Œë“¤ê¸°
                </button>
              </div>
              
              <div id="registerForm" class="hidden">
                <h3 style="margin-bottom: 1rem; color: #1f2937;">íšŒì›ê°€ì…</h3>
                <div class="form-grid">
                  <div class="form-group">
                    <label for="regUsername">ì‚¬ìš©ìëª… *</label>
                    <input type="text" id="regUsername" required placeholder="ì‚¬ìš©ìëª…">
                  </div>
                  <div class="form-group">
                    <label for="regPassword">ë¹„ë°€ë²ˆí˜¸ *</label>
                    <input type="password" id="regPassword" required placeholder="ë¹„ë°€ë²ˆí˜¸">
                  </div>
                  <div class="form-group">
                    <label for="regName">ì´ë¦„ *</label>
                    <input type="text" id="regName" required placeholder="ì‹¤ëª…">
                  </div>
                  <div class="form-group">
                    <label for="regAge">ë‚˜ì´</label>
                    <input type="number" id="regAge" placeholder="ë‚˜ì´" min="1" max="120">
                  </div>
                  <div class="form-group">
                    <label for="regWeight">ì²´ì¤‘ (kg)</label>
                    <input type="number" id="regWeight" placeholder="ì²´ì¤‘" step="0.1">
                  </div>
                  <div class="form-group">
                    <label for="regHeight">ì‹ ì¥ (cm)</label>
                    <input type="number" id="regHeight" placeholder="ì‹ ì¥">
                  </div>
                </div>
                
                <div class="form-group" style="margin: 1rem 0;">
                  <label for="regDiagnosis">1í˜•ë‹¹ë‡¨ ì§„ë‹¨ ì—°ë„</label>
                  <input type="number" id="regDiagnosis" placeholder="YYYY" min="1950" max="2024">
                </div>
                
                <button onclick="handleRegister()" class="btn btn-success btn-full" style="margin-bottom: 1rem;">
                  íšŒì›ê°€ì… ì™„ë£Œ
                </button>
                
                <button onclick="showLoginForm()" class="btn btn-primary btn-full">
                  ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ë©”ì¸ ì•± ë Œë”ë§
    function renderMainApp() {
      const user = userManager.getCurrentUser();
      const insights = personalizationEngine.getPersonalizedInsights();
      
      document.getElementById('app').innerHTML = `
        <div class="container">
          <header class="header">
            <div class="header-left">
              <h1>ğŸš DiaLife Pro AI</h1>
              <div class="welcome">ì•ˆë…•í•˜ì„¸ìš”, ${user.name}ë‹˜! ê°œì¸í™”ëœ ë‹¹ë‡¨ ê´€ë¦¬ë¥¼ ì‹œì‘í•˜ì„¸ìš”.</div>
            </div>
            <div class="header-right">
              <div class="user-info">
                <div class="user-name">${user.name} (${user.age || 'ë¯¸ì„¤ì •'}ì„¸)</div>
                <div class="user-stats">
                  ì´ ${user.personalizedData.totalRecords}ê°œ ê¸°ë¡ â€¢ 
                  í‰ê·  í˜ˆë‹¹ ${user.personalizedData.avgGlucose || 0}mg/dL
                </div>
              </div>
              <button onclick="logout()" class="btn btn-logout">
                ğŸšª ë¡œê·¸ì•„ì›ƒ
              </button>
            </div>
          </header>

          ${insights.length > 0 ? `
          <div class="personalized-insights">
            <h2 style="margin-bottom: 1rem; color: #0c4a6e;">
              ğŸ¯ ${user.name}ë‹˜ì„ ìœ„í•œ ê°œì¸í™” ì¸ì‚¬ì´íŠ¸
            </h2>
            <div class="insight-grid">
              ${insights.map(insight => `
                <div class="insight-card">
                  <div class="insight-title">${insight.title}</div>
                  <p style="margin-bottom: 0.5rem; font-size: 0.9rem;">${insight.description}</p>
                  <p style="font-size: 0.85rem; color: #059669; font-weight: 500;">ğŸ’¡ ${insight.recommendation}</p>
                </div>
              `).join('')}
            </div>
          </div>
          ` : ''}

          <div class="tab-container">
            <div class="tab-buttons">
              <button class="tab-button ${currentTab === 'dashboard' ? 'active' : ''}" onclick="switchTab('dashboard')">
                ğŸ“Š ëŒ€ì‹œë³´ë“œ
              </button>
              <button class="tab-button ${currentTab === 'record' ? 'active' : ''}" onclick="switchTab('record')">
                â• ê¸°ë¡ ì¶”ê°€
              </button>
              <button class="tab-button ${currentTab === 'analysis' ? 'active' : ''}" onclick="switchTab('analysis')">
                ğŸ“ˆ ê°œì¸ ë¶„ì„
              </button>
              <button class="tab-button ${currentTab === 'food' ? 'active' : ''}" onclick="switchTab('food')">
                ğŸ½ï¸ ìŒì‹ íŒ¨í„´
              </button>
              <button class="tab-button ${currentTab === 'profile' ? 'active' : ''}" onclick="switchTab('profile')">
                âš™ï¸ ì„¤ì •
              </button>
            </div>
          </div>

          <div id="tabContent"></div>
        </div>
      `;

      renderTabContent();
    }

    // íƒ­ ì»¨í…ì¸  ë Œë”ë§
    function renderTabContent() {
      const container = document.getElementById('tabContent');
      const user = userManager.getCurrentUser();
      
      switch (currentTab) {
        case 'dashboard':
          renderDashboard(container, user);
          break;
        case 'record':
          renderRecordForm(container, user);
          break;
        case 'analysis':
          renderAnalysis(container, user);
          break;
        case 'food':
          renderFoodPatterns(container, user);
          break;
        case 'profile':
          renderProfile(container, user);
          break;
      }
    }

    function renderDashboard(container, user) {
      const data = user.personalizedData;
      const recentRecords = user.records.slice(-10);
      
      container.innerHTML = `
        <div class="stats-dashboard">
          <div class="stat-card">
            <div class="stat-value">${data.avgGlucose || 0}</div>
            <div class="stat-label">í‰ê·  í˜ˆë‹¹ (mg/dL)</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${data.totalRecords}</div>
            <div class="stat-label">ì´ ê¸°ë¡ ìˆ˜</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${data.insulinSensitivity || 'ê³„ì‚°ì¤‘'}</div>
            <div class="stat-label">ì¸ìŠë¦° ë¯¼ê°ë„ (g/ë‹¨ìœ„)</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${Object.keys(data.foodReactions).length}</div>
            <div class="stat-label">ë¶„ì„ëœ ìŒì‹ ìˆ˜</div>
          </div>
        </div>

        <div class="main-grid">
          <div class="card">
            <h2>ğŸ“‹ ìµœê·¼ ê¸°ë¡</h2>
            <div id="recentRecords">
              ${recentRecords.length === 0 ? 
                '<p style="color: #6b7280; text-align: center; padding: 2rem;">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>' :
                recentRecords.reverse().map(record => `
                  <div class="pattern-item">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                      <strong>${record.food}</strong>
                      <span style="color: ${getGlucoseColor(record.glucose)}; font-weight: 600;">
                        ${record.glucose} mg/dL
                      </span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                      <div style="font-size: 0.875rem; color: #6b7280;">
                        íƒ„ìˆ˜í™”ë¬¼ ${record.carbs}g â€¢ ì¸ìŠë¦° ${record.insulin}ë‹¨ìœ„ â€¢ 
                        ${new Date(record.timestamp).toLocaleDateString()}
                      </div>
                      <button onclick="deleteRecord(${record.id})" class="btn btn-danger btn-small">ì‚­ì œ</button>
                    </div>
                  </div>
                `).join('')
              }
            </div>
          </div>

          <div class="card">
            <h2>â° ì‹œê°„ëŒ€ë³„ í˜ˆë‹¹ íŒ¨í„´</h2>
            <div>
              ${Object.entries(data.timePatterns).map(([timeSlot, pattern]) => `
                <div class="pattern-item">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                      <strong>${timeSlot}</strong>
                      <div style="font-size: 0.875rem; color: #6b7280;">
                        ${pattern.count}íšŒ ê¸°ë¡
                      </div>
                    </div>
                    <div style="text-align: right;">
                      <div style="font-size: 1.25rem; font-weight: 600; color: ${getGlucoseColor(pattern.avgGlucose)};">
                        ${pattern.avgGlucose} mg/dL
                      </div>
                    </div>
                  </div>
                </div>
              `).join('') || '<p style="color: #6b7280;">ì¶©ë¶„í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'}
            </div>
          </div>
        </div>
      `;
    }

    function renderRecordForm(container, user) {
      container.innerHTML = `
        <div class="card full-width">
          <h2>â• ìƒˆ í˜ˆë‹¹ ê¸°ë¡ ì¶”ê°€</h2>
          <div class="form-grid">
            <div class="form-group">
              <label for="glucose">í˜ˆë‹¹ ìˆ˜ì¹˜ (mg/dL) *</label>
              <input type="number" id="glucose" name="glucose" required min="30" max="600" placeholder="í˜ˆë‹¹ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            
            <div class="form-group">
              <label for="food">ìŒì‹ ì´ë¦„ *</label>
              <input type="text" id="food" name="food" required placeholder="ìŒì‹ì„ ê²€ìƒ‰í•˜ì„¸ìš”" list="foodList" autocomplete="off">
              <datalist id="foodList">
                ${Object.keys(KOREAN_FOOD_DATABASE).map(food => `<option value="${food}">`).join('')}
              </datalist>
            </div>
            
            <div class="form-group">
              <label for="amount">ì„­ì·¨ëŸ‰ (g)</label>
              <input type="number" id="amount" name="amount" min="0" step="0.1" placeholder="ê·¸ë¨ ë‹¨ìœ„">
            </div>
            
            <div class="form-group">
              <label for="insulin">ì¸ìŠë¦° ìš©ëŸ‰ (ë‹¨ìœ„)</label>
              <input type="number" id="insulin" name="insulin" min="0" step="0.5" placeholder="ì£¼ì‚¬ ë‹¨ìœ„">
            </div>
          </div>
          
          <div id="personalizedPreview"></div>
          
          <button onclick="handleRecordSubmit()" class="btn btn-primary btn-full">
            ğŸ’¾ ê¸°ë¡ ì €ì¥í•˜ê¸°
          </button>
          
          <div id="aiRecommendations"></div>
        </div>
      `;

      setupRecordFormListeners();
    }

    function setupRecordFormListeners() {
      const foodInput = document.getElementById('food');
      const amountInput = document.getElementById('amount');
      
      if (foodInput) {
        foodInput.addEventListener('input', updatePersonalizedPreview);
      }
      if (amountInput) {
        amountInput.addEventListener('input', updatePersonalizedPreview);
      }
    }

    function updatePersonalizedPreview() {
      const food = document.getElementById('food').value;
      const amount = document.getElementById('amount').value;
      const preview = document.getElementById('personalizedPreview');
      const user = userManager.getCurrentUser();
      
      if (!food || !preview) return;
      
      let content = '';
      
      // ìŒì‹ ì˜ì–‘ ì •ë³´
      if (KOREAN_FOOD_DATABASE[food] && amount) {
        const foodData = KOREAN_FOOD_DATABASE[food];
        const carbs = Math.round(foodData.carbs * amount / 100);
        const protein = Math.round(foodData.protein * amount / 100);
        const fat = Math.round(foodData.fat * amount / 100);
        
        content += `
          <div class="preview-box">
            <h4 style="margin-bottom: 0.75rem; color: #1e40af;">ğŸ¥„ ì˜ì–‘ ì •ë³´</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem; text-align: center;">
              <div><strong>${carbs}g</strong><br><small>íƒ„ìˆ˜í™”ë¬¼</small></div>
              <div><strong>${protein}g</strong><br><small>ë‹¨ë°±ì§ˆ</small></div>
              <div><strong>${fat}g</strong><br><small>ì§€ë°©</small></div>
              <div><strong>GI ${foodData.glycemicIndex}</strong><br><small>í˜ˆë‹¹ì§€ìˆ˜</small></div>
            </div>
        `;

        // ê°œì¸í™”ëœ ì¸ìŠë¦° ì œì•ˆ
        if (user.personalizedData.insulinSensitivity > 0) {
          const suggestedInsulin = Math.round((carbs / user.personalizedData.insulinSensitivity) * 10) / 10;
          content += `
            <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(139, 92, 246, 0.1); border-radius: 0.5rem;">
              <strong>ğŸ’¡ ê°œì¸í™” ì œì•ˆ:</strong> ê°œì¸ ë°ì´í„° ê¸°ë°˜ ì¸ìŠë¦° ${suggestedInsulin}ë‹¨ìœ„ ì°¸ê³ 
            </div>
          `;
        }

        content += `</div>`;
      }
      
      // ê°œì¸ë³„ ìŒì‹ íˆìŠ¤í† ë¦¬
      if (user.personalizedData.foodReactions[food]) {
        const reaction = user.personalizedData.foodReactions[food];
        content += `
          <div class="personal-analysis">
            <h4 style="margin-bottom: 0.75rem; color: #0c4a6e;">ğŸ“Š ê°œì¸ ê¸°ë¡ ë¶„ì„</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; text-align: center;">
              <div><strong>${reaction.count}íšŒ</strong><br><small>ì„­ì·¨ ê¸°ë¡</small></div>
              <div><strong>${reaction.avgGlucose}mg/dL</strong><br><small>í‰ê·  í˜ˆë‹¹</small></div>
              <div><strong>${reaction.avgInsulin}ë‹¨ìœ„</strong><br><small>í‰ê·  ì¸ìŠë¦°</small></div>
            </div>
            <div class="glucose-trend">
              <div class="trend-indicator ${getTrendClass(reaction.avgGlucose)}"></div>
              <span style="font-size: 0.875rem;">
                ${reaction.avgGlucose > 180 ? 'ì£¼ì˜ í•„ìš”' : reaction.avgGlucose > 140 ? 'ë³´í†µ' : 'ì–‘í˜¸'}
              </span>
            </div>
          </div>
        `;
      }
      
      preview.innerHTML = content;
    }

    function renderAnalysis(container, user) {
      const data = user.personalizedData;
      
      container.innerHTML = `
        <div class="card full-width">
          <h2>ğŸ“ˆ ê°œì¸ í˜ˆë‹¹ íŒ¨í„´ ë¶„ì„</h2>
          
          ${user.records.length < 10 ? `
            <div style="text-align: center; padding: 2rem; background: #f8fafc; border-radius: 1rem; margin-bottom: 2rem;">
              <h3 style="color: #6b7280; margin-bottom: 1rem;">ğŸ“Š ë” ì •í™•í•œ ë¶„ì„ì„ ìœ„í•´</h3>
              <p style="color: #6b7280;">í˜„ì¬ ${user.records.length}ê°œì˜ ê¸°ë¡ì´ ìˆìŠµë‹ˆë‹¤. 10ê°œ ì´ìƒì˜ ê¸°ë¡ì´ ìˆì–´ì•¼ ë” ì •í™•í•œ íŒ¨í„´ ë¶„ì„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
            </div>
          ` : ''}
          
          <div class="main-grid">
            <div class="card">
              <h3>ğŸ¯ í˜ˆë‹¹ ë²”ìœ„ ë¶„ì„</h3>
              ${analyzeGlucoseRanges(user.records)}
            </div>
            
            <div class="card">
              <h3>ğŸ“Š ì›”ê°„ íŠ¸ë Œë“œ</h3>
              ${analyzeMonthlyTrend(user.records)}
            </div>
          </div>
        </div>
      `;
    }

    function analyzeGlucoseRanges(records) {
      if (records.length === 0) return '<p style="color: #6b7280;">ë¶„ì„í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      
      const ranges = {
        low: records.filter(r => parseFloat(r.glucose) < 70).length,
        normal: records.filter(r => parseFloat(r.glucose) >= 70 && parseFloat(r.glucose) <= 180).length,
        high: records.filter(r => parseFloat(r.glucose) > 180).length
      };
      
      const total = records.length;
      
      return `
        <div style="space-y: 1rem;">
          <div class="pattern-item">
            <div style="display: flex; justify-content: space-between;">
              <span>ì €í˜ˆë‹¹ (&lt;70mg/dL)</span>
              <strong style="color: #ef4444;">${ranges.low}íšŒ (${Math.round(ranges.low/total*100)}%)</strong>
            </div>
          </div>
          <div class="pattern-item">
            <div style="display: flex; justify-content: space-between;">
              <span>ì •ìƒë²”ìœ„ (70-180mg/dL)</span>
              <strong style="color: #10b981;">${ranges.normal}íšŒ (${Math.round(ranges.normal/total*100)}%)</strong>
            </div>
          </div>
          <div class="pattern-item">
            <div style="display: flex; justify-content: space-between;">
              <span>ê³ í˜ˆë‹¹ (&gt;180mg/dL)</span>
              <strong style="color: #f59e0b;">${ranges.high}íšŒ (${Math.round(ranges.high/total*100)}%)</strong>
            </div>
          </div>
        </div>
      `;
    }

    function analyzeMonthlyTrend(records) {
      if (records.length === 0) return '<p style="color: #6b7280;">ë¶„ì„í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      
      const now = new Date();
      const thisMonth = records.filter(r => {
        const recordDate = new Date(r.timestamp);
        return recordDate.getMonth() === now.getMonth() && recordDate.getFullYear() === now.getFullYear();
      });
      
      const lastMonth = records.filter(r => {
        const recordDate = new Date(r.timestamp);
        const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1);
        return recordDate.getMonth() === lastMonthDate.getMonth() && recordDate.getFullYear() === lastMonthDate.getFullYear();
      });
      
      const thisMonthAvg = thisMonth.length > 0 ? 
        Math.round(thisMonth.reduce((sum, r) => sum + parseFloat(r.glucose), 0) / thisMonth.length) : 0;
      const lastMonthAvg = lastMonth.length > 0 ? 
        Math.round(lastMonth.reduce((sum, r) => sum + parseFloat(r.glucose), 0) / lastMonth.length) : 0;
      
      const trend = thisMonthAvg - lastMonthAvg;
      
      return `
        <div>
          <div class="pattern-item">
            <div style="display: flex; justify-content: space-between;">
              <span>ì´ë²ˆ ë‹¬ í‰ê· </span>
              <strong>${thisMonthAvg}mg/dL (${thisMonth.length}íšŒ)</strong>
            </div>
          </div>
          <div class="pattern-item">
            <div style="display: flex; justify-content: space-between;">
              <span>ì§€ë‚œ ë‹¬ í‰ê· </span>
              <strong>${lastMonthAvg}mg/dL (${lastMonth.length}íšŒ)</strong>
            </div>
          </div>
          ${lastMonth.length > 0 ? `
          <div class="pattern-item">
            <div style="display: flex; justify-content: space-between;">
              <span>ë³€í™”ëŸ‰</span>
              <strong style="color: ${trend > 0 ? '#f59e0b' : '#10b981'};">
                ${trend > 0 ? '+' : ''}${trend}mg/dL
              </strong>
            </div>
          </div>
          ` : ''}
        </div>
      `;
    }

    function renderFoodPatterns(container, user) {
      const foodReactions = user.personalizedData.foodReactions;
      
      container.innerHTML = `
        <div class="card full-width">
          <h2>ğŸ½ï¸ ê°œì¸ë³„ ìŒì‹ ë°˜ì‘ íŒ¨í„´</h2>
          ${Object.keys(foodReactions).length === 0 ? 
            '<p style="color: #6b7280; text-align: center; padding: 2rem;">ì•„ì§ ì¶©ë¶„í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë” ë§ì€ ê¸°ë¡ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.</p>' :
            `<div style="margin-bottom: 1rem;">
              <p style="color: #6b7280;">ì´ ${Object.keys(foodReactions).length}ì¢…ë¥˜ì˜ ìŒì‹ ë°ì´í„°ê°€ ë¶„ì„ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            </div>
            ${Object.entries(foodReactions)
              .sort((a, b) => b[1].count - a[1].count)
              .map(([food, reaction]) => `
                <div class="pattern-item">
                  <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                    <h4>${food}</h4>
                    <div class="trend-indicator ${getTrendClass(reaction.avgGlucose)}"></div>
                  </div>
                  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem; margin-bottom: 0.5rem;">
                    <div><strong>${reaction.count}íšŒ</strong><br><small>ì„­ì·¨</small></div>
                    <div><strong>${reaction.avgGlucose}mg/dL</strong><br><small>í‰ê·  í˜ˆë‹¹</small></div>
                    <div><strong>${reaction.avgInsulin}ë‹¨ìœ„</strong><br><small>í‰ê·  ì¸ìŠë¦°</small></div>
                    <div><strong>${reaction.avgCarbs}g</strong><br><small>í‰ê·  íƒ„ìˆ˜í™”ë¬¼</small></div>
                  </div>
                  <div style="font-size: 0.875rem; color: #6b7280;">
                    ${KOREAN_FOOD_DATABASE[food] ? `GI ${KOREAN_FOOD_DATABASE[food].glycemicIndex} â€¢ ${KOREAN_FOOD_DATABASE[food].category}` : ''}
                  </div>
                </div>
              `).join('')}`
          }
        </div>
      `;
    }

    function renderProfile(container, user) {
      container.innerHTML = `
        <div class="main-grid">
          <div class="card">
            <h2>ğŸ‘¤ í”„ë¡œí•„ ì •ë³´</h2>
            <div class="pattern-item">
              <h4>ê°œì¸ ì •ë³´</h4>
              <p><strong>ì´ë¦„:</strong> ${user.name}</p>
              <p><strong>ë‚˜ì´:</strong> ${user.age || 'ë¯¸ì„¤ì •'}ì„¸</p>
              <p><strong>ì²´ì¤‘:</strong> ${user.weight || 'ë¯¸ì„¤ì •'}kg</p>
              <p><strong>ì‹ ì¥:</strong> ${user.height || 'ë¯¸ì„¤ì •'}cm</p>
              <p><strong>ì§„ë‹¨ ì—°ë„:</strong> ${user.diagnosisYear || 'ë¯¸ì„¤ì •'}</p>
            </div>
            
            <div class="pattern-item">
              <h4>ê³„ì • ì •ë³´</h4>
              <p><strong>ê°€ì…ì¼:</strong> ${new Date(user.createdAt).toLocaleDateString()}</p>
              <p><strong>ë§ˆì§€ë§‰ ë¡œê·¸ì¸:</strong> ${new Date(user.lastLogin).toLocaleDateString()}</p>
              <p><strong>ì‚¬ìš©ìëª…:</strong> ${user.username}</p>
            </div>
          </div>
          
          <div class="card">
            <h2>ğŸ“Š ë°ì´í„° ê´€ë¦¬</h2>
            <div style="space-y: 1rem;">
              <button onclick="exportUserData()" class="btn btn-primary btn-full">
                ğŸ“¤ ë‚´ ë°ì´í„° ë‚´ë³´ë‚´ê¸°
              </button>
              
              <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importUserData(event)">
              <button onclick="document.getElementById('importFile').click()" class="btn btn-primary btn-full">
                ğŸ“¥ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
              </button>
              
              <button onclick="resetAllData()" class="btn btn-danger btn-full">
                ğŸ—‘ï¸ ëª¨ë“  ë°ì´í„° ì‚­ì œ
              </button>
            </div>
            
            <div style="margin-top: 2rem; padding: 1rem; background: #f8fafc; border-radius: 0.5rem;">
              <h4 style="margin-bottom: 0.5rem;">âš ï¸ ì£¼ì˜ì‚¬í•­</h4>
              <p style="font-size: 0.875rem; color: #6b7280;">
                ë°ì´í„° ì‚­ì œëŠ” ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¤‘ìš”í•œ ë°ì´í„°ëŠ” ë¯¸ë¦¬ ë‚´ë³´ë‚´ê¸° í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.
              </p>
            </div>
          </div>
        </div>
      `;
    }

    // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë“¤
    function handleLogin() {
      const username = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;
      
      if (!username || !password) {
        alert('ì‚¬ìš©ìëª…ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      const user = userManager.login(username, password);
      if (user) {
        renderMainApp();
      } else {
        alert('ì‚¬ìš©ìëª… ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      }
    }

    function handleRegister() {
      const username = document.getElementById('regUsername').value;
      const password = document.getElementById('regPassword').value;
      const name = document.getElementById('regName').value;
      const age = document.getElementById('regAge').value;
      const weight = document.getElementById('regWeight').value;
      const height = document.getElementById('regHeight').value;
      const diagnosisYear = document.getElementById('regDiagnosis').value;
      
      if (!username || !password || !name) {
        alert('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // ì¤‘ë³µ ì‚¬ìš©ìëª… ì²´í¬
      const existingUser = Object.values(userManager.users).find(u => u.username === username);
      if (existingUser) {
        alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì‚¬ìš©ìëª…ì…ë‹ˆë‹¤.');
        return;
      }
      
      const userData = {
        username: username,
        password: password,
        name: name,
        age: age,
        weight: weight,
        height: height,
        diagnosisYear: diagnosisYear
      };
      
      const user = userManager.register(userData);
      userManager.currentUser = user;
      renderMainApp();
    }

    function handleRecordSubmit() {
      const glucose = document.getElementById('glucose').value;
      const food = document.getElementById('food').value;
      const amount = document.getElementById('amount').value || 0;
      const insulin = document.getElementById('insulin').value || 0;
      
      if (!glucose || !food) {
        alert('í˜ˆë‹¹ê³¼ ìŒì‹ ì´ë¦„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
        return;
      }

      const record = {
        id: Date.now() + Math.random(),
        glucose: glucose,
        food: food,
        amount: amount,
        insulin: insulin,
        carbs: calculateCarbs(food, amount),
        timestamp: new Date().toISOString()
      };

      userManager.addRecord(record);
      
      // ê°œì¸í™” ì¶”ì²œ í‘œì‹œ
      const recommendations = personalizationEngine.getPersonalizedRecommendations(record);
      if (recommendations) {
        const aiDiv = document.getElementById('aiRecommendations');
        aiDiv.innerHTML = `
          <div class="ai-recommendations">
            <h3 style="margin-bottom: 1rem;">ğŸ¤– ê°œì¸í™” AI ë¶„ì„</h3>
            <div style="white-space: pre-line; line-height: 1.6;">${recommendations}</div>
          </div>
        `;
      }
      
      // í¼ ì´ˆê¸°í™”
      document.getElementById('glucose').value = '';
      document.getElementById('food').value = '';
      document.getElementById('amount').value = '';
      document.getElementById('insulin').value = '';
      updatePersonalizedPreview();
      
      alert('ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
      
      // ëŒ€ì‹œë³´ë“œë¡œ ì´ë™
      setTimeout(() => {
        currentTab = 'dashboard';
        renderMainApp();
      }, 2000);
    }

    function switchTab(tabName) {
      currentTab = tabName;
      renderMainApp();
    }

    function showRegisterForm() {
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('registerForm').classList.remove('hidden');
    }

    function showLoginForm() {
      document.getElementById('registerForm').classList.add('hidden');
      document.getElementById('loginForm').classList.remove('hidden');
    }

    function logout() {
      if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        userManager.currentUser = null;
        currentTab = 'dashboard';
        renderAuthScreen();
      }
    }

    function deleteRecord(recordId) {
      if (confirm('ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        userManager.deleteRecord(recordId);
        renderMainApp();
      }
    }

    function exportUserData() {
      const user = userManager.getCurrentUser();
      if (!user) return;
      
      const data = {
        user: user,
        exported: new Date().toISOString(),
        version: '1.0'
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `dialife-${user.name}-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function importUserData(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          
          if (data.user && data.user.id) {
            if (confirm('ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ë©´ í˜„ì¬ ì‚¬ìš©ì ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
              userManager.users[data.user.id] = data.user;
              userManager.currentUser = data.user;
              userManager.saveUsers();
              alert('ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤!');
              renderMainApp();
            }
          } else {
            alert('ì˜¬ë°”ë¥´ì§€ ì•Šì€ ë°ì´í„° íŒŒì¼ì…ë‹ˆë‹¤.');
          }
        } catch (error) {
          alert('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      };
      reader.readAsText(file);
    }

    function resetAllData() {
      if (confirm('ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        if (confirm('ë§ˆì§€ë§‰ í™•ì¸: ëª¨ë“  ì‚¬ìš©ì ë°ì´í„°ì™€ ê¸°ë¡ì´ ì‚­ì œë©ë‹ˆë‹¤.')) {
          localStorage.clear();
          location.reload();
        }
      }
    }

    // ì•± ì‹œì‘
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(initApp, 1000); // ë¡œë”© íš¨ê³¼ë¥¼ ìœ„í•œ ì§€ì—°
    });

    // ì „ì—­ í•¨ìˆ˜ ë“±ë¡
    window.handleLogin = handleLogin;
    window.handleRegister = handleRegister;
    window.handleRecordSubmit = handleRecordSubmit;
    window.switchTab = switchTab;
    window.showRegisterForm = showRegisterForm;
    window.showLoginForm = showLoginForm;
    window.logout = logout;
    window.deleteRecord = deleteRecord;
    window.exportUserData = exportUserData;
    window.importUserData = importUserData;
    window.resetAllData = resetAllData;
  </script>
</body>
</html>
