import React, { useState, useEffect } from 'react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';
import { Plus, Settings, Download, Upload, Activity, Apple, Calendar, AlertCircle, Check, Edit2, Trash2, X, User, Dumbbell, Play, Square, Clock } from 'lucide-react';

// 로컬스토리지 키
const STORAGE_KEYS = {
  PROFILES: 'diabetes_app_profiles',
  CURRENT_PROFILE: 'diabetes_app_current_profile',
  DISCLAIMER: 'diabetes_app_disclaimer_accepted'
};

// 의료 면책조항 모달
const DisclaimerModal = ({ onAccept }) => (
  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div className="bg-white rounded-lg max-w-2xl w-full p-6 max-h-screen overflow-y-auto">
      <div className="flex items-center gap-2 text-red-600 mb-4">
        <AlertCircle size={24} />
        <h2 className="text-xl font-bold">의료 면책조항</h2>
      </div>
      <div className="space-y-4 text-sm text-gray-700">
        <p className="font-semibold">본 애플리케이션을 사용하기 전에 반드시 읽어주세요:</p>
        <ul className="list-disc pl-5 space-y-2">
          <li>본 앱은 1형 당뇨병 관리를 돕기 위한 <strong>보조 도구</strong>이며, 의료 전문가의 진단이나 처방을 대체할 수 없습니다.</li>
          <li>인슐린 투여량 계산은 <strong>참고용</strong>이며, 실제 투여 전 반드시 주치의와 상담하시기 바랍니다.</li>
          <li>본 앱은 대한당뇨병학회 및 보건복지부 지침을 참고하여 제작되었으나, 개인별 상황에 따라 적용이 다를 수 있습니다.</li>
          <li>응급 상황(심한 저혈당/고혈당)시 즉시 의료기관을 방문하시기 바랍니다.</li>
          <li>본 앱 사용으로 인한 어떠한 의료적 결과에 대해서도 개발자는 책임지지 않습니다.</li>
          <li>모든 데이터는 귀하의 브라우저에만 저장되며, 외부로 전송되지 않습니다.</li>
        </ul>
        <p className="font-semibold text-red-600">위 내용을 이해하고 동의하시면 '동의하고 시작하기' 버튼을 눌러주세요.</p>
      </div>
      <button
        onClick={onAccept}
        className="w-full mt-6 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700"
      >
        동의하고 시작하기
      </button>
    </div>
  </div>
);

// 프로필 선택/생성 모달
const ProfileModal = ({ profiles, currentProfile, onSelectProfile, onCreateProfile, onDeleteProfile, onClose }) => {
  const [newProfileName, setNewProfileName] = useState('');
  const [isCreating, setIsCreating] = useState(false);

  const handleCreate = () => {
    if (!newProfileName.trim()) {
      alert('프로필 이름을 입력해주세요.');
      return;
    }
    if (profiles.some(p => p.name === newProfileName.trim())) {
      alert('이미 존재하는 프로필 이름입니다.');
      return;
    }
    onCreateProfile(newProfileName.trim());
    setNewProfileName('');
    setIsCreating(false);
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg max-w-md w-full p-6">
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-xl font-bold flex items-center gap-2">
            <User size={24} />
            프로필 관리
          </h2>
          {currentProfile && (
            <button onClick={onClose} className="text-gray-500 hover:text-gray-700">
              <X size={24} />
            </button>
          )}
        </div>

        <div className="space-y-3 mb-4 max-h-64 overflow-y-auto">
          {profiles.map(profile => (
            <div
              key={profile.id}
              className={`border rounded p-3 flex items-center justify-between ${
                currentProfile?.id === profile.id ? 'border-blue-500 bg-blue-50' : 'hover:bg-gray-50'
              }`}
            >
              <div className="flex-1">
                <p className="font-medium">{profile.name}</p>
                <p className="text-xs text-gray-500">
                  기록 {profile.records?.length || 0}건 · 
                  생성일 {new Date(profile.createdAt).toLocaleDateString('ko-KR')}
                </p>
              </div>
              <div className="flex gap-2">
                {currentProfile?.id !== profile.id && (
                  <button
                    onClick={() => onSelectProfile(profile.id)}
                    className="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700"
                  >
                    선택
                  </button>
                )}
                {profiles.length > 1 && (
                  <button
                    onClick={() => {
                      if (confirm(`"${profile.name}" 프로필을 삭제하시겠습니까? 모든 데이터가 영구 삭제됩니다.`)) {
                        onDeleteProfile(profile.id);
                      }
                    }}
                    className="p-1 text-red-600 hover:bg-red-50 rounded"
                  >
                    <Trash2 size={16} />
                  </button>
                )}
              </div>
            </div>
          ))}
        </div>

        {isCreating ? (
          <div className="space-y-2">
            <input
              type="text"
              value={newProfileName}
              onChange={(e) => setNewProfileName(e.target.value)}
              placeholder="새 프로필 이름"
              className="w-full border rounded px-3 py-2"
              onKeyPress={(e) => e.key === 'Enter' && handleCreate()}
              autoFocus
            />
            <div className="flex gap-2">
              <button
                onClick={handleCreate}
                className="flex-1 bg-green-600 text-white py-2 rounded hover:bg-green-700"
              >
                생성
              </button>
              <button
                onClick={() => {
                  setIsCreating(false);
                  setNewProfileName('');
                }}
                className="flex-1 bg-gray-300 text-gray-700 py-2 rounded hover:bg-gray-400"
              >
                취소
              </button>
            </div>
          </div>
        ) : (
          <button
            onClick={() => setIsCreating(true)}
            className="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 flex items-center justify-center gap-2"
          >
            <Plus size={18} />
            새 프로필 만들기
          </button>
        )}
      </div>
    </div>
  );
};

// 설정 모달
const SettingsModal = ({ settings, onSave, onClose }) => {
  const [localSettings, setLocalSettings] = useState(settings);

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg max-w-md w-full p-6">
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-xl font-bold">설정</h2>
          <button onClick={onClose} className="text-gray-500 hover:text-gray-700">
            <X size={24} />
          </button>
        </div>
        
        <div className="space-y-4">
          <div>
            <label className="block text-sm font-medium mb-1">인슐린-탄수화물 비율 (ICR)</label>
            <input
              type="number"
              value={localSettings.icr}
              onChange={(e) => setLocalSettings({...localSettings, icr: parseFloat(e.target.value) || 10})}
              className="w-full border rounded px-3 py-2"
              step="0.5"
              min="1"
            />
            <p className="text-xs text-gray-500 mt-1">1단위 인슐린이 처리하는 탄수화물(g)</p>
          </div>

          <div>
            <label className="block text-sm font-medium mb-1">인슐린 민감도 계수 (ISF)</label>
            <input
              type="number"
              value={localSettings.isf}
              onChange={(e) => setLocalSettings({...localSettings, isf: parseFloat(e.target.value) || 50})}
              className="w-full border rounded px-3 py-2"
              min="1"
            />
            <p className="text-xs text-gray-500 mt-1">1단위 인슐린으로 낮출 수 있는 혈당(mg/dL)</p>
          </div>

          <div>
            <label className="block text-sm font-medium mb-1">목표 혈당 (mg/dL)</label>
            <input
              type="number"
              value={localSettings.targetBG}
              onChange={(e) => setLocalSettings({...localSettings, targetBG: parseFloat(e.target.value) || 120})}
              className="w-full border rounded px-3 py-2"
              min="70"
              max="180"
            />
          </div>

          <div>
            <label className="block text-sm font-medium mb-1">CGM 데이터 입력 방식</label>
            <select
              value={localSettings.cgmMode}
              onChange={(e) => setLocalSettings({...localSettings, cgmMode: e.target.value})}
              className="w-full border rounded px-3 py-2"
            >
              <option value="manual">수동 입력</option>
              <option value="import">파일 가져오기</option>
              <option value="api">CGM 연동 (준비중)</option>
            </select>
          </div>

          <button
            onClick={() => {
              onSave(localSettings);
              onClose();
            }}
            className="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700"
          >
            저장
          </button>
        </div>
      </div>
    </div>
  );
};

// 혈당 기록 입력/수정 모달
const RecordModal = ({ record, onSave, onClose }) => {
  const [localRecord, setLocalRecord] = useState(record || {
    id: Date.now(),
    timestamp: new Date().toISOString().slice(0, 16),
    bloodSugar: '',
    insulin: '',
    food: '',
    exercise: '',
    note: ''
  });

  const handleSave = () => {
    if (!localRecord.timestamp) {
      alert('시간을 입력해주세요.');
      return;
    }
    if (!localRecord.bloodSugar && !localRecord.insulin && !localRecord.food && !localRecord.exercise) {
      alert('최소 하나 이상의 정보를 입력해주세요.');
      return;
    }
    onSave(localRecord);
    onClose();
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg max-w-md w-full p-6 max-h-screen overflow-y-auto">
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-xl font-bold">{record ? '기록 수정' : '혈당 기록 추가'}</h2>
          <button onClick={onClose} className="text-gray-500 hover:text-gray-700">
            <X size={24} />
          </button>
        </div>

        <div className="space-y-4">
          <div>
            <label className="block text-sm font-medium mb-1">시간</label>
            <input
              type="datetime-local"
              value={localRecord.timestamp}
              onChange={(e) => setLocalRecord({...localRecord, timestamp: e.target.value})}
              className="w-full border rounded px-3 py-2"
            />
          </div>

          <div>
            <label className="block text-sm font-medium mb-1">혈당 (mg/dL)</label>
            <input
              type="number"
              value={localRecord.bloodSugar}
              onChange={(e) => setLocalRecord({...localRecord, bloodSugar: e.target.value})}
              className="w-full border rounded px-3 py-2"
              placeholder="예: 120"
              min="0"
              max="600"
            />
          </div>

          <div>
            <label className="block text-sm font-medium mb-1">인슐린 투여량 (단위)</label>
            <input
              type="number"
              value={localRecord.insulin}
              onChange={(e) => setLocalRecord({...localRecord, insulin: e.target.value})}
              className="w-full border rounded px-3 py-2"
              placeholder="예: 4"
              step="0.5"
              min="0"
            />
          </div>

          <div>
            <label className="block text-sm font-medium mb-1">음식</label>
            <input
              type="text"
              value={localRecord.food}
              onChange={(e) => setLocalRecord({...localRecord, food: e.target.value})}
              className="w-full border rounded px-3 py-2"
              placeholder="예: 콩나물밥, 미역국, 돈까스"
            />
          </div>

          <div>
            <label className="block text-sm font-medium mb-1">운동</label>
            <input
              type="text"
              value={localRecord.exercise}
              onChange={(e) => setLocalRecord({...localRecord, exercise: e.target.value})}
              className="w-full border rounded px-3 py-2"
              placeholder="예: 헬스 1시간"
            />
          </div>

          <div>
            <label className="block text-sm font-medium mb-1">메모</label>
            <textarea
              value={localRecord.note}
              onChange={(e) => setLocalRecord({...localRecord, note: e.target.value})}
              className="w-full border rounded px-3 py-2"
              rows="3"
              placeholder="기타 메모사항"
            />
          </div>

          <button
            onClick={handleSave}
            className="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700"
          >
            저장
          </button>
        </div>
      </div>
    </div>
  );
};

// 운동 세션 모달
const ExerciseSessionModal = ({ session, onSave, onClose, onQuickBGRecord }) => {
  const [localSession, setLocalSession] = useState(session || {
    id: Date.now(),
    type: '헬스',
    startTime: new Date().toISOString().slice(0, 16),
    endTime: '',
    intensity: '중간',
    bgRecords: [],
    note: '',
    status: 'active'
  });

  const [quickBG, setQuickBG] = useState('');

  const exerciseTypes = ['헬스', '유산소', '요가', '수영', '걷기', '자전거', '기타'];
  const intensityLevels = ['낮음', '중간', '높음'];

  const addQuickBG = () => {
    if (!quickBG || isNaN(parseFloat(quickBG))) {
      alert('혈당 값을 입력해주세요.');
      return;
    }

    const bgRecord = {
      timestamp: new Date().toISOString().slice(0, 16),
      value: quickBG,
      label: localSession.bgRecords.length === 0 ? '운동 시작' : '운동 중'
    };

    setLocalSession({
      ...localSession,
      bgRecords: [...localSession.bgRecords, bgRecord]
    });
    
    onQuickBGRecord({
      id: Date.now(),
      timestamp: bgRecord.timestamp,
      bloodSugar: quickBG,
      insulin: '',
      food: '',
      exercise: `${localSession.type} - ${bgRecord.label}`,
      note: ''
    });

    setQuickBG('');
  };

  const completeSession = () => {
    const endBGRecord = quickBG && !isNaN(parseFloat(quickBG)) ? {
      timestamp: new Date().toISOString().slice(0, 16),
      value: quickBG,
      label: '운동 종료'
    } : null;

    const completedSession = {
      ...localSession,
      endTime: new Date().toISOString().slice(0, 16),
      bgRecords: endBGRecord ? [...localSession.bgRecords, endBGRecord] : localSession.bgRecords,
      status: 'completed'
    };

    if (endBGRecord) {
      onQuickBGRecord({
        id: Date.now(),
        timestamp: endBGRecord.timestamp,
        bloodSugar: quickBG,
        insulin: '',
        food: '',
        exercise: `${localSession.type} - 운동 종료`,
        note: ''
      });
    }

    onSave(completedSession);
    onClose();
  };

  const calculateDuration = () => {
    if (!localSession.startTime || !localSession.endTime) return '진행중';
    const start = new Date(localSession.startTime);
    const end = new Date(localSession.endTime);
    const minutes = Math.round((end - start) / 60000);
    return `${minutes}분`;
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg max-w-lg w-full p-6 max-h-screen overflow-y-auto">
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-xl font-bold flex items-center gap-2">
            <Dumbbell size={24} className="text-purple-600" />
            운동 세션
          </h2>
          <button onClick={onClose} className="text-gray-500 hover:text-gray-700">
            <X size={24} />
          </button>
        </div>

        <div className="space-y-4">
          <div className="grid grid-cols-2 gap-3">
            <div>
              <label className="block text-sm font-medium mb-1">운동 종류</label>
              <select
                value={localSession.type}
                onChange={(e) => setLocalSession({...localSession, type: e.target.value})}
                className="w-full border rounded px-3 py-2"
              >
                {exerciseTypes.map(type => (
                  <option key={type} value={type}>{type}</option>
                ))}
              </select>
            </div>

            <div>
              <label className="block text-sm font-medium mb-1">강도</label>
              <select
                value={localSession.intensity}
                onChange={(e) => setLocalSession({...localSession, intensity: e.target.value})}
                className="w-full border rounded px-3 py-2"
              >
                {intensityLevels.map(level => (
                  <option key={level} value={level}>{level}</option>
                ))}
              </select>
            </div>
          </div>

          <div className="grid grid-cols-2 gap-3">
            <div>
              <label className="block text-sm font-medium mb-1">시작 시간</label>
              <input
                type="datetime-local"
                value={localSession.startTime}
                onChange={(e) => setLocalSession({...localSession, startTime: e.target.value})}
                className="w-full border rounded px-3 py-2"
              />
            </div>

            <div>
              <label className="block text-sm font-medium mb-1">
                종료 시간 {localSession.endTime && `(${calculateDuration()})`}
              </label>
              <input
                type="datetime-local"
                value={localSession.endTime}
                onChange={(e) => setLocalSession({...localSession, endTime: e.target.value})}
                className="w-full border rounded px-3 py-2"
              />
            </div>
          </div>

          <div className="bg-purple-50 border border-purple-200 rounded p-4">
            <h3 className="font-semibold mb-2 flex items-center gap-2">
              <Activity size={18} />
              운동 중 혈당 기록
            </h3>
            <div className="flex gap-2 mb-3">
              <input
                type="number"
                value={quickBG}
                onChange={(e) => setQuickBG(e.target.value)}
                placeholder="현재 혈당"
                className="flex-1 border rounded px-3 py-2"
                min="0"
                max="600"
              />
              <button
                onClick={addQuickBG}
                className="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700"
              >
                기록
              </button>
            </div>

            {localSession.bgRecords.length > 0 && (
              <div className="space-y-1">
                {localSession.bgRecords.map((bg, idx) => (
                  <div key={idx} className="flex justify-between text-sm bg-white rounded px-2 py-1">
                    <span className="text-gray-600">{bg.label}</span>
                    <span className={`font-semibold ${
                      parseFloat(bg.value) < 70 ? 'text-red-600' :
                      parseFloat(bg.value) > 180 ? 'text-orange-600' : 'text-green-600'
                    }`}>
                      {bg.value} mg/dL
                    </span>
                  </div>
                ))}
              </div>
            )}

            {localSession.bgRecords.length >= 2 && (
              <div className="mt-2 text-sm bg-white rounded p-2">
                <span className="text-gray-600">혈당 변화: </span>
                <span className="font-semibold">
                  {localSession.bgRecords[0].value} → {localSession.bgRecords[localSession.bgRecords.length - 1].value} mg/dL
                  {' '}({(parseFloat(localSession.bgRecords[localSession.bgRecords.length - 1].value) - parseFloat(localSession.bgRecords[0].value)) > 0 ? '+' : ''}
                  {(parseFloat(localSession.bgRecords[localSession.bgRecords.length - 1].value) - parseFloat(localSession.bgRecords[0].value)).toFixed(0)})
                </span>
              </div>
            )}
          </div>

          <div>
            <label className="block text-sm font-medium mb-1">메모</label>
            <textarea
              value={localSession.note}
              onChange={(e) => setLocalSession({...localSession, note: e.target.value})}
              className="w-full border rounded px-3 py-2"
              rows="2"
              placeholder="운동 관련 메모"
            />
          </div>

          <div className="flex gap-2">
            {localSession.status === 'active' && (
              <button
                onClick={completeSession}
                className="flex-1 bg-green-600 text-white py-2 rounded hover:bg-green-700 flex items-center justify-center gap-2"
              >
                <Square size={18} />
                운동 종료
              </button>
            )}
            <button
              onClick={() => {
                onSave(localSession);
                onClose();
              }}
              className="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700"
            >
              저장
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

// 인슐린 계산기 모달
const InsulinCalculatorModal = ({ settings, onClose, onSaveRecord }) => {
  const [currentBG, setCurrentBG] = useState('');
  const [foodName, setFoodName] = useState('');
  const [carbs, setCarbs] = useState('');
  const [isSearching, setIsSearching] = useState(false);
  const [calculatedInsulin, setCalculatedInsulin] = useState(null);
  const [nutritionInfo, setNutritionInfo] = useState(null);

  const searchFood = async () => {
    if (!foodName.trim()) {
      alert('음식 이름을 입력해주세요.');
      return;
    }
    
    setIsSearching(true);
    setNutritionInfo(null);
    
    try {
      const response = await fetch("https://api.anthropic.com/v1/messages", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 1000,
          messages: [
            { 
              role: "user", 
              content: `"${foodName}"의 영양성분을 알려주세요. 다음 형식의 JSON으로만 응답해주세요. 다른 텍스트는 포함하지 마세요:

{
  "foodName": "음식 이름",
  "servingSize": "1인분 기준 (예: 200g)",
  "carbohydrates": 탄수화물(g),
  "protein": 단백질(g),
  "fat": 지방(g),
  "calories": 칼로리(kcal),
  "note": "추가 설명"
}

정확한 정보를 찾을 수 없으면 일반적인 추정치를 제공하되, note 필드에 "추정치입니다" 표시를 해주세요.`
            }
          ]
        })
      });

      if (!response.ok) {
        throw new Error(`API 요청 실패: ${response.status}`);
      }

      const data = await response.json();
      let responseText = data.content[0].text;
      responseText = responseText.replace(/```json\n?/g, "").replace(/```\n?/g, "").trim();
      
      const nutrition = JSON.parse(responseText);
      
      if (!nutrition.carbohydrates || isNaN(nutrition.carbohydrates)) {
        throw new Error('유효하지 않은 영양정보입니다.');
      }
      
      setNutritionInfo(nutrition);
      setCarbs(nutrition.carbohydrates.toString());
    } catch (error) {
      console.error("Error searching food:", error);
      alert("음식 정보를 가져오는데 실패했습니다. 탄수화물을 직접 입력해주세요.");
    } finally {
      setIsSearching(false);
    }
  };

  const calculateInsulin = () => {
    if (!currentBG || !carbs) {
      alert("현재 혈당과 탄수화물을 입력해주세요.");
      return;
    }

    const bg = parseFloat(currentBG);
    const carbAmount = parseFloat(carbs);
    
    if (isNaN(bg) || bg <= 0 || bg > 600) {
      alert('혈당 값이 유효하지 않습니다 (1-600 mg/dL).');
      return;
    }
    if (isNaN(carbAmount) || carbAmount < 0) {
      alert('탄수화물 값이 유효하지 않습니다.');
      return;
    }

    const carbInsulin = carbAmount / settings.icr;
    const correctionInsulin = (bg - settings.targetBG) / settings.isf;
    const totalInsulin = Math.max(0, carbInsulin + correctionInsulin);

    setCalculatedInsulin({
      carb: carbInsulin.toFixed(1),
      correction: correctionInsulin.toFixed(1),
      total: totalInsulin.toFixed(1),
      rounded: Math.round(totalInsulin * 2) / 2
    });
  };

  const saveAsRecord = () => {
    if (!calculatedInsulin) return;
    
    const newRecord = {
      id: Date.now(),
      timestamp: new Date().toISOString().slice(0, 16),
      bloodSugar: currentBG,
      insulin: calculatedInsulin.rounded.toString(),
      food: nutritionInfo ? `${nutritionInfo.foodName} (탄${carbs}g)` : foodName,
      exercise: '',
      note: nutritionInfo ? `${nutritionInfo.servingSize}, ${nutritionInfo.calories}kcal` : ''
    };
    onSaveRecord(newRecord);
    onClose();
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg max-w-lg w-full p-6 max-h-screen overflow-y-auto">
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-xl font-bold flex items-center gap-2">
            <Apple size={24} className="text-green-600" />
            인슐린 계산기
          </h2>
          <button onClick={onClose} className="text-gray-500 hover:text-gray-700">
            <X size={24} />
          </button>
        </div>

        <div className="bg-yellow-50 border border-yellow-200 rounded p-3 mb-4 text-sm">
          <p className="font-medium text-yellow-800">⚠️ 계산 결과는 참고용입니다</p>
          <p className="text-yellow-700">실제 인슐린 투여 전 반드시 주치의와 상담하세요.</p>
        </div>

        <div className="space-y-4">
          <div>
            <label className="block text-sm font-medium mb-1">현재 혈당 (mg/dL) *</label>
            <input
              type="number"
              value={currentBG}
              onChange={(e) => setCurrentBG(e.target.value)}
              className="w-full border rounded px-3 py-2"
              placeholder="예: 120"
              min="0"
              max="600"
            />
          </div>

          <div>
            <label className="block text-sm font-medium mb-1">음식 이름</label>
            <div className="flex gap-2">
              <input
                type="text"
                value={foodName}
                onChange={(e) => setFoodName(e.target.value)}
                className="flex-1 border rounded px-3 py-2"
                placeholder="예: 콩나물밥"
                onKeyPress={(e) => e.key === 'Enter' && searchFood()}
              />
              <button
                onClick={searchFood}
                disabled={isSearching}
                className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 disabled:bg-gray-400"
              >
                {isSearching ? '검색중...' : '검색'}
              </button>
            </div>
          </div>

          {nutritionInfo && (
            <div className="bg-green-50 border border-green-200 rounded p-4">
              <h3 className="font-semibold mb-2">{nutritionInfo.foodName}</h3>
              <div className="text-sm space-y-1">
                <p>• 기준량: {nutritionInfo.servingSize}</p>
                <p>• 탄수화물: {nutritionInfo.carbohydrates}g</p>
                <p>• 단백질: {nutritionInfo.protein}g</p>
                <p>• 지방: {nutritionInfo.fat}g</p>
                <p>• 칼로리: {nutritionInfo.calories}kcal</p>
                {nutritionInfo.note && <p className="text-gray-600 italic">* {nutritionInfo.note}</p>}
              </div>
            </div>
          )}

          <div>
            <label className="block text-sm font-medium mb-1">탄수화물 (g) *</label>
            <input
              type="number"
              value={carbs}
              onChange={(e) => setCarbs(e.target.value)}
              className="w-full border rounded px-3 py-2"
              placeholder="예: 60"
              min="0"
              step="0.1"
            />
          </div>

          <button
            onClick={calculateInsulin}
            className="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700"
          >
            인슐린 계산하기
          </button>

          {calculatedInsulin && (
            <div className="bg-blue-50 border border-blue-200 rounded p-4">
              <h3 className="font-semibold mb-2">계산 결과</h3>
              <div className="space-y-1 text-sm">
                <p>• 탄수화물 처리: {calculatedInsulin.carb} 단위</p>
                <p>• 혈당 보정: {calculatedInsulin.correction} 단위</p>
                <p>• 합계: {calculatedInsulin.total} 단위</p>
                <p className="text-lg font-bold text-blue-600 mt-2">
                  → 권장 투여량: {calculatedInsulin.rounded} 단위
                </p>
              </div>
              <button
                onClick={saveAsRecord}
                className="w-full mt-3 bg-green-600 text-white py-2 rounded hover:bg-green-700 flex items-center justify-center gap-2"
              >
                <Check size={18} />
                기록으로 저장
              </button>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

// 메인 앱
export default function DiabetesApp() {
  const [disclaimerAccepted, setDisclaimerAccepted] = useState(false);
  const [profiles, setProfiles] = useState([]);
  const [currentProfile, setCurrentProfile] = useState(null);
  const [showProfileModal, setShowProfileModal] = useState(false);
  const [showSettings, setShowSettings] = useState(false);
  const [showRecordModal, setShowRecordModal] = useState(false);
  const [showCalculator, setShowCalculator] = useState(false);
  const [showExerciseModal, setShowExerciseModal] = useState(false);
  const [editingRecord, setEditingRecord] = useState(null);
  const [editingSession, setEditingSession] = useState(null);
  const [currentTab, setCurrentTab] = useState('dashboard');

  useEffect(() => {
    try {
      const disclaimerStatus = localStorage.getItem(STORAGE_KEYS.DISCLAIMER);
      if (disclaimerStatus === 'accepted') {
        setDisclaimerAccepted(true);
      }

      const savedProfiles = localStorage.getItem(STORAGE_KEYS.PROFILES);
      if (savedProfiles) {
        const parsedProfiles = JSON.parse(savedProfiles);
        setProfiles(parsedProfiles);

        const currentProfileId = localStorage.getItem(STORAGE_KEYS.CURRENT_PROFILE);
        if (currentProfileId) {
          const profile = parsedProfiles.find(p => p.id === currentProfileId);
          if (profile) {
            setCurrentProfile(profile);
          } else {
            setCurrentProfile(parsedProfiles[0]);
            localStorage.setItem(STORAGE_KEYS.CURRENT_PROFILE, parsedProfiles[0].id);
          }
        } else if (parsedProfiles.length > 0) {
          setCurrentProfile(parsedProfiles[0]);
          localStorage.setItem(STORAGE_KEYS.CURRENT_PROFILE, parsedProfiles[0].id);
        }
      } else {
        const defaultProfile = {
          id: Date.now().toString(),
          name: '내 프로필',
          createdAt: new Date().toISOString(),
          settings: {
            icr: 10,
            isf: 50,
            targetBG: 120,
            cgmMode: 'manual'
          },
          records: [],
          exerciseSessions: []
        };
        setProfiles([defaultProfile]);
        setCurrentProfile(defaultProfile);
        localStorage.setItem(STORAGE_KEYS.PROFILES, JSON.stringify([defaultProfile]));
        localStorage.setItem(STORAGE_KEYS.CURRENT_PROFILE, defaultProfile.id);
      }
    } catch (error) {
      console.error('Error loading from localStorage:', error);
    }
  }, []);

  useEffect(() => {
    if (currentProfile && profiles.length > 0) {
      try {
        const updatedProfiles = profiles.map(p => 
          p.id === currentProfile.id ? currentProfile : p
        );
        localStorage.setItem(STORAGE_KEYS.PROFILES, JSON.stringify(updatedProfiles));
        localStorage.setItem(STORAGE_KEYS.CURRENT_PROFILE, currentProfile.id);
      } catch (error) {
        console.error('Error saving to localStorage:', error);
      }
    }
  }, [currentProfile, profiles]);

  const handleDisclaimerAccept = () => {
    setDisclaimerAccepted(true);
    try {
      localStorage.setItem(STORAGE_KEYS.DISCLAIMER, 'accepted');
    } catch (error) {
      console.error('Error saving disclaimer:', error);
    }
  };

  const createProfile = (name) => {
    const newProfile = {
      id: Date.now().toString(),
      name,
      createdAt: new Date().toISOString(),
      settings: {
        icr: 10,
        isf: 50,
        targetBG: 120,
        cgmMode: 'manual'
      },
      records: [],
      exerciseSessions: []
    };
    const updatedProfiles = [...profiles, newProfile];
    setProfiles(updatedProfiles);
    setCurrentProfile(newProfile);
    try {
      localStorage.setItem(STORAGE_KEYS.PROFILES, JSON.stringify(updatedProfiles));
      localStorage.setItem(STORAGE_KEYS.CURRENT_PROFILE, newProfile.id);
    } catch (error) {
      console.error('Error saving profile:', error);
    }
  };

  const selectProfile = (profileId) => {
    const profile = profiles.find(p => p.id === profileId);
    if (profile) {
      setCurrentProfile(profile);
      try {
        localStorage.setItem(STORAGE_KEYS.CURRENT_PROFILE, profileId);
      } catch (error) {
        console.error('Error selecting profile:', error);
      }
    }
  };

  const deleteProfile = (profileId) => {
    const updatedProfiles = profiles.filter(p => p.id !== profileId);
    setProfiles(updatedProfiles);
    
    if (currentProfile?.id === profileId) {
      const newCurrentProfile = updatedProfiles[0] || null;
      setCurrentProfile(newCurrentProfile);
      try {
        localStorage.setItem(STORAGE_KEYS.CURRENT_PROFILE, newCurrentProfile?.id || '');
      } catch (error) {
        console.error('Error updating current profile:', error);
      }
    }
    
    try {
      localStorage.setItem(STORAGE_KEYS.PROFILES, JSON.stringify(updatedProfiles));
    } catch (error) {
      console.error('Error deleting profile:', error);
    }
  };

  const updateSettings = (newSettings) => {
    if (!currentProfile) return;
    const updatedProfile = {
      ...currentProfile,
      settings: newSettings
    };
    setCurrentProfile(updatedProfile);
    const updatedProfiles = profiles.map(p => 
      p.id === currentProfile.id ? updatedProfile : p
    );
    setProfiles(updatedProfiles);
  };

  const addRecord = (record) => {
    if (!currentProfile) return;
    const updatedRecords = [...(currentProfile.records || []), record];
    const updatedProfile = {
      ...currentProfile,
      records: updatedRecords
    };
    setCurrentProfile(updatedProfile);
    const updatedProfiles = profiles.map(p => 
      p.id === currentProfile.id ? updatedProfile : p
    );
    setProfiles(updatedProfiles);
  };

  const updateRecord = (record) => {
    if (!currentProfile) return;
    const updatedRecords = (currentProfile.records || []).map(r => 
      r.id === record.id ? record : r
    );
    const updatedProfile = {
      ...currentProfile,
      records: updatedRecords
    };
    setCurrentProfile(updatedProfile);
    const updatedProfiles = profiles.map(p => 
      p.id === currentProfile.id ? updatedProfile : p
    );
    setProfiles(updatedProfiles);
  };

  const deleteRecord = (id) => {
    if (!currentProfile) return;
    if (confirm('이 기록을 삭제하시겠습니까?')) {
      const updatedRecords = (currentProfile.records || []).filter(r => r.id !== id);
      const updatedProfile = {
        ...currentProfile,
        records: updatedRecords
      };
      setCurrentProfile(updatedProfile);
      const updatedProfiles = profiles.map(p => 
        p.id === currentProfile.id ? updatedProfile : p
      );
      setProfiles(updatedProfiles);
    }
  };

  const addExerciseSession = (session) => {
    if (!currentProfile) return;
    const updatedSessions = [...(currentProfile.exerciseSessions || []), session];
    const updatedProfile = {
      ...currentProfile,
      exerciseSessions: updatedSessions
    };
    setCurrentProfile(updatedProfile);
    const updatedProfiles = profiles.map(p => 
      p.id === currentProfile.id ? updatedProfile : p
    );
    setProfiles(updatedProfiles);
  };

  const updateExerciseSession = (session) => {
    if (!currentProfile) return;
    const updatedSessions = (currentProfile.exerciseSessions || []).map(s => 
      s.id === session.id ? session : s
    );
    const updatedProfile = {
      ...currentProfile,
      exerciseSessions: updatedSessions
    };
    setCurrentProfile(updatedProfile);
    const updatedProfiles = profiles.map(p => 
      p.id === currentProfile.id ? updatedProfile : p
    );
    setProfiles(updatedProfiles);
  };

  const deleteExerciseSession = (id) => {
    if (!currentProfile) return;
    if (confirm('이 운동 세션을 삭제하시겠습니까?')) {
      const updatedSessions = (currentProfile.exerciseSessions || []).filter(s => s.id !== id);
      const updatedProfile = {
        ...currentProfile,
        exerciseSessions: updatedSessions
      };
      setCurrentProfile(updatedProfile);
      const updatedProfiles = profiles.map(p => 
        p.id === currentProfile.id ? updatedProfile : p
      );
      setProfiles(updatedProfiles);
    }
  };

  const exportData = () => {
    if (!currentProfile) return;
    const dataStr = JSON.stringify(currentProfile, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `diabetes-${currentProfile.name}-${new Date().toISOString().split('T')[0]}.json`;
    link.click();
  };

  const importData = (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        const data = JSON.parse(event.target.result);
        
        if (!data.settings || !Array.isArray(data.records)) {
          alert('올바른 데이터 파일이 아닙니다.');
          return;
        }

        const importedProfile = {
          id: Date.now().toString(),
          name: data.name || `가져온 프로필 ${new Date().toLocaleString('ko-KR')}`,
          createdAt: new Date().toISOString(),
          settings: data.settings,
          records: data.records,
          exerciseSessions: data.exerciseSessions || []
        };

        const updatedProfiles = [...profiles, importedProfile];
        setProfiles(updatedProfiles);
        setCurrentProfile(importedProfile);
        
        try {
          localStorage.setItem(STORAGE_KEYS.PROFILES, JSON.stringify(updatedProfiles));
          localStorage.setItem(STORAGE_KEYS.CURRENT_PROFILE, importedProfile.id);
        } catch (error) {
          console.error('Error saving imported profile:', error);
        }
        
        alert('데이터를 성공적으로 가져왔습니다!');
      } catch (error) {
        console.error('Import error:', error);
        alert('파일을 읽는데 실패했습니다.');
      }
    };
    reader.readAsText(file);
  };

  if (!disclaimerAccepted) {
    return <DisclaimerModal onAccept={handleDisclaimerAccept} />;
  }

  if (!currentProfile) {
    return (
      <ProfileModal
        profiles={profiles}
        currentProfile={null}
        onSelectProfile={selectProfile}
        onCreateProfile={createProfile}
        onDeleteProfile={deleteProfile}
        onClose={() => {}}
      />
    );
  }

  const records = currentProfile.records || [];
  const exerciseSessions = currentProfile.exerciseSessions || [];
  const settings = currentProfile.settings || { icr: 10, isf: 50, targetBG: 120, cgmMode: 'manual' };

  const chartData = records
    .filter(r => r.bloodSugar && !isNaN(parseFloat(r.bloodSugar)))
    .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))
    .map(r => ({
      time: new Date(r.timestamp).toLocaleString('ko-KR', { 
        month: 'numeric', 
        day: 'numeric', 
        hour: '2-digit', 
        minute: '2-digit' 
      }),
      혈당: parseFloat(r.bloodSugar)
    }));

  const latestBG = records
    .filter(r => r.bloodSugar)
    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];

  const todayRecords = records.filter(r => {
    const recordDate = new Date(r.timestamp).toDateString();
    const today = new Date().toDateString();
    return recordDate === today;
  });

  const weekRecords = records.filter(r => {
    const recordDate = new Date(r.timestamp);
    const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
    return recordDate > weekAgo && r.bloodSugar;
  });

  const avgBG = weekRecords.length > 0
    ? Math.round(weekRecords.reduce((sum, r) => sum + parseFloat(r.bloodSugar), 0) / weekRecords.length)
    : null;

  const activeExercise = exerciseSessions.find(s => s.status === 'active');

  return (
    <div className="min-h-screen bg-gray-50">
      <header className="bg-blue-600 text-white p-4 shadow-lg">
        <div className="max-w-6xl mx-auto flex items-center justify-between">
          <div>
            <h1 className="text-2xl font-bold">1형 당뇨 관리</h1>
            <p className="text-sm text-blue-100">프로필: {currentProfile.name}</p>
          </div>
          <div className="flex gap-2">
            <button
              onClick={() => setShowProfileModal(true)}
              className="p-2 hover:bg-blue-700 rounded"
              title="프로필 변경"
            >
              <User size={24} />
            </button>
            <button
              onClick={() => setShowSettings(true)}
              className="p-2 hover:bg-blue-700 rounded"
              title="설정"
            >
              <Settings size={24} />
            </button>
            <button
              onClick={exportData}
              className="p-2 hover:bg-blue-700 rounded"
              title="데이터 내보내기"
            >
              <Download size={24} />
            </button>
            <label className="p-2 hover:bg-blue-700 rounded cursor-pointer" title="데이터 가져오기">
              <Upload size={24} />
              <input type="file" accept=".json" onChange={importData} className="hidden" />
            </label>
          </div>
        </div>
      </header>

      <div className="bg-white shadow">
        <div className="max-w-6xl mx-auto flex">
          <button
            onClick={() => setCurrentTab('dashboard')}
            className={`flex-1 py-3 font-medium ${currentTab === 'dashboard' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'}`}
          >
            대시보드
          </button>
          <button
            onClick={() => setCurrentTab('records')}
            className={`flex-1 py-3 font-medium ${currentTab === 'records' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'}`}
          >
            기록 관리
          </button>
          <button
            onClick={() => setCurrentTab('exercise')}
            className={`flex-1 py-3 font-medium ${currentTab === 'exercise' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'}`}
          >
            운동 추적
          </button>
        </div>
      </div>

      <main className="max-w-6xl mx-auto p-4 space-y-4">
        {currentTab === 'dashboard' && (
          <>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div className="bg-white rounded-lg shadow p-4">
                <div className="flex items-center gap-2 text-gray-600 mb-2">
                  <Activity size={20} />
                  <span className="text-sm font-medium">최근 혈당</span>
                </div>
                <div className={`text-3xl font-bold ${
                  latestBG 
                    ? parseFloat(latestBG.bloodSugar) < 70 
                      ? 'text-red-600' 
                      : parseFloat(latestBG.bloodSugar) > 180 
                        ? 'text-orange-600' 
                        : 'text-green-600'
                    : 'text-gray-400'
                }`}>
                  {latestBG ? `${latestBG.bloodSugar} mg/dL` : '기록 없음'}
                </div>
                {latestBG && (
                  <p className="text-xs text-gray-500 mt-1">
                    {new Date(latestBG.timestamp).toLocaleString('ko-KR')}
                  </p>
                )}
              </div>

              <div className="bg-white rounded-lg shadow p-4">
                <div className="flex items-center gap-2 text-gray-600 mb-2">
                  <Calendar size={20} />
                  <span className="text-sm font-medium">오늘 기록</span>
                </div>
                <div className="text-3xl font-bold text-blue-600">
                  {todayRecords.length}건
                </div>
              </div>

              <div className="bg-white rounded-lg shadow p-4">
                <div className="flex items-center gap-2 text-gray-600 mb-2">
                  <Apple size={20} />
                  <span className="text-sm font-medium">평균 혈당 (7일)</span>
                </div>
                <div className="text-3xl font-bold text-purple-600">
                  {avgBG ? `${avgBG} mg/dL` : '—'}
                </div>
              </div>
            </div>

            {activeExercise && (
              <div className="bg-purple-50 border border-purple-300 rounded-lg p-4">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    <Play size={20} className="text-purple-600" />
                    <span className="font-semibold">운동 진행 중: {activeExercise.type}</span>
                    <span className="text-sm text-gray-600">
                      (시작: {new Date(activeExercise.startTime).toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'})})
                    </span>
                  </div>
                  <button
                    onClick={() => {
                      setEditingSession(activeExercise);
                      setShowExerciseModal(true);
                    }}
                    className="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700"
                  >
                    세션 열기
                  </button>
                </div>
              </div>
            )}

            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <button
                onClick={() => setShowRecordModal(true)}
                className="bg-blue-600 text-white p-4 rounded-lg font-semibold hover:bg-blue-700 flex items-center justify-center gap-2"
              >
                <Plus size={24} />
                혈당 기록 추가
              </button>
              <button
                onClick={() => setShowCalculator(true)}
                className="bg-green-600 text-white p-4 rounded-lg font-semibold hover:bg-green-700 flex items-center justify-center gap-2"
              >
                <Apple size={24} />
                인슐린 계산기
              </button>
              <button
                onClick={() => {
                  setEditingSession(null);
                  setShowExerciseModal(true);
                }}
                className="bg-purple-600 text-white p-4 rounded-lg font-semibold hover:bg-purple-700 flex items-center justify-center gap-2"
              >
                <Dumbbell size={24} />
                운동 시작
              </button>
            </div>

            {chartData.length > 0 && (
              <div className="bg-white rounded-lg shadow p-4">
                <h2 className="text-lg font-bold mb-4">혈당 추이 (최근 20개)</h2>
                <ResponsiveContainer width="100%" height={300}>
                  <LineChart data={chartData.slice(-20)}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="time" tick={{ fontSize: 12 }} angle={-45} textAnchor="end" height={80} />
                    <YAxis domain={[0, 300]} />
                    <Tooltip />
                    <Legend />
                    <Line type="monotone" dataKey="혈당" stroke="#3b82f6" strokeWidth={2} dot={{ r: 4 }} />
                  </LineChart>
                </ResponsiveContainer>
                <div className="mt-2 flex gap-4 text-xs justify-center">
                  <div className="flex items-center gap-1">
                    <div className="w-3 h-3 bg-green-500 rounded" />
                    <span>정상 (70-180)</span>
                  </div>
                  <div className="flex items-center gap-1">
                    <div className="w-3 h-3 bg-red-500 rounded" />
                    <span>저혈당 (&lt;70)</span>
                  </div>
                  <div className="flex items-center gap-1">
                    <div className="w-3 h-3 bg-orange-500 rounded" />
                    <span>고혈당 (&gt;180)</span>
                  </div>
                </div>
              </div>
            )}

            <div className="bg-white rounded-lg shadow p-4">
              <h2 className="text-lg font-bold mb-4">최근 기록</h2>
              {records.length === 0 ? (
                <p className="text-gray-500 text-center py-8">기록이 없습니다. 첫 기록을 추가해보세요!</p>
              ) : (
                <div className="space-y-2">
                  {records
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                    .slice(0, 5)
                    .map(record => (
                      <div key={record.id} className="border rounded p-3 hover:bg-gray-50">
                        <div className="flex items-start justify-between">
                          <div className="flex-1">
                            <div className="flex items-center gap-2 mb-1 flex-wrap">
                              <span className="text-sm text-gray-600">
                                {new Date(record.timestamp).toLocaleString('ko-KR')}
                              </span>
                              {record.bloodSugar && (
                                <span className={`font-semibold ${
                                  parseFloat(record.bloodSugar) < 70 
                                    ? 'text-red-600' 
                                    : parseFloat(record.bloodSugar) > 180 
                                      ? 'text-orange-600' 
                                      : 'text-green-600'
                                }`}>
                                  {record.bloodSugar} mg/dL
                                </span>
                              )}
                              {record.insulin && (
                                <span className="text-blue-600 font-medium">인슐린 {record.insulin}U</span>
                              )}
                            </div>
                            {record.food && <p className="text-sm">🍽️ {record.food}</p>}
                            {record.exercise && <p className="text-sm">💪 {record.exercise}</p>}
                            {record.note && <p className="text-sm text-gray-600">📝 {record.note}</p>}
                          </div>
                          <div className="flex gap-1">
                            <button
                              onClick={() => {
                                setEditingRecord(record);
                                setShowRecordModal(true);
                              }}
                              className="p-1 text-gray-600 hover:text-blue-600"
                            >
                              <Edit2 size={16} />
                            </button>
                            <button
                              onClick={() => deleteRecord(record.id)}
                              className="p-1 text-gray-600 hover:text-red-600"
                            >
                              <Trash2 size={16} />
                            </button>
                          </div>
                        </div>
                      </div>
                    ))}
                </div>
              )}
            </div>
          </>
        )}

        {currentTab === 'records' && (
          <div className="bg-white rounded-lg shadow p-4">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-lg font-bold">전체 기록 ({records.length}건)</h2>
              <button
                onClick={() => setShowRecordModal(true)}
                className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 flex items-center gap-2"
              >
                <Plus size={18} />
                추가
              </button>
            </div>
            {records.length === 0 ? (
              <p className="text-gray-500 text-center py-8">기록이 없습니다.</p>
            ) : (
              <div className="space-y-2 max-h-96 overflow-y-auto">
                {records
                  .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                  .map(record => (
                    <div key={record.id} className="border rounded p-3 hover:bg-gray-50">
                      <div className="flex items-start justify-between">
                        <div className="flex-1">
                          <div className="flex items-center gap-2 mb-1 flex-wrap">
                            <span className="text-sm text-gray-600">
                              {new Date(record.timestamp).toLocaleString('ko-KR')}
                            </span>
                            {record.bloodSugar && (
                              <span className={`font-semibold ${
                                parseFloat(record.bloodSugar) < 70 
                                  ? 'text-red-600' 
                                  : parseFloat(record.bloodSugar) > 180 
                                    ? 'text-orange-600' 
                                    : 'text-green-600'
                              }`}>
                                {record.bloodSugar} mg/dL
                              </span>
                            )}
                            {record.insulin && (
                              <span className="text-blue-600 font-medium">인슐린 {record.insulin}U</span>
                            )}
                          </div>
                          {record.food && <p className="text-sm">🍽️ {record.food}</p>}
                          {record.exercise && <p className="text-sm">💪 {record.exercise}</p>}
                          {record.note && <p className="text-sm text-gray-600">📝 {record.note}</p>}
                        </div>
                        <div className="flex gap-1">
                          <button
                            onClick={() => {
                              setEditingRecord(record);
                              setShowRecordModal(true);
                            }}
                            className="p-1 text-gray-600 hover:text-blue-600"
                          >
                            <Edit2 size={16} />
                          </button>
                          <button
                            onClick={() => deleteRecord(record.id)}
                            className="p-1 text-gray-600 hover:text-red-600"
                          >
                            <Trash2 size={16} />
                          </button>
                        </div>
                      </div>
                    </div>
                  ))}
              </div>
            )}
          </div>
        )}

        {currentTab === 'exercise' && (
          <div className="bg-white rounded-lg shadow p-4">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-lg font-bold">운동 세션 ({exerciseSessions.length}건)</h2>
              <button
                onClick={() => {
                  setEditingSession(null);
                  setShowExerciseModal(true);
                }}
                className="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 flex items-center gap-2"
              >
                <Plus size={18} />
                새 세션
              </button>
            </div>

            {exerciseSessions.length === 0 ? (
              <p className="text-gray-500 text-center py-8">운동 세션이 없습니다. 첫 운동을 시작해보세요!</p>
            ) : (
              <div className="space-y-3">
                {exerciseSessions
                  .sort((a, b) => new Date(b.startTime) - new Date(a.startTime))
                  .map(session => (
                    <div key={session.id} className="border rounded p-4 hover:bg-gray-50">
                      <div className="flex items-start justify-between">
                        <div className="flex-1">
                          <div className="flex items-center gap-2 mb-2">
                            <Dumbbell size={18} className="text-purple-600" />
                            <span className="font-semibold">{session.type}</span>
                            <span className="text-sm text-gray-600">({session.intensity})</span>
                            {session.status === 'active' && (
                              <span className="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">진행중</span>
                            )}
                          </div>
                          <div className="text-sm text-gray-600 mb-2">
                            <Clock size={14} className="inline mr-1" />
                            {new Date(session.startTime).toLocaleString('ko-KR')}
                            {session.endTime && ` ~ ${new Date(session.endTime).toLocaleString('ko-KR')}`}
                          </div>
                          
                          {session.bgRecords && session.bgRecords.length > 0 && (
                            <div className="mt-2 bg-purple-50 rounded p-2">
                              <p className="text-xs font-medium text-gray-700 mb-1">혈당 변화</p>
                              <div className="flex gap-2 flex-wrap">
                                {session.bgRecords.map((bg, idx) => (
                                  <span key={idx} className="text-xs bg-white px-2 py-1 rounded">
                                    {bg.label}: <span className={`font-semibold ${
                                      parseFloat(bg.value) < 70 ? 'text-red-600' :
                                      parseFloat(bg.value) > 180 ? 'text-orange-600' : 'text-green-600'
                                    }`}>{bg.value}</span>
                                  </span>
                                ))}
                              </div>
                            </div>
                          )}
                          
                          {session.note && (
                            <p className="text-sm text-gray-600 mt-2">📝 {session.note}</p>
                          )}
                        </div>
                        <div className="flex gap-1">
                          <button
                            onClick={() => {
                              setEditingSession(session);
                              setShowExerciseModal(true);
                            }}
                            className="p-1 text-gray-600 hover:text-blue-600"
                          >
                            <Edit2 size={16} />
                          </button>
                          <button
                            onClick={() => deleteExerciseSession(session.id)}
                            className="p-1 text-gray-600 hover:text-red-600"
                          >
                            <Trash2 size={16} />
                          </button>
                        </div>
                      </div>
                    </div>
                  ))}
              </div>
            )}
          </div>
        )}
      </main>

      {showProfileModal && (
        <ProfileModal
          profiles={profiles}
          currentProfile={currentProfile}
          onSelectProfile={selectProfile}
          onCreateProfile={createProfile}
          onDeleteProfile={deleteProfile}
          onClose={() => setShowProfileModal(false)}
        />
      )}

      {showSettings && (
        <SettingsModal
          settings={settings}
          onSave={updateSettings}
          onClose={() => setShowSettings(false)}
        />
      )}

      {showRecordModal && (
        <RecordModal
          record={editingRecord}
          onSave={(record) => {
            if (editingRecord) {
              updateRecord(record);
            } else {
              addRecord(record);
            }
            setEditingRecord(null);
          }}
          onClose={() => {
            setShowRecordModal(false);
            setEditingRecord(null);
          }}
        />
      )}

      {showCalculator && (
        <InsulinCalculatorModal
          settings={settings}
          onClose={() => setShowCalculator(false)}
          onSaveRecord={addRecord}
        />
      )}

      {showExerciseModal && (
        <ExerciseSessionModal
          session={editingSession}
          onSave={(session) => {
            if (editingSession) {
              updateExerciseSession(session);
            } else {
              addExerciseSession(session);
            }
            setEditingSession(null);
          }}
          onClose={() => {
            setShowExerciseModal(false);
            setEditingSession(null);
          }}
          onQuickBGRecord={addRecord}
        />
      )}

      <footer className="mt-8 py-4 text-center text-sm text-gray-500 bg-white">
        <p>본 애플리케이션은 의료 전문가의 조언을 대체할 수 없습니다.</p>
        <p className="mt-1">대한당뇨병학회 및 보건복지부 지침을 참고하여 제작되었습니다.</p>
      </footer>
    </div>
  );
}
