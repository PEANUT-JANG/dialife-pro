import React, { useState, useEffect } from 'react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';
import { Plus, Settings, Download, Upload, Activity, Apple, Calendar, AlertCircle, Check, Edit2, Trash2, X, User, LogOut } from 'lucide-react';

// ë¡œì»¬ìŠ¤í† ë¦¬ì§€ í‚¤
const STORAGE_KEYS = {
  PROFILES: 'diabetes_app_profiles',
  CURRENT_PROFILE: 'diabetes_app_current_profile',
  DISCLAIMER: 'diabetes_app_disclaimer_accepted'
};

// ì˜ë£Œ ë©´ì±…ì¡°í•­ ëª¨ë‹¬
const DisclaimerModal = ({ onAccept }) => (
  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div className="bg-white rounded-lg max-w-2xl w-full p-6 max-h-screen overflow-y-auto">
      <div className="flex items-center gap-2 text-red-600 mb-4">
        <AlertCircle size={24} />
        <h2 className="text-xl font-bold">ì˜ë£Œ ë©´ì±…ì¡°í•­</h2>
      </div>
      <div className="space-y-4 text-sm text-gray-700">
        <p className="font-semibold">ë³¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‚¬ìš©í•˜ê¸° ì „ì— ë°˜ë“œì‹œ ì½ì–´ì£¼ì„¸ìš”:</p>
        <ul className="list-disc pl-5 space-y-2">
          <li>ë³¸ ì•±ì€ 1í˜• ë‹¹ë‡¨ë³‘ ê´€ë¦¬ë¥¼ ë•ê¸° ìœ„í•œ <strong>ë³´ì¡° ë„êµ¬</strong>ì´ë©°, ì˜ë£Œ ì „ë¬¸ê°€ì˜ ì§„ë‹¨ì´ë‚˜ ì²˜ë°©ì„ ëŒ€ì²´í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</li>
          <li>ì¸ìŠë¦° íˆ¬ì—¬ëŸ‰ ê³„ì‚°ì€ <strong>ì°¸ê³ ìš©</strong>ì´ë©°, ì‹¤ì œ íˆ¬ì—¬ ì „ ë°˜ë“œì‹œ ì£¼ì¹˜ì˜ì™€ ìƒë‹´í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.</li>
          <li>ë³¸ ì•±ì€ ëŒ€í•œë‹¹ë‡¨ë³‘í•™íšŒ ë° ë³´ê±´ë³µì§€ë¶€ ì§€ì¹¨ì„ ì°¸ê³ í•˜ì—¬ ì œì‘ë˜ì—ˆìœ¼ë‚˜, ê°œì¸ë³„ ìƒí™©ì— ë”°ë¼ ì ìš©ì´ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
          <li>ì‘ê¸‰ ìƒí™©(ì‹¬í•œ ì €í˜ˆë‹¹/ê³ í˜ˆë‹¹)ì‹œ ì¦‰ì‹œ ì˜ë£Œê¸°ê´€ì„ ë°©ë¬¸í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.</li>
          <li>ë³¸ ì•± ì‚¬ìš©ìœ¼ë¡œ ì¸í•œ ì–´ë– í•œ ì˜ë£Œì  ê²°ê³¼ì— ëŒ€í•´ì„œë„ ê°œë°œìëŠ” ì±…ì„ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
          <li>ëª¨ë“  ë°ì´í„°ëŠ” ê·€í•˜ì˜ ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë˜ë©°, ì™¸ë¶€ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
        </ul>
        <p className="font-semibold text-red-600">ìœ„ ë‚´ìš©ì„ ì´í•´í•˜ê³  ë™ì˜í•˜ì‹œë©´ 'ë™ì˜í•˜ê³  ì‹œì‘í•˜ê¸°' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
      </div>
      <button
        onClick={onAccept}
        className="w-full mt-6 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700"
      >
        ë™ì˜í•˜ê³  ì‹œì‘í•˜ê¸°
      </button>
    </div>
  </div>
);

// í”„ë¡œí•„ ì„ íƒ/ìƒì„± ëª¨ë‹¬
const ProfileModal = ({ profiles, currentProfile, onSelectProfile, onCreateProfile, onDeleteProfile, onClose }) => {
  const [newProfileName, setNewProfileName] = useState('');
  const [isCreating, setIsCreating] = useState(false);

  const handleCreate = () => {
    if (!newProfileName.trim()) {
      alert('í”„ë¡œí•„ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    if (profiles.some(p => p.name === newProfileName.trim())) {
      alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í”„ë¡œí•„ ì´ë¦„ì…ë‹ˆë‹¤.');
      return;
    }
    onCreateProfile(newProfileName.trim());
    setNewProfileName('');
    setIsCreating(false);
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg max-w-md w-full p-6">
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-xl font-bold flex items-center gap-2">
            <User size={24} />
            í”„ë¡œí•„ ê´€ë¦¬
          </h2>
          {currentProfile && (
            <button onClick={onClose} className="text-gray-500 hover:text-gray-700">
              <X size={24} />
            </button>
          )}
        </div>

        <div className="space-y-3 mb-4 max-h-64 overflow-y-auto">
          {profiles.map(profile => (
            <div
              key={profile.id}
              className={`border rounded p-3 flex items-center justify-between ${
                currentProfile?.id === profile.id ? 'border-blue-500 bg-blue-50' : 'hover:bg-gray-50'
              }`}
            >
              <div className="flex-1">
                <p className="font-medium">{profile.name}</p>
                <p className="text-xs text-gray-500">
                  ê¸°ë¡ {profile.records?.length || 0}ê±´ Â· 
                  ìƒì„±ì¼ {new Date(profile.createdAt).toLocaleDateString('ko-KR')}
                </p>
              </div>
              <div className="flex gap-2">
                {currentProfile?.id !== profile.id && (
                  <button
                    onClick={() => onSelectProfile(profile.id)}
                    className="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700"
                  >
                    ì„ íƒ
                  </button>
                )}
                {profiles.length > 1 && (
                  <button
                    onClick={() => {
                      if (confirm(`"${profile.name}" í”„ë¡œí•„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  ë°ì´í„°ê°€ ì˜êµ¬ ì‚­ì œë©ë‹ˆë‹¤.`)) {
                        onDeleteProfile(profile.id);
                      }
                    }}
                    className="p-1 text-red-600 hover:bg-red-50 rounded"
                  >
                    <Trash2 size={16} />
                  </button>
                )}
              </div>
            </div>
          ))}
        </div>

        {isCreating ? (
          <div className="space-y-2">
            <input
              type="text"
              value={newProfileName}
              onChange={(e) => setNewProfileName(e.target.value)}
              placeholder="ìƒˆ í”„ë¡œí•„ ì´ë¦„"
              className="w-full border rounded px-3 py-2"
              onKeyPress={(e) => e.key === 'Enter' && handleCreate()}
              autoFocus
            />
            <div className="flex gap-2">
              <button
                onClick={handleCreate}
                className="flex-1 bg-green-600 text-white py-2 rounded hover:bg-green-700"
              >
                ìƒì„±
              </button>
              <button
                onClick={() => {
                  setIsCreating(false);
                  setNewProfileName('');
                }}
                className="flex-1 bg-gray-300 text-gray-700 py-2 rounded hover:bg-gray-400"
              >
                ì·¨ì†Œ
              </button>
            </div>
          </div>
        ) : (
          <button
            onClick={() => setIsCreating(true)}
            className="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 flex items-center justify-center gap-2"
          >
            <Plus size={18} />
            ìƒˆ í”„ë¡œí•„ ë§Œë“¤ê¸°
          </button>
        )}
      </div>
    </div>
  );
};

// ì„¤ì • ëª¨ë‹¬
const SettingsModal = ({ settings, onSave, onClose }) => {
  const [localSettings, setLocalSettings] = useState(settings);

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg max-w-md w-full p-6">
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-xl font-bold">ì„¤ì •</h2>
          <button onClick={onClose} className="text-gray-500 hover:text-gray-700">
            <X size={24} />
          </button>
        </div>
        
        <div className="space-y-4">
          <div>
            <label className="block text-sm font-medium mb-1">ì¸ìŠë¦°-íƒ„ìˆ˜í™”ë¬¼ ë¹„ìœ¨ (ICR)</label>
            <input
              type="number"
              value={localSettings.icr}
              onChange={(e) => setLocalSettings({...localSettings, icr: parseFloat(e.target.value) || 10})}
              className="w-full border rounded px-3 py-2"
              step="0.5"
              min="1"
            />
            <p className="text-xs text-gray-500 mt-1">1ë‹¨ìœ„ ì¸ìŠë¦°ì´ ì²˜ë¦¬í•˜ëŠ” íƒ„ìˆ˜í™”ë¬¼(g)</p>
          </div>

          <div>
            <label className="block text-sm font-medium mb-1">ì¸ìŠë¦° ë¯¼ê°ë„ ê³„ìˆ˜ (ISF)</label>
            <input
              type="number"
              value={localSettings.isf}
              onChange={(e) => setLocalSettings({...localSettings, isf: parseFloat(e.target.value) || 50})}
              className="w-full border rounded px-3 py-2"
              min="1"
            />
            <p className="text-xs text-gray-500 mt-1">1ë‹¨ìœ„ ì¸ìŠë¦°ìœ¼ë¡œ ë‚®ì¶œ ìˆ˜ ìˆëŠ” í˜ˆë‹¹(mg/dL)</p>
          </div>

          <div>
            <label className="block text-sm font-medium mb-1">ëª©í‘œ í˜ˆë‹¹ (mg/dL)</label>
            <input
              type="number"
              value={localSettings.targetBG}
              onChange={(e) => setLocalSettings({...localSettings, targetBG: parseFloat(e.target.value) || 120})}
              className="w-full border rounded px-3 py-2"
              min="70"
              max="180"
            />
          </div>

          <div>
            <label className="block text-sm font-medium mb-1">CGM ë°ì´í„° ì…ë ¥ ë°©ì‹</label>
            <select
              value={localSettings.cgmMode}
              onChange={(e) => setLocalSettings({...localSettings, cgmMode: e.target.value})}
              className="w-full border rounded px-3 py-2"
            >
              <option value="manual">ìˆ˜ë™ ì…ë ¥</option>
              <option value="import">íŒŒì¼ ê°€ì ¸ì˜¤ê¸°</option>
              <option value="api">CGM ì—°ë™ (ì¤€ë¹„ì¤‘)</option>
            </select>
          </div>

          <button
            onClick={() => {
              onSave(localSettings);
              onClose();
            }}
            className="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700"
          >
            ì €ì¥
          </button>
        </div>
      </div>
    </div>
  );
};

// í˜ˆë‹¹ ê¸°ë¡ ì…ë ¥/ìˆ˜ì • ëª¨ë‹¬
const RecordModal = ({ record, onSave, onClose }) => {
  const [localRecord, setLocalRecord] = useState(record || {
    id: Date.now(),
    timestamp: new Date().toISOString().slice(0, 16),
    bloodSugar: '',
    insulin: '',
    food: '',
    exercise: '',
    note: ''
  });

  const handleSave = () => {
    // ìœ íš¨ì„± ê²€ì‚¬
    if (!localRecord.timestamp) {
      alert('ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    if (!localRecord.bloodSugar && !localRecord.insulin && !localRecord.food && !localRecord.exercise) {
      alert('ìµœì†Œ í•˜ë‚˜ ì´ìƒì˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    onSave(localRecord);
    onClose();
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg max-w-md w-full p-6 max-h-screen overflow-y-auto">
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-xl font-bold">{record ? 'ê¸°ë¡ ìˆ˜ì •' : 'í˜ˆë‹¹ ê¸°ë¡ ì¶”ê°€'}</h2>
          <button onClick={onClose} className="text-gray-500 hover:text-gray-700">
            <X size={24} />
          </button>
        </div>

        <div className="space-y-4">
          <div>
            <label className="block text-sm font-medium mb-1">ì‹œê°„</label>
            <input
              type="datetime-local"
              value={localRecord.timestamp}
              onChange={(e) => setLocalRecord({...localRecord, timestamp: e.target.value})}
              className="w-full border rounded px-3 py-2"
            />
          </div>

          <div>
            <label className="block text-sm font-medium mb-1">í˜ˆë‹¹ (mg/dL)</label>
            <input
              type="number"
              value={localRecord.bloodSugar}
              onChange={(e) => setLocalRecord({...localRecord, bloodSugar: e.target.value})}
              className="w-full border rounded px-3 py-2"
              placeholder="ì˜ˆ: 120"
              min="0"
              max="600"
            />
          </div>

          <div>
            <label className="block text-sm font-medium mb-1">ì¸ìŠë¦° íˆ¬ì—¬ëŸ‰ (ë‹¨ìœ„)</label>
            <input
              type="number"
              value={localRecord.insulin}
              onChange={(e) => setLocalRecord({...localRecord, insulin: e.target.value})}
              className="w-full border rounded px-3 py-2"
              placeholder="ì˜ˆ: 4"
              step="0.5"
              min="0"
            />
          </div>

          <div>
            <label className="block text-sm font-medium mb-1">ìŒì‹</label>
            <input
              type="text"
              value={localRecord.food}
              onChange={(e) => setLocalRecord({...localRecord, food: e.target.value})}
              className="w-full border rounded px-3 py-2"
              placeholder="ì˜ˆ: ì½©ë‚˜ë¬¼ë°¥, ë¯¸ì—­êµ­, ëˆê¹ŒìŠ¤"
            />
          </div>

          <div>
            <label className="block text-sm font-medium mb-1">ìš´ë™</label>
            <input
              type="text"
              value={localRecord.exercise}
              onChange={(e) => setLocalRecord({...localRecord, exercise: e.target.value})}
              className="w-full border rounded px-3 py-2"
              placeholder="ì˜ˆ: í—¬ìŠ¤ 1ì‹œê°„"
            />
          </div>

          <div>
            <label className="block text-sm font-medium mb-1">ë©”ëª¨</label>
            <textarea
              value={localRecord.note}
              onChange={(e) => setLocalRecord({...localRecord, note: e.target.value})}
              className="w-full border rounded px-3 py-2"
              rows="3"
              placeholder="ê¸°íƒ€ ë©”ëª¨ì‚¬í•­"
            />
          </div>

          <button
            onClick={handleSave}
            className="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700"
          >
            ì €ì¥
          </button>
        </div>
      </div>
    </div>
  );
};

// ì¸ìŠë¦° ê³„ì‚°ê¸° ëª¨ë‹¬
const InsulinCalculatorModal = ({ settings, onClose, onSaveRecord }) => {
  const [currentBG, setCurrentBG] = useState('');
  const [foodName, setFoodName] = useState('');
  const [carbs, setCarbs] = useState('');
  const [isSearching, setIsSearching] = useState(false);
  const [calculatedInsulin, setCalculatedInsulin] = useState(null);
  const [nutritionInfo, setNutritionInfo] = useState(null);

  const searchFood = async () => {
    if (!foodName.trim()) {
      alert('ìŒì‹ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    setIsSearching(true);
    setNutritionInfo(null);
    
    try {
      const response = await fetch("https://api.anthropic.com/v1/messages", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 1000,
          messages: [
            { 
              role: "user", 
              content: `"${foodName}"ì˜ ì˜ì–‘ì„±ë¶„ì„ ì•Œë ¤ì£¼ì„¸ìš”. ë‹¤ìŒ í˜•ì‹ì˜ JSONìœ¼ë¡œë§Œ ì‘ë‹µí•´ì£¼ì„¸ìš”. ë‹¤ë¥¸ í…ìŠ¤íŠ¸ëŠ” í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”:

{
  "foodName": "ìŒì‹ ì´ë¦„",
  "servingSize": "1ì¸ë¶„ ê¸°ì¤€ (ì˜ˆ: 200g)",
  "carbohydrates": íƒ„ìˆ˜í™”ë¬¼(g),
  "protein": ë‹¨ë°±ì§ˆ(g),
  "fat": ì§€ë°©(g),
  "calories": ì¹¼ë¡œë¦¬(kcal),
  "note": "ì¶”ê°€ ì„¤ëª…"
}

ì •í™•í•œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìœ¼ë©´ ì¼ë°˜ì ì¸ ì¶”ì •ì¹˜ë¥¼ ì œê³µí•˜ë˜, note í•„ë“œì— "ì¶”ì •ì¹˜ì…ë‹ˆë‹¤" í‘œì‹œë¥¼ í•´ì£¼ì„¸ìš”.`
            }
          ]
        })
      });

      if (!response.ok) {
        throw new Error(`API ìš”ì²­ ì‹¤íŒ¨: ${response.status}`);
      }

      const data = await response.json();
      let responseText = data.content[0].text;
      responseText = responseText.replace(/```json\n?/g, "").replace(/```\n?/g, "").trim();
      
      const nutrition = JSON.parse(responseText);
      
      // ìœ íš¨ì„± ê²€ì‚¬
      if (!nutrition.carbohydrates || isNaN(nutrition.carbohydrates)) {
        throw new Error('ìœ íš¨í•˜ì§€ ì•Šì€ ì˜ì–‘ì •ë³´ì…ë‹ˆë‹¤.');
      }
      
      setNutritionInfo(nutrition);
      setCarbs(nutrition.carbohydrates.toString());
    } catch (error) {
      console.error("Error searching food:", error);
      alert("ìŒì‹ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. íƒ„ìˆ˜í™”ë¬¼ì„ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    } finally {
      setIsSearching(false);
    }
  };

  const calculateInsulin = () => {
    if (!currentBG || !carbs) {
      alert("í˜„ì¬ í˜ˆë‹¹ê³¼ íƒ„ìˆ˜í™”ë¬¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    const bg = parseFloat(currentBG);
    const carbAmount = parseFloat(carbs);
    
    // ìœ íš¨ì„± ê²€ì‚¬
    if (isNaN(bg) || bg <= 0 || bg > 600) {
      alert('í˜ˆë‹¹ ê°’ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ (1-600 mg/dL).');
      return;
    }
    if (isNaN(carbAmount) || carbAmount < 0) {
      alert('íƒ„ìˆ˜í™”ë¬¼ ê°’ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      return;
    }

    // ì¸ìŠë¦° ê³„ì‚°
    // ICR: ì¸ìŠë¦° 1ë‹¨ìœ„ê°€ ì²˜ë¦¬í•˜ëŠ” íƒ„ìˆ˜í™”ë¬¼(g)
    // ISF: ì¸ìŠë¦° 1ë‹¨ìœ„ë¡œ ë‚®ì¶œ ìˆ˜ ìˆëŠ” í˜ˆë‹¹(mg/dL)
    const carbInsulin = carbAmount / settings.icr;
    const correctionInsulin = (bg - settings.targetBG) / settings.isf;
    const totalInsulin = Math.max(0, carbInsulin + correctionInsulin);

    setCalculatedInsulin({
      carb: carbInsulin.toFixed(1),
      correction: correctionInsulin.toFixed(1),
      total: totalInsulin.toFixed(1),
      rounded: Math.round(totalInsulin * 2) / 2 // 0.5 ë‹¨ìœ„ë¡œ ë°˜ì˜¬ë¦¼
    });
  };

  const saveAsRecord = () => {
    if (!calculatedInsulin) return;
    
    const newRecord = {
      id: Date.now(),
      timestamp: new Date().toISOString().slice(0, 16),
      bloodSugar: currentBG,
      insulin: calculatedInsulin.rounded.toString(),
      food: nutritionInfo ? `${nutritionInfo.foodName} (íƒ„${carbs}g)` : foodName,
      exercise: '',
      note: nutritionInfo ? `${nutritionInfo.servingSize}, ${nutritionInfo.calories}kcal` : ''
    };
    onSaveRecord(newRecord);
    onClose();
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg max-w-lg w-full p-6 max-h-screen overflow-y-auto">
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-xl font-bold flex items-center gap-2">
            <Apple size={24} className="text-green-600" />
            ì¸ìŠë¦° ê³„ì‚°ê¸°
          </h2>
          <button onClick={onClose} className="text-gray-500 hover:text-gray-700">
            <X size={24} />
          </button>
        </div>

        <div className="bg-yellow-50 border border-yellow-200 rounded p-3 mb-4 text-sm">
          <p className="font-medium text-yellow-800">âš ï¸ ê³„ì‚° ê²°ê³¼ëŠ” ì°¸ê³ ìš©ì…ë‹ˆë‹¤</p>
          <p className="text-yellow-700">ì‹¤ì œ ì¸ìŠë¦° íˆ¬ì—¬ ì „ ë°˜ë“œì‹œ ì£¼ì¹˜ì˜ì™€ ìƒë‹´í•˜ì„¸ìš”.</p>
        </div>

        <div className="space-y-4">
          <div>
            <label className="block text-sm font-medium mb-1">í˜„ì¬ í˜ˆë‹¹ (mg/dL) *</label>
            <input
              type="number"
              value={currentBG}
              onChange={(e) => setCurrentBG(e.target.value)}
              className="w-full border rounded px-3 py-2"
              placeholder="ì˜ˆ: 120"
              min="0"
              max="600"
            />
          </div>

          <div>
            <label className="block text-sm font-medium mb-1">ìŒì‹ ì´ë¦„</label>
            <div className="flex gap-2">
              <input
                type="text"
                value={foodName}
                onChange={(e) => setFoodName(e.target.value)}
                className="flex-1 border rounded px-3 py-2"
                placeholder="ì˜ˆ: ì½©ë‚˜ë¬¼ë°¥"
                onKeyPress={(e) => e.key === 'Enter' && searchFood()}
              />
              <button
                onClick={searchFood}
                disabled={isSearching}
                className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 disabled:bg-gray-400"
              >
                {isSearching ? 'ê²€ìƒ‰ì¤‘...' : 'ê²€ìƒ‰'}
              </button>
            </div>
          </div>

          {nutritionInfo && (
            <div className="bg-green-50 border border-green-200 rounded p-4">
              <h3 className="font-semibold mb-2">{nutritionInfo.foodName}</h3>
              <div className="text-sm space-y-1">
                <p>â€¢ ê¸°ì¤€ëŸ‰: {nutritionInfo.servingSize}</p>
                <p>â€¢ íƒ„ìˆ˜í™”ë¬¼: {nutritionInfo.carbohydrates}g</p>
                <p>â€¢ ë‹¨ë°±ì§ˆ: {nutritionInfo.protein}g</p>
                <p>â€¢ ì§€ë°©: {nutritionInfo.fat}g</p>
                <p>â€¢ ì¹¼ë¡œë¦¬: {nutritionInfo.calories}kcal</p>
                {nutritionInfo.note && <p className="text-gray-600 italic">* {nutritionInfo.note}</p>}
              </div>
            </div>
          )}

          <div>
            <label className="block text-sm font-medium mb-1">íƒ„ìˆ˜í™”ë¬¼ (g) *</label>
            <input
              type="number"
              value={carbs}
              onChange={(e) => setCarbs(e.target.value)}
              className="w-full border rounded px-3 py-2"
              placeholder="ì˜ˆ: 60"
              min="0"
              step="0.1"
            />
          </div>

          <button
            onClick={calculateInsulin}
            className="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700"
          >
            ì¸ìŠë¦° ê³„ì‚°í•˜ê¸°
          </button>

          {calculatedInsulin && (
            <div className="bg-blue-50 border border-blue-200 rounded p-4">
              <h3 className="font-semibold mb-2">ê³„ì‚° ê²°ê³¼</h3>
              <div className="space-y-1 text-sm">
                <p>â€¢ íƒ„ìˆ˜í™”ë¬¼ ì²˜ë¦¬: {calculatedInsulin.carb} ë‹¨ìœ„</p>
                <p>â€¢ í˜ˆë‹¹ ë³´ì •: {calculatedInsulin.correction} ë‹¨ìœ„</p>
                <p>â€¢ í•©ê³„: {calculatedInsulin.total} ë‹¨ìœ„</p>
                <p className="text-lg font-bold text-blue-600 mt-2">
                  â†’ ê¶Œì¥ íˆ¬ì—¬ëŸ‰: {calculatedInsulin.rounded} ë‹¨ìœ„
                </p>
              </div>
              <button
                onClick={saveAsRecord}
                className="w-full mt-3 bg-green-600 text-white py-2 rounded hover:bg-green-700 flex items-center justify-center gap-2"
              >
                <Check size={18} />
                ê¸°ë¡ìœ¼ë¡œ ì €ì¥
              </button>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

// ë©”ì¸ ì•±
export default function DiabetesApp() {
  const [disclaimerAccepted, setDisclaimerAccepted] = useState(false);
  const [profiles, setProfiles] = useState([]);
  const [currentProfile, setCurrentProfile] = useState(null);
  const [showProfileModal, setShowProfileModal] = useState(false);
  const [showSettings, setShowSettings] = useState(false);
  const [showRecordModal, setShowRecordModal] = useState(false);
  const [showCalculator, setShowCalculator] = useState(false);
  const [editingRecord, setEditingRecord] = useState(null);
  const [currentTab, setCurrentTab] = useState('dashboard');

  // ì´ˆê¸° ë¡œë“œ
  useEffect(() => {
    try {
      // ë©´ì±…ì¡°í•­ í™•ì¸
      const disclaimerStatus = localStorage.getItem(STORAGE_KEYS.DISCLAIMER);
      if (disclaimerStatus === 'accepted') {
        setDisclaimerAccepted(true);
      }

      // í”„ë¡œí•„ ë¡œë“œ
      const savedProfiles = localStorage.getItem(STORAGE_KEYS.PROFILES);
      if (savedProfiles) {
        const parsedProfiles = JSON.parse(savedProfiles);
        setProfiles(parsedProfiles);

        // í˜„ì¬ í”„ë¡œí•„ ë¡œë“œ
        const currentProfileId = localStorage.getItem(STORAGE_KEYS.CURRENT_PROFILE);
        if (currentProfileId) {
          const profile = parsedProfiles.find(p => p.id === currentProfileId);
          if (profile) {
            setCurrentProfile(profile);
          } else {
            // ì €ì¥ëœ í”„ë¡œí•„ IDê°€ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ì²« ë²ˆì§¸ í”„ë¡œí•„ ì„ íƒ
            setCurrentProfile(parsedProfiles[0]);
            localStorage.setItem(STORAGE_KEYS.CURRENT_PROFILE, parsedProfiles[0].id);
          }
        } else if (parsedProfiles.length > 0) {
          // í˜„ì¬ í”„ë¡œí•„ì´ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ì„ íƒ
          setCurrentProfile(parsedProfiles[0]);
          localStorage.setItem(STORAGE_KEYS.CURRENT_PROFILE, parsedProfiles[0].id);
        }
      } else {
        // ì²« ì‹¤í–‰ ì‹œ ê¸°ë³¸ í”„ë¡œí•„ ìƒì„±
        const defaultProfile = {
          id: Date.now().toString(),
          name: 'ë‚´ í”„ë¡œí•„',
          createdAt: new Date().toISOString(),
          settings: {
            icr: 10,
            isf: 50,
            targetBG: 120,
            cgmMode: 'manual'
          },
          records: []
        };
        setProfiles([defaultProfile]);
        setCurrentProfile(defaultProfile);
        localStorage.setItem(STORAGE_KEYS.PROFILES, JSON.stringify([defaultProfile]));
        localStorage.setItem(STORAGE_KEYS.CURRENT_PROFILE, defaultProfile.id);
      }
    } catch (error) {
      console.error('Error loading from localStorage:', error);
      // localStorage ì˜¤ë¥˜ ì‹œ ê¸°ë³¸ í”„ë¡œí•„ ìƒì„±
      const defaultProfile = {
        id: Date.now().toString(),
        name: 'ë‚´ í”„ë¡œí•„',
        createdAt: new Date().toISOString(),
        settings: {
          icr: 10,
          isf: 50,
          targetBG: 120,
          cgmMode: 'manual'
        },
        records: []
      };
      setProfiles([defaultProfile]);
      setCurrentProfile(defaultProfile);
    }
  }, []);

  // í”„ë¡œí•„ ë³€ê²½ ì‹œ ì €ì¥
  useEffect(() => {
    if (currentProfile && profiles.length > 0) {
      try {
        const updatedProfiles = profiles.map(p => 
          p.id === currentProfile.id ? currentProfile : p
        );
        localStorage.setItem(STORAGE_KEYS.PROFILES, JSON.stringify(updatedProfiles));
        localStorage.setItem(STORAGE_KEYS.CURRENT_PROFILE, currentProfile.id);
      } catch (error) {
        console.error('Error saving to localStorage:', error);
      }
    }
  }, [currentProfile, profiles]);

  const handleDisclaimerAccept = () => {
    setDisclaimerAccepted(true);
    try {
      localStorage.setItem(STORAGE_KEYS.DISCLAIMER, 'accepted');
    } catch (error) {
      console.error('Error saving disclaimer:', error);
    }
  };

  const createProfile = (name) => {
    const newProfile = {
      id: Date.now().toString(),
      name,
      createdAt: new Date().toISOString(),
      settings: {
        icr: 10,
        isf: 50,
        targetBG: 120,
        cgmMode: 'manual'
      },
      records: []
    };
    const updatedProfiles = [...profiles, newProfile];
    setProfiles(updatedProfiles);
    setCurrentProfile(newProfile);
    try {
      localStorage.setItem(STORAGE_KEYS.PROFILES, JSON.stringify(updatedProfiles));
      localStorage.setItem(STORAGE_KEYS.CURRENT_PROFILE, newProfile.id);
    } catch (error) {
      console.error('Error saving profile:', error);
    }
  };

  const selectProfile = (profileId) => {
    const profile = profiles.find(p => p.id === profileId);
    if (profile) {
      setCurrentProfile(profile);
      try {
        localStorage.setItem(STORAGE_KEYS.CURRENT_PROFILE, profileId);
      } catch (error) {
        console.error('Error selecting profile:', error);
      }
    }
  };

  const deleteProfile = (profileId) => {
    const updatedProfiles = profiles.filter(p => p.id !== profileId);
    setProfiles(updatedProfiles);
    
    if (currentProfile?.id === profileId) {
      // ì‚­ì œëœ í”„ë¡œí•„ì´ í˜„ì¬ í”„ë¡œí•„ì´ë©´ ë‹¤ë¥¸ í”„ë¡œí•„ ì„ íƒ
      const newCurrentProfile = updatedProfiles[0] || null;
      setCurrentProfile(newCurrentProfile);
      try {
        localStorage.setItem(STORAGE_KEYS.CURRENT_PROFILE, newCurrentProfile?.id || '');
      } catch (error) {
        console.error('Error updating current profile:', error);
      }
    }
    
    try {
      localStorage.setItem(STORAGE_KEYS.PROFILES, JSON.stringify(updatedProfiles));
    } catch (error) {
      console.error('Error deleting profile:', error);
    }
  };

  const updateSettings = (newSettings) => {
    if (!currentProfile) return;
    const updatedProfile = {
      ...currentProfile,
      settings: newSettings
    };
    setCurrentProfile(updatedProfile);
    const updatedProfiles = profiles.map(p => 
      p.id === currentProfile.id ? updatedProfile : p
    );
    setProfiles(updatedProfiles);
  };

  const addRecord = (record) => {
    if (!currentProfile) return;
    const updatedRecords = [...(currentProfile.records || []), record];
    const updatedProfile = {
      ...currentProfile,
      records: updatedRecords
    };
    setCurrentProfile(updatedProfile);
    const updatedProfiles = profiles.map(p => 
      p.id === currentProfile.id ? updatedProfile : p
    );
    setProfiles(updatedProfiles);
  };

  const updateRecord = (record) => {
    if (!currentProfile) return;
    const updatedRecords = (currentProfile.records || []).map(r => 
      r.id === record.id ? record : r
    );
    const updatedProfile = {
      ...currentProfile,
      records: updatedRecords
    };
    setCurrentProfile(updatedProfile);
    const updatedProfiles = profiles.map(p => 
      p.id === currentProfile.id ? updatedProfile : p
    );
    setProfiles(updatedProfiles);
  };

  const deleteRecord = (id) => {
    if (!currentProfile) return;
    if (confirm('ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      const updatedRecords = (currentProfile.records || []).filter(r => r.id !== id);
      const updatedProfile = {
        ...currentProfile,
        records: updatedRecords
      };
      setCurrentProfile(updatedProfile);
      const updatedProfiles = profiles.map(p => 
        p.id === currentProfile.id ? updatedProfile : p
      );
      setProfiles(updatedProfiles);
    }
  };

  const exportData = () => {
    if (!currentProfile) return;
    const dataStr = JSON.stringify(currentProfile, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `diabetes-${currentProfile.name}-${new Date().toISOString().split('T')[0]}.json`;
    link.click();
  };

  const importData = (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        const data = JSON.parse(event.target.result);
        
        // ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬
        if (!data.settings || !Array.isArray(data.records)) {
          alert('ì˜¬ë°”ë¥¸ ë°ì´í„° íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.');
          return;
        }

        // ìƒˆ í”„ë¡œí•„ë¡œ ê°€ì ¸ì˜¤ê¸°
        const importedProfile = {
          id: Date.now().toString(),
          name: data.name || `ê°€ì ¸ì˜¨ í”„ë¡œí•„ ${new Date().toLocaleString('ko-KR')}`,
          createdAt: new Date().toISOString(),
          settings: data.settings,
          records: data.records
        };

        const updatedProfiles = [...profiles, importedProfile];
        setProfiles(updatedProfiles);
        setCurrentProfile(importedProfile);
        
        try {
          localStorage.setItem(STORAGE_KEYS.PROFILES, JSON.stringify(updatedProfiles));
          localStorage.setItem(STORAGE_KEYS.CURRENT_PROFILE, importedProfile.id);
        } catch (error) {
          console.error('Error saving imported profile:', error);
        }
        
        alert('ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤!');
      } catch (error) {
        console.error('Import error:', error);
        alert('íŒŒì¼ì„ ì½ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    };
    reader.readAsText(file);
  };

  if (!disclaimerAccepted) {
    return <DisclaimerModal onAccept={handleDisclaimerAccept} />;
  }

  if (!currentProfile) {
    return (
      <ProfileModal
        profiles={profiles}
        currentProfile={null}
        onSelectProfile={selectProfile}
        onCreateProfile={createProfile}
        onDeleteProfile={deleteProfile}
        onClose={() => {}}
      />
    );
  }

  const records = currentProfile.records || [];
  const settings = currentProfile.settings || { icr: 10, isf: 50, targetBG: 120, cgmMode: 'manual' };

  // ì°¨íŠ¸ ë°ì´í„° ì¤€ë¹„
  const chartData = records
    .filter(r => r.bloodSugar && !isNaN(parseFloat(r.bloodSugar)))
    .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))
    .map(r => ({
      time: new Date(r.timestamp).toLocaleString('ko-KR', { 
        month: 'numeric', 
        day: 'numeric', 
        hour: '2-digit', 
        minute: '2-digit' 
      }),
      í˜ˆë‹¹: parseFloat(r.bloodSugar)
    }));

  const latestBG = records
    .filter(r => r.bloodSugar)
    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];

  const todayRecords = records.filter(r => {
    const recordDate = new Date(r.timestamp).toDateString();
    const today = new Date().toDateString();
    return recordDate === today;
  });

  const weekRecords = records.filter(r => {
    const recordDate = new Date(r.timestamp);
    const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
    return recordDate > weekAgo && r.bloodSugar;
  });

  const avgBG = weekRecords.length > 0
    ? Math.round(weekRecords.reduce((sum, r) => sum + parseFloat(r.bloodSugar), 0) / weekRecords.length)
    : null;

  return (
    <div className="min-h-screen bg-gray-50">
      {/* í—¤ë” */}
      <header className="bg-blue-600 text-white p-4 shadow-lg">
        <div className="max-w-6xl mx-auto flex items-center justify-between">
          <div>
            <h1 className="text-2xl font-bold">1í˜• ë‹¹ë‡¨ ê´€ë¦¬</h1>
            <p className="text-sm text-blue-100">í”„ë¡œí•„: {currentProfile.name}</p>
          </div>
          <div className="flex gap-2">
            <button
              onClick={() => setShowProfileModal(true)}
              className="p-2 hover:bg-blue-700 rounded"
              title="í”„ë¡œí•„ ë³€ê²½"
            >
              <User size={24} />
            </button>
            <button
              onClick={() => setShowSettings(true)}
              className="p-2 hover:bg-blue-700 rounded"
              title="ì„¤ì •"
            >
              <Settings size={24} />
            </button>
            <button
              onClick={exportData}
              className="p-2 hover:bg-blue-700 rounded"
              title="ë°ì´í„° ë‚´ë³´ë‚´ê¸°"
            >
              <Download size={24} />
            </button>
            <label className="p-2 hover:bg-blue-700 rounded cursor-pointer" title="ë°ì´í„° ê°€ì ¸ì˜¤ê¸°">
              <Upload size={24} />
              <input type="file" accept=".json" onChange={importData} className="hidden" />
            </label>
          </div>
        </div>
      </header>

      {/* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */}
      <div className="bg-white shadow">
        <div className="max-w-6xl mx-auto flex">
          <button
            onClick={() => setCurrentTab('dashboard')}
            className={`flex-1 py-3 font-medium ${currentTab === 'dashboard' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'}`}
          >
            ëŒ€ì‹œë³´ë“œ
          </button>
          <button
            onClick={() => setCurrentTab('records')}
            className={`flex-1 py-3 font-medium ${currentTab === 'records' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'}`}
          >
            ê¸°ë¡ ê´€ë¦¬
          </button>
        </div>
      </div>

      {/* ë©”ì¸ ì»¨í…ì¸  */}
      <main className="max-w-6xl mx-auto p-4 space-y-4">
        {currentTab === 'dashboard' && (
          <>
            {/* í˜„ì¬ ìƒíƒœ ì¹´ë“œ */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div className="bg-white rounded-lg shadow p-4">
                <div className="flex items-center gap-2 text-gray-600 mb-2">
                  <Activity size={20} />
                  <span className="text-sm font-medium">ìµœê·¼ í˜ˆë‹¹</span>
                </div>
                <div className={`text-3xl font-bold ${
                  latestBG 
                    ? parseFloat(latestBG.bloodSugar) < 70 
                      ? 'text-red-600' 
                      : parseFloat(latestBG.bloodSugar) > 180 
                        ? 'text-orange-600' 
                        : 'text-green-600'
                    : 'text-gray-400'
                }`}>
                  {latestBG ? `${latestBG.bloodSugar} mg/dL` : 'ê¸°ë¡ ì—†ìŒ'}
                </div>
                {latestBG && (
                  <p className="text-xs text-gray-500 mt-1">
                    {new Date(latestBG.timestamp).toLocaleString('ko-KR')}
                  </p>
                )}
              </div>

              <div className="bg-white rounded-lg shadow p-4">
                <div className="flex items-center gap-2 text-gray-600 mb-2">
                  <Calendar size={20} />
                  <span className="text-sm font-medium">ì˜¤ëŠ˜ ê¸°ë¡</span>
                </div>
                <div className="text-3xl font-bold text-blue-600">
                  {todayRecords.length}ê±´
                </div>
              </div>

              <div className="bg-white rounded-lg shadow p-4">
                <div className="flex items-center gap-2 text-gray-600 mb-2">
                  <Apple size={20} />
                  <span className="text-sm font-medium">í‰ê·  í˜ˆë‹¹ (7ì¼)</span>
                </div>
                <div className="text-3xl font-bold text-purple-600">
                  {avgBG ? `${avgBG} mg/dL` : 'â€”'}
                </div>
              </div>
            </div>

            {/* ë¹ ë¥¸ ì•¡ì…˜ ë²„íŠ¼ */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <button
                onClick={() => setShowRecordModal(true)}
                className="bg-blue-600 text-white p-4 rounded-lg font-semibold hover:bg-blue-700 flex items-center justify-center gap-2"
              >
                <Plus size={24} />
                í˜ˆë‹¹ ê¸°ë¡ ì¶”ê°€
              </button>
              <button
                onClick={() => setShowCalculator(true)}
                className="bg-green-600 text-white p-4 rounded-lg font-semibold hover:bg-green-700 flex items-center justify-center gap-2"
              >
                <Apple size={24} />
                ì¸ìŠë¦° ê³„ì‚°ê¸°
              </button>
            </div>

            {/* í˜ˆë‹¹ ê·¸ë˜í”„ */}
            {chartData.length > 0 && (
              <div className="bg-white rounded-lg shadow p-4">
                <h2 className="text-lg font-bold mb-4">í˜ˆë‹¹ ì¶”ì´ (ìµœê·¼ 20ê°œ)</h2>
                <ResponsiveContainer width="100%" height={300}>
                  <LineChart data={chartData.slice(-20)}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="time" tick={{ fontSize: 12 }} angle={-45} textAnchor="end" height={80} />
                    <YAxis domain={[0, 300]} />
                    <Tooltip />
                    <Legend />
                    <Line type="monotone" dataKey="í˜ˆë‹¹" stroke="#3b82f6" strokeWidth={2} dot={{ r: 4 }} />
                  </LineChart>
                </ResponsiveContainer>
                <div className="mt-2 flex gap-4 text-xs justify-center">
                  <div className="flex items-center gap-1">
                    <div className="w-3 h-3 bg-green-500 rounded" />
                    <span>ì •ìƒ (70-180)</span>
                  </div>
                  <div className="flex items-center gap-1">
                    <div className="w-3 h-3 bg-red-500 rounded" />
                    <span>ì €í˜ˆë‹¹ (&lt;70)</span>
                  </div>
                  <div className="flex items-center gap-1">
                    <div className="w-3 h-3 bg-orange-500 rounded" />
                    <span>ê³ í˜ˆë‹¹ (&gt;180)</span>
                  </div>
                </div>
              </div>
            )}

            {/* ìµœê·¼ ê¸°ë¡ */}
            <div className="bg-white rounded-lg shadow p-4">
              <h2 className="text-lg font-bold mb-4">ìµœê·¼ ê¸°ë¡</h2>
              {records.length === 0 ? (
                <p className="text-gray-500 text-center py-8">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ê¸°ë¡ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>
              ) : (
                <div className="space-y-2">
                  {records
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                    .slice(0, 5)
                    .map(record => (
                      <div key={record.id} className="border rounded p-3 hover:bg-gray-50">
                        <div className="flex items-start justify-between">
                          <div className="flex-1">
                            <div className="flex items-center gap-2 mb-1 flex-wrap">
                              <span className="text-sm text-gray-600">
                                {new Date(record.timestamp).toLocaleString('ko-KR')}
                              </span>
                              {record.bloodSugar && (
                                <span className={`font-semibold ${
                                  parseFloat(record.bloodSugar) < 70 
                                    ? 'text-red-600' 
                                    : parseFloat(record.bloodSugar) > 180 
                                      ? 'text-orange-600' 
                                      : 'text-green-600'
                                }`}>
                                  {record.bloodSugar} mg/dL
                                </span>
                              )}
                              {record.insulin && (
                                <span className="text-blue-600 font-medium">ì¸ìŠë¦° {record.insulin}U</span>
                              )}
                            </div>
                            {record.food && <p className="text-sm">ğŸ½ï¸ {record.food}</p>}
                            {record.exercise && <p className="text-sm">ğŸ’ª {record.exercise}</p>}
                            {record.note && <p className="text-sm text-gray-600">ğŸ“ {record.note}</p>}
                          </div>
                          <div className="flex gap-1">
                            <button
                              onClick={() => {
                                setEditingRecord(record);
                                setShowRecordModal(true);
                              }}
                              className="p-1 text-gray-600 hover:text-blue-600"
                            >
                              <Edit2 size={16} />
                            </button>
                            <button
                              onClick={() => deleteRecord(record.id)}
                              className="p-1 text-gray-600 hover:text-red-600"
                            >
                              <Trash2 size={16} />
                            </button>
                          </div>
                        </div>
                      </div>
                    ))}
                </div>
              )}
            </div>
          </>
        )}

        {currentTab === 'records' && (
          <div className="bg-white rounded-lg shadow p-4">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-lg font-bold">ì „ì²´ ê¸°ë¡ ({records.length}ê±´)</h2>
              <button
                onClick={() => setShowRecordModal(true)}
                className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 flex items-center gap-2"
              >
                <Plus size={18} />
                ì¶”ê°€
              </button>
            </div>
            {records.length === 0 ? (
              <p className="text-gray-500 text-center py-8">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            ) : (
              <div className="space-y-2 max-h-96 overflow-y-auto">
                {records
                  .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                  .map(record => (
                    <div key={record.id} className="border rounded p-3 hover:bg-gray-50">
                      <div className="flex items-start justify-between">
                        <div className="flex-1">
                          <div className="flex items-center gap-2 mb-1 flex-wrap">
                            <span className="text-sm text-gray-600">
                              {new Date(record.timestamp).toLocaleString('ko-KR')}
                            </span>
                            {record.bloodSugar && (
                              <span className={`font-semibold ${
                                parseFloat(record.bloodSugar) < 70 
                                  ? 'text-red-600' 
                                  : parseFloat(record.bloodSugar) > 180 
                                    ? 'text-orange-600' 
                                    : 'text-green-600'
                              }`}>
                                {record.bloodSugar} mg/dL
                              </span>
                            )}
                            {record.insulin && (
                              <span className="text-blue-600 font-medium">ì¸ìŠë¦° {record.insulin}U</span>
                            )}
                          </div>
                          {record.food && <p className="text-sm">ğŸ½ï¸ {record.food}</p>}
                          {record.exercise && <p className="text-sm">ğŸ’ª {record.exercise}</p>}
                          {record.note && <p className="text-sm text-gray-600">ğŸ“ {record.note}</p>}
                        </div>
                        <div className="flex gap-1">
                          <button
                            onClick={() => {
                              setEditingRecord(record);
                              setShowRecordModal(true);
                            }}
                            className="p-1 text-gray-600 hover:text-blue-600"
                          >
                            <Edit2 size={16} />
                          </button>
                          <button
                            onClick={() => deleteRecord(record.id)}
                            className="p-1 text-gray-600 hover:text-red-600"
                          >
                            <Trash2 size={16} />
                          </button>
                        </div>
                      </div>
                    </div>
                  ))}
              </div>
            )}
          </div>
        )}
      </main>

      {/* ëª¨ë‹¬ë“¤ */}
      {showProfileModal && (
        <ProfileModal
          profiles={profiles}
          currentProfile={currentProfile}
          onSelectProfile={selectProfile}
          onCreateProfile={createProfile}
          onDeleteProfile={deleteProfile}
          onClose={() => setShowProfileModal(false)}
        />
      )}

      {showSettings && (
        <SettingsModal
          settings={settings}
          onSave={updateSettings}
          onClose={() => setShowSettings(false)}
        />
      )}

      {showRecordModal && (
        <RecordModal
          record={editingRecord}
          onSave={(record) => {
            if (editingRecord) {
              updateRecord(record);
            } else {
              addRecord(record);
            }
            setEditingRecord(null);
          }}
          onClose={() => {
            setShowRecordModal(false);
            setEditingRecord(null);
          }}
        />
      )}

      {showCalculator && (
        <InsulinCalculatorModal
          settings={settings}
          onClose={() => setShowCalculator(false)}
          onSaveRecord={addRecord}
        />
      )}

      {/* í‘¸í„° */}
      <footer className="mt-8 py-4 text-center text-sm text-gray-500 bg-white">
        <p>ë³¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì€ ì˜ë£Œ ì „ë¬¸ê°€ì˜ ì¡°ì–¸ì„ ëŒ€ì²´í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
        <p className="mt-1">ëŒ€í•œë‹¹ë‡¨ë³‘í•™íšŒ ë° ë³´ê±´ë³µì§€ë¶€ ì§€ì¹¨ì„ ì°¸ê³ í•˜ì—¬ ì œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
        <p className="mt-2 text-xs">âš ï¸ Artifact í™˜ê²½ì—ì„œëŠ” ë°ì´í„°ê°€ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. GitHub Pagesì— ë°°í¬ í›„ ì‚¬ìš©í•˜ì„¸ìš”.</p>
      </footer>
    </div>
  );
}
