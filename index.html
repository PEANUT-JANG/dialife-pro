<h3 style="color: #059669; margin-bottom: 0.5rem;">👨‍⚕️ 담당 의사</h3>
              <p style="font-size: 1rem;">${user.medicalInfo?.doctorContact || '설정에서 등록하세요'}</p>
            </div>
            <div style="text-align: center; padding: 1rem; background: #fefce8; border: 1px solid #fde68a; border-radius: 0.75rem;">
              <h3 style="color: #d97706; margin-bottom: 0.5rem;">👪 보호자</h3>
              <p style="font-size: 1rem;">${user.medicalInfo?.emergencyContact || '설정에서 등록하세요'}</p>
            </div>
          </div>
          
          <div style="margin-top: 2rem; padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 0.75rem;">
            <h4 style="margin-bottom: 0.5rem; color: #1d4ed8;">📋 중요 안내사항</h4>
            <ul style="margin-left: 1rem; line-height: 1.8; color: #6b7280;">
              <li>의식을 잃은 경우 절대 음식물을 입에 넣지 마세요</li>
              <li>글루카곤 주사가 있다면 즉시 투여하고 119에 신고하세요</li>
              <li>혼자 있을 때는 주변에 미리 알려두세요</li>
              <li>정기적인 혈당 측정으로 응급상황을 예방하세요</li>
            </ul>
          </div>
        </div>
      `;
    }

    function renderAnalysis(container, user) {
      const data = user.personalizedData;
      
      container.innerHTML = `
        <div class="card full-width">
          <h2>📈 개인 혈당 패턴 분석</h2>
          
          ${user.records.length < 10 ? `
            <div style="text-align: center; padding: 2rem; background: #f8fafc; border-radius: 1rem; margin-bottom: 2rem;">
              <h3 style="color: #6b7280; margin-bottom: 1rem;">📊 더 정확한 분석을 위해</h3>
              <p style="color: #6b7280;">현재 ${user.records.length}개의 기록이 있습니다. 10개 이상의 기록이 있어야 더 정확한 패턴 분석이 가능합니다.</p>
              <div style="margin-top: 1rem;">
                <button onclick="switchTab('record')" class="btn btn-primary">첫 기록 추가하기</button>
              </div>
            </div>
          ` : ''}
          
          <div class="main-grid">
            <div class="card">
              <h3>🎯 혈당 범위 분석</h3>
              ${analyzeGlucoseRanges(user.records)}
            </div>
            
            <div class="card">
              <h3>📊 월간 트렌드</h3>
              ${analyzeMonthlyTrend(user.records)}
            </div>
          </div>
          
          <div class="main-grid">
            <div class="card">
              <h3>💉 인슐린 효율성 분석</h3>
              ${analyzeInsulinEfficiency(user.records)}
            </div>
            
            <div class="card">
              <h3>🏆 목표 달성률</h3>
              ${analyzeGoalAchievement(user.personalizedData)}
            </div>
          </div>
        </div>
      `;
    }

    function analyzeGlucoseRanges(records) {
      if (records.length === 0) return '<p style="color: #6b7280;">분석할 데이터가 없습니다.</p>';
      
      const ranges = {
        low: records.filter(r => parseFloat(r.glucose) < 70).length,
        normal: records.filter(r => parseFloat(r.glucose) >= 80 && parseFloat(r.glucose) <= 180).length,
        high: records.filter(r => parseFloat(r.glucose) > 180).length,
        severe: records.filter(r => parseFloat(r.glucose) > 250).length
      };
      
      const total = records.length;
      
      return `
        <div>
          <div class="pattern-item">
            <div style="display: flex; justify-content: space-between;">
              <span>🔴 저혈당 (&lt;70mg/dL)</span>
              <strong style="color: #ef4444;">${ranges.low}회 (${Math.round(ranges.low/total*100)}%)</strong>
            </div>
          </div>
          <div class="pattern-item">
            <div style="display: flex; justify-content: space-between;">
              <span>🟢 목표범위 (80-180mg/dL)</span>
              <strong style="color: #10b981;">${ranges.normal}회 (${Math.round(ranges.normal/total*100)}%)</strong>
            </div>
          </div>
          <div class="pattern-item">
            <div style="display: flex; justify-content: space-between;">
              <span>🟡 고혈당 (&gt;180mg/dL)</span>
              <strong style="color: #f59e0b;">${ranges.high}회 (${Math.round(ranges.high/total*100)}%)</strong>
            </div>
          </div>
          <div class="pattern-item">
            <div style="display: flex; justify-content: space-between;">
              <span>🔴 심각한 고혈당 (&gt;250mg/dL)</span>
              <strong style="color: #ef4444;">${ranges.severe}회 (${Math.round(ranges.severe/total*100)}%)</strong>
            </div>
          </div>
        </div>
      `;
    }

    function analyzeMonthlyTrend(records) {
      if (records.length === 0) return '<p style="color: #6b7280;">분석할 데이터가 없습니다.</p>';
      
      const now = new Date();
      const thisMonth = records.filter(r => {
        const recordDate = new Date(r.timestamp);
        return recordDate.getMonth() === now.getMonth() && recordDate.getFullYear() === now.getFullYear();
      });
      
      const lastMonth = records.filter(r => {
        const recordDate = new Date(r.timestamp);
        const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1);
        return recordDate.getMonth() === lastMonthDate.getMonth() && recordDate.getFullYear() === lastMonthDate.getFullYear();
      });
      
      const thisMonthAvg = thisMonth.length > 0 ? 
        Math.round(thisMonth.reduce((sum, r) => sum + parseFloat(r.glucose), 0) / thisMonth.length) : 0;
      const lastMonthAvg = lastMonth.length > 0 ? 
        Math.round(lastMonth.reduce((sum, r) => sum + parseFloat(r.glucose), 0) / lastMonth.length) : 0;
      
      const trend = thisMonthAvg - lastMonthAvg;
      
      return `
        <div>
          <div class="pattern-item">
            <div style="display: flex; justify-content: space-between;">
              <span>이번 달 평균</span>
              <strong>${thisMonthAvg}mg/dL (${thisMonth.length}회)</strong>
            </div>
          </div>
          ${lastMonth.length > 0 ? `
          <div class="pattern-item">
            <div style="display: flex; justify-content: space-between;">
              <span>지난 달 평균</span>
              <strong>${lastMonthAvg}mg/dL (${lastMonth.length}회)</strong>
            </div>
          </div>
          <div class="pattern-item">
            <div style="display: flex; justify-content: space-between;">
              <span>변화량</span>
              <strong style="color: ${trend > 0 ? '#f59e0b' : trend < 0 ? '#10b981' : '#6b7280'};">
                ${trend > 0 ? '+' : ''}${trend}mg/dL ${trend > 0 ? '📈' : trend < 0 ? '📉' : '➡️'}
              </strong>
            </div>
          </div>
          ` : '<div class="pattern-item">지난 달 데이터가 부족합니다.</div>'}
        </div>
      `;
    }

    function analyzeInsulinEfficiency(records) {
      const recordsWithInsulin = records.filter(r => r.insulin > 0 && r.carbs > 0);
      
      if (recordsWithInsulin.length < 5) {
        return '<p style="color: #6b7280;">인슐린 효율성 분석을 위해 더 많은 데이터가 필요합니다.</p>';
      }
      
      const avgICR = recordsWithInsulin.reduce((sum, r) => sum + (r.carbs / r.insulin), 0) / recordsWithInsulin.length;
      const consistency = recordsWithInsulin.map(r => r.carbs / r.insulin);
      const stdDev = Math.sqrt(consistency.reduce((sum, val) => sum + Math.pow(val - avgICR, 2), 0) / consistency.length);
      
      return `
        <div>
          <div class="pattern-item">
            <div style="display: flex; justify-content: space-between;">
              <span>개인 ICR (평균)</span>
              <strong>${Math.round(avgICR * 10) / 10}g/단위</strong>
            </div>
          </div>
          <div class="pattern-item">
            <div style="display: flex; justify-content: space-between;">
              <span>일관성 점수</span>
              <strong style="color: ${stdDev < 3 ? '#10b981' : stdDev < 5 ? '#f59e0b' : '#ef4444'};">
                ${stdDev < 3 ? '우수' : stdDev < 5 ? '보통' : '개선필요'}
              </strong>
            </div>
          </div>
          <div class="pattern-item">
            <div style="display: flex; justify-content: space-between;">
              <span>분석 데이터 수</span>
              <strong>${recordsWithInsulin.length}개 기록</strong>
            </div>
          </div>
        </div>
      `;
    }

    function analyzeGoalAchievement(personalizedData) {
      const tir = personalizedData.timeInRange || 0;
      const avgGlucose = personalizedData.avgGlucose || 0;
      
      return `
        <div>
          <div class="pattern-item">
            <div style="display: flex; justify-content: space-between;">
              <span>TIR 목표 (70% 이상)</span>
              <strong style="color: ${tir >= 70 ? '#10b981' : tir >= 50 ? '#f59e0b' : '#ef4444'};">
                ${tir}% ${tir >= 70 ? '✅' : tir >= 50 ? '⚠️' : '❌'}
              </strong>
            </div>
          </div>
          <div class="pattern-item">
            <div style="display: flex; justify-content: space-between;">
              <span>평균 혈당 목표 (80-180mg/dL)</span>
              <strong style="color: ${avgGlucose >= 80 && avgGlucose <= 180 ? '#10b981' : '#f59e0b'};">
                ${avgGlucose}mg/dL ${avgGlucose >= 80 && avgGlucose <= 180 ? '✅' : '⚠️'}
              </strong>
            </div>
          </div>
          <div class="pattern-item">
            <div style="display: flex; justify-content: space-between;">
              <span>전반적 관리 상태</span>
              <strong style="color: ${tir >= 70 && avgGlucose >= 80 && avgGlucose <= 180 ? '#10b981' : '#f59e0b'};">
                ${tir >= 70 && avgGlucose >= 80 && avgGlucose <= 180 ? '우수 🏆' : '개선 중 📈'}
              </strong>
            </div>
          </div>
        </div>
      `;
    }

    function renderFoodPatterns(container, user) {
      const foodReactions = user.personalizedData.foodReactions;
      
      container.innerHTML = `
        <div class="card full-width">
          <h2>🍽️ 개인별 음식 반응 패턴</h2>
          ${Object.keys(foodReactions).length === 0 ? 
            '<p style="color: #6b7280; text-align: center; padding: 2rem;">아직 충분한 데이터가 없습니다. 더 많은 기록을 추가해주세요.</p>' :
            `<div style="margin-bottom: 1rem;">
              <p style="color: #6b7280;">총 ${Object.keys(foodReactions).length}종류의 음식 데이터가 분석되었습니다.</p>
            </div>
            
            <div style="margin-bottom: 2rem;">
              <h3>⚠️ 주의 음식 (고혈당 위험)</h3>
              ${Object.entries(foodReactions)
                .filter(([food, reaction]) => reaction.riskLevel === 'high')
                .sort((a, b) => b[1].avgGlucose - a[1].avgGlucose)
                .slice(0, 3)
                .map(([food, reaction]) => `
                  <div class="pattern-item" style="border-left: 4px solid #ef4444;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                      <h4>${food}</h4>
                      <div class="trend-indicator trend-danger"></div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem; margin-bottom: 0.5rem;">
                      <div><strong>${reaction.count}회</strong><br><small>섭취</small></div>
                      <div><strong>${reaction.avgGlucose}mg/dL</strong><br><small>평균 혈당</small></div>
                      <div><strong>${reaction.avgInsulin}단위</strong><br><small>평균 인슐린</small></div>
                      <div><strong>${reaction.avgCarbs}g</strong><br><small>평균 탄수화물</small></div>
                    </div>
                    <div style="font-size: 0.875rem; color: #dc2626;">
                      ⚠️ 이 음식은 혈당을 크게 상승시킵니다. 인슐린 용량 조정이 필요할 수 있습니다.
                    </div>
                  </div>
                `).join('') || '<p style="color: #10b981;">⭐ 고위험 음식이 없습니다!</p>'
              }
            </div>
            
            <div style="margin-bottom: 2rem;">
              <h3>✅ 안전 음식 (낮은 혈당 상승)</h3>
              ${Object.entries(foodReactions)
                .filter(([food, reaction]) => reaction.riskLevel === 'low')
                .sort((a, b) => a[1].avgGlucose - b[1].avgGlucose)
                .slice(0, 5)
                .map(([food, reaction]) => `
                  <div class="pattern-item" style="border-left: 4px solid #10b981;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                      <h4>${food}</h4>
                      <div class="trend-indicator trend-good"></div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem;">
                      <div><strong>${reaction.count}회</strong><br><small>섭취</small></div>
                      <div><strong>${reaction.avgGlucose}mg/dL</strong><br><small>평균 혈당</small></div>
                      <div><strong>${reaction.avgInsulin}단위</strong><br><small>평균 인슐린</small></div>
                      <div><strong>${reaction.avgCarbs}g</strong><br><small>평균 탄수화물</small></div>
                    </div>
                  </div>
                `).join('') || '<p style="color: #6b7280;">안전한 음식 패턴을 찾기 위해 더 많은 데이터가 필요합니다.</p>'
              }
            </div>
            
            <div>
              <h3>📊 전체 음식 패턴</h3>
              ${Object.entries(foodReactions)
                .sort((a, b) => b[1].count - a[1].count)
                .map(([food, reaction]) => `
                  <div class="pattern-item">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                      <h4>${food}</h4>
                      <div class="trend-indicator ${getTrendClass(reaction.avgGlucose)}"></div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem; margin-bottom: 0.5rem;">
                      <div><strong>${reaction.count}회</strong><br><small>섭취</small></div>
                      <div><strong>${reaction.avgGlucose}mg/dL</strong><br><small>평균 혈당</small></div>
                      <div><strong>${reaction.avgInsulin}단위</strong><br><small>평균 인슐린</small></div>
                      <div><strong>${reaction.avgCarbs}g</strong><br><small>평균 탄수화물</small></div>
                    </div>
                    <div style="font-size: 0.875rem; color: #6b7280;">
                      ${KOREAN_FOOD_DATABASE[food] ? `GI ${KOREAN_FOOD_DATABASE[food].glycemicIndex} • ${KOREAN_FOOD_DATABASE[food].category} • ${KOREAN_FOOD_DATABASE[food].source} 데이터` : '사용자 입력 음식'}
                    </div>
                  </div>
                `).join('')}`
          }
        </div>
      `;
    }

    function renderProfile(container, user) {
      container.innerHTML = `
        <div class="main-grid">
          <div class="card">
            <h2>👤 프로필 정보</h2>
            <form id="profileForm">
              <div class="form-grid">
                <div class="form-group">
                  <label for="profileName">이름</label>
                  <input type="text" id="profileName" value="${user.name || ''}" placeholder="이름">
                </div>
                <div class="form-group">
                  <label for="profileAge">나이</label>
                  <input type="number" id="profileAge" value="${user.age || ''}" placeholder="나이" min="1" max="120">
                </div>
                <div class="form-group">
                  <label for="profileWeight">체중 (kg)</label>
                  <input type="number" id="profileWeight" value="${user.weight || ''}" placeholder="체중" step="0.1">
                </div>
                <div class="form-group">
                  <label for="profileHeight">신장 (cm)</label>
                  <input type="number" id="profileHeight" value="${user.height || ''}" placeholder="신장">
                </div>
              </div>
              
              <div class="form-group" style="margin: 1rem 0;">
                <label for="diagnosisYear">진단 연도</label>
                <input type="number" id="diagnosisYear" value="${user.diagnosisYear || ''}" placeholder="YYYY" min="1950" max="2025">
              </div>
              
              <div class="form-group" style="margin: 1rem 0;">
                <label for="emergencyContact">응급 연락처</label>
                <input type="tel" id="emergencyContact" value="${user.medicalInfo?.emergencyContact || ''}" placeholder="010-0000-0000">
              </div>
              
              <button type="submit" class="btn btn-success btn-full">
                💾 프로필 저장
              </button>
            </form>
            
            <div style="margin-top: 1.5rem; padding: 1rem; background: #f8fafc; border-radius: 0.5rem;">
              <h4 style="margin-bottom: 0.5rem;">📊 계정 정보</h4>
              <p><strong>가입일:</strong> ${formatDate(user.createdAt).split(' ')[0]}</p>
              <p><strong>마지막 로그인:</strong> ${formatDate(user.lastLogin)}</p>
              <p><strong>사용자명:</strong> ${user.username}</p>
            </div>
          </div>
          
          <div class="card">
            <h2>📊 데이터 관리</h2>
            <div style="margin-bottom: 1rem;">
              <button onclick="exportUserData()" class="btn btn-primary btn-full" style="margin-bottom: 0.5rem;">
                📤 내 데이터 내보내기
              </button>
              
              <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importUserData(event)">
              <button onclick="document.getElementById('importFile').click()" class="btn btn-primary btn-full" style="margin-bottom: 0.5rem;">
                📥 데이터 가져오기
              </button>
              
              <button onclick="resetAllData()" class="btn btn-danger btn-full">
                🗑️ 모든 데이터 삭제
              </button>
            </div>
            
            <div style="padding: 1rem; background: #fef2f2; border: 1px solid #fecaca; border-radius: 0.5rem;">
              <h4 style="margin-bottom: 0.5rem; color: #dc2626;">⚠️ 주의사항</h4>
              <ul style="font-size: 0.875rem; color: #6b7280; line-height: 1.6; margin-left: 1rem;">
                <li>데이터 삭제는 되돌릴 수 없습니다</li>
                <li>중요한 데이터는 미리 내보내기 하세요</li>
                <li>의료 데이터는 암호화되어 저장됩니다</li>
              </ul>
            </div>
          </div>
        </div>
        
        <div class="card full-width">
          <h2>🎯 개인화 설정</h2>
          <div class="form-grid">
            <div class="form-group">
              <label for="targetMin">목표 혈당 최소값 (mg/dL)</label>
              <input type="number" id="targetMin" value="${user.preferences?.targetGlucose?.min || 80}" min="50" max="150">
            </div>
            <div class="form-group">
              <label for="targetMax">목표 혈당 최대값 (mg/dL)</label>
              <input type="number" id="targetMax" value="${user.preferences?.targetGlucose?.max || 180}" min="100" max="300">
            </div>
            <div class="form-group">
              <label for="targetA1C">목표 당화혈색소 (%)</label>
              <input type="number" id="targetA1C" value="${user.preferences?.targetA1C || 7.0}" step="0.1" min="5.0" max="10.0">
            </div>
            <div class="form-group">
              <label for="insulinType">사용하는 인슐린 종류</label>
              <select id="insulinType">
                <option value="rapid" ${user.preferences?.insulinType === 'rapid' ? 'selected' : ''}>초속효성 (휴마로그, 노보래피드)</option>
                <option value="short" ${user.preferences?.insulinType === 'short' ? 'selected' : ''}>속효성 (휴물린R)</option>
                <option value="mixed" ${user.preferences?.insulinType === 'mixed' ? 'selected' : ''}>혼합형</option>
              </select>
            </div>
          </div>
          
          <button onclick="savePreferences()" class="btn btn-ai btn-full" style="margin-top: 1rem;">
            ⚙️ 설정 저장
          </button>
        </div>
      `;

      setupProfileEventListeners();
    }

    function setupProfileEventListeners() {
      const form = document.getElementById('profileForm');
      if (form) {
        form.addEventListener('submit', (e) => {
          e.preventDefault();
          
          const formData = new FormData(form);
          const profileData = {
            name: formData.get('name') || document.getElementById('profileName').value,
            age: document.getElementById('profileAge').value,
            weight: document.getElementById('profileWeight').value,
            height: document.getElementById('profileHeight').value,
            diagnosisYear: document.getElementById('diagnosisYear').value,
            medicalInfo: {
              ...userManager.currentUser.medicalInfo,
              emergencyContact: document.getElementById('emergencyContact').value
            },
            updated: new Date().toISOString()
          };
          
          userManager.updateUserData(profileData);
          alert('프로필이 저장되었습니다!');
        });
      }
    }

    // 이벤트 핸들러들
    function handleLogin() {
      const username = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;
      
      if (!username || !password) {
        alert('사용자명과 비밀번호를 모두 입력해주세요.');
        return;
      }
      
      const user = userManager.login(username, password);
      if (user) {
        renderMainApp();
      } else {
        alert('사용자명 또는 비밀번호가 올바르지 않습니다.');
      }
    }

    function handleRegister() {
      const username = document.getElementById('regUsername').value;
      const password = document.getElementById('regPassword').value;
      const name = document.getElementById('regName').value;
      const age = document.getElementById('regAge').value;
      const weight = document.getElementById('regWeight').value;
      const height = document.getElementById('regHeight').value;
      const diagnosisYear = document.getElementById('regDiagnosis').value;
      const emergencyContact = document.getElementById('emergencyContact').value;
      
      if (!username || !password || !name) {
        alert('필수 항목(사용자명, 비밀번호, 이름)을 모두 입력해주세요.');
        return;
      }
      
      // 중복 사용자명 체크
      const existingUser = Object.values(userManager.users).find(u => u.username === username);
      if (existingUser) {
        alert('이미 존재하는 사용자명입니다. 다른 사용자명을 선택해주세요.');
        return;
      }
      
      const userData = {
        username: username,
        password: password,
        name: name,
        age: age,
        weight: weight,
        height: height,
        diagnosisYear: diagnosisYear,
        emergencyContact: emergencyContact
      };
      
      const user = userManager.register(userData);
      userManager.currentUser = user;
      alert(`환영합니다, ${name}님! 회원가입이 완료되었습니다.`);
      renderMainApp();
    }

    function handleRecordSubmit() {
      const glucose = document.getElementById('glucose').value;
      const food = document.getElementById('food').value;
      const amount = document.getElementById('amount').value || 0;
      const insulin = document.getElementById('insulin').value || 0;
      const timing = document.getElementById('timing').value;
      const postMealGlucose = document.getElementById('postMealGlucose').value;
      const notes = document.getElementById('notes').value;
      
      if (!glucose || !food) {
        alert('혈당과 음식 이름은 필수입니다.');
        return;
      }

      const record = {
        id: Date.now() + Math.random(),
        glucose: glucose,
        food: food,
        amount: amount,
        insulin: insulin,
        carbs: calculateCarbs(food, amount),
        timing: timing,
        postMealGlucose: postMealGlucose,
        notes: notes,
        timestamp: new Date().toISOString()
      };

      userManager.addRecord(record);
      
      // AI 개인화 추천 표시
      aiEngine.generatePersonalizedRecommendations(record, userManager.currentUser.personalizedData)
        .then(recommendations => {
          if (recommendations && recommendations.length > 0) {
            const aiDiv = document.getElementById('aiRecommendations');
            aiDiv.innerHTML = `
              <div class="ai-recommendations">
                <h3 style="margin-bottom: 1rem;">🤖 AI 개인화 분석 결과</h3>
                ${recommendations.map(rec => `
                  <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(255, 255, 255, 0.8); border-radius: 0.5rem; border-left: 4px solid ${rec.type === 'emergency' ? '#ef4444' : rec.type === 'warning' ? '#f59e0b' : '#3b82f6'};">
                    <h4 style="margin-bottom: 0.5rem;">${rec.title}</h4>
                    <p style="margin-bottom: 0.5rem;">${rec.message}</p>
                    ${rec.priority === 'critical' ? '<p style="color: #dc2626; font-weight: 600;">⚠️ 즉시 조치 필요</p>' : ''}
                  </div>
                `).join('')}
                <div style="margin-top: 1rem; padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 0.5rem;">
                  <p style="font-size: 0.875rem; color: #6b7280;">
                    💡 이 분석은 ${userManager.currentUser.records.length}개의 개인 기록을 바탕으로 생성되었습니다.
                  </p>
                </div>
              </div>
            `;
          }
        });
      
      // 폼 초기화
      document.getElementById('glucose').value = '';
      document.getElementById('food').value = '';
      document.getElementById('amount').value = '';
      document.getElementById('insulin').value = '';
      document.getElementById('postMealGlucose').value = '';
      document.getElementById('notes').value = '';
      updatePersonalizedPreview();
      
      alert('기록이 저장되었습니다!');
      
      // 대시보드로 이동
      setTimeout(() => {
        currentTab = 'dashboard';
        renderMainApp();
      }, 3000);
    }

    function switchTab(tabName) {
      currentTab = tabName;
      renderMainApp();
    }

    function showRegisterForm() {
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('registerForm').classList.remove('hidden');
    }

    function showLoginForm() {
      document.getElementById('registerForm').classList.add('hidden');
      document.getElementById('loginForm').classList.remove('hidden');
    }

    function logout() {
      if (confirm('로그아웃 하시겠습니까?')) {
        userManager.currentUser = null;
        currentTab = 'dashboard';
        renderAuthScreen();
      }
    }

    function deleteRecord(recordId) {
      if (confirm('이 기록을 삭제하시겠습니까?')) {
        userManager.deleteRecord(recordId);
        renderMainApp();
      }
    }

    function selectFood(foodName) {
      const foodInput = document.getElementById('food');
      if (foodInput) {
        foodInput.value = foodName;
        hideFoodSuggestions();
        updatePersonalizedPreview();
      }
    }

    function selectCalculatorFood(foodName) {
      const foodInput = document.getElementById('calcFood');
      if (foodInput) {
        foodInput.value = foodName;
        hideCalculatorFoodSuggestions();
        updateCalculatorPreview();
      }
    }

    function callEmergency() {
      if (confirm('119 응급실에 연결하시겠습니까?')) {
        window.open('tel:119');
      }
    }

    function exportUserData() {
      const user = userManager.getCurrentUser();
      if (!user) return;
      
      const data = {
        user: user,
        exportDate: new Date().toISOString(),
        version: '2.0',
        app: 'DiaLife Pro'
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `dialife-${user.name}-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function importUserData(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          
          if (data.user && data.user.id) {
            if (confirm('데이터를 가져오면 현재 사용자 정보가 업데이트됩니다. 계속하시겠습니까?')) {
              userManager.users[data.user.id] = data.user;
              userManager.currentUser = data.user;
              userManager.saveUsers();
              alert('데이터를 성공적으로 가져왔습니다!');
              renderMainApp();
            }
          } else {
            alert('올바르지 않은 데이터 파일입니다.');
          }
        } catch (error) {
          alert('파일을 읽는 중 오류가 발생했습니다.');
        }
      };
      reader.readAsText(file);
    }

    function resetAllData() {
      if (confirm('정말로 모든 데이터를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
        if (confirm('마지막 확인: 모든 사용자 데이터와 기록이 영구 삭제됩니다.')) {
          localStorage.clear();
          alert('모든 데이터가 삭제되었습니다.');
          location.reload();
        }
      }
    }

    function savePreferences() {
      const user = userManager.getCurrentUser();
      if (!user) return;

      const preferences = {
        targetGlucose: {
          min: parseInt(document.getElementById('targetMin').value) || 80,
          max: parseInt(document.getElementById('targetMax').value) || 180
        },
        targetA1C: parseFloat(document.getElementById('targetA1C').value) || 7.0,
        insulinType: document.getElementById('insulinType').value || 'rapid'
      };

      user.preferences = { ...user.preferences, ...preferences };
      userManager.updateUserData({ preferences: user.preferences });
      alert('설정이 저장되었습니다!');
    }

    // 앱 시작
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(initApp, 1000); // 로딩 효과를 위한 지연
    });

    // 전역 함수 등록 (브라우저 호환성을 위해)
    window.handleLogin = handleLogin;
    window.handleRegister = handleRegister;
    window.handleRecordSubmit = handleRecordSubmit;
    window.calculateInsulin = calculateInsulin;
    window.saveCalculation = saveCalculation;
    window.switchTab = switchTab;
    window.showRegisterForm = showRegisterForm;
    window.showLoginForm = showLoginForm;
    window.logout = logout;
    window.deleteRecord = deleteRecord;
    window.selectFood = selectFood;
    window.selectCalculatorFood = selectCalculatorFood;
    window.callEmergency = callEmergency;
    window.exportUserData = exportUserData;
    window.importUserData = importUserData;
    window.resetAllData = resetAllData;
    window.savePreferences = savePreferences;
  </script>
</body>
</html>
