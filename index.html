<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DiaLife Pro - AI ê¸°ë°˜ 1í˜•ë‹¹ë‡¨ ê°œì¸í™” ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
      line-height: 1.6;
      color: #333;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .auth-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 1rem;
    }

    .auth-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 2rem;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
      padding: 3rem;
      width: 100%;
      max-width: 500px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      text-align: center;
    }

    .auth-header {
      margin-bottom: 2rem;
    }

    .auth-header h1 {
      font-size: 2.5rem;
      font-weight: bold;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.5rem;
    }

    .auth-header p {
      color: #6b7280;
      font-size: 1.1rem;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1rem;
    }

    .header {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 1rem;
      padding: 1.5rem;
      margin-bottom: 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
    }

    .header-left h1 {
      font-size: 2rem;
      font-weight: bold;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      margin-bottom: 0.25rem;
    }

    .header-left .welcome {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .user-info {
      text-align: right;
    }

    .user-info .user-name {
      font-weight: 600;
      font-size: 1.1rem;
    }

    .user-info .user-stats {
      font-size: 0.9rem;
      opacity: 0.8;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 1rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .card h2 {
      font-size: 1.4rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: #1f2937;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-size: 0.875rem;
      font-weight: 500;
      color: #374151;
      margin-bottom: 0.25rem;
    }

    .form-group input, 
    .form-group select,
    .form-group textarea {
      padding: 0.75rem;
      border: 2px solid #e5e7eb;
      border-radius: 0.5rem;
      font-size: 1rem;
      transition: all 0.2s;
      background: white;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    .btn-success {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
    }

    .btn-ai {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      color: white;
    }

    .btn-logout {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
    }

    .btn-full {
      width: 100%;
      justify-content: center;
    }

    .btn-small {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }

    .stats-dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: linear-gradient(135deg, #f8fafc, #e2e8f0);
      padding: 1.5rem;
      border-radius: 1rem;
      text-align: center;
      border: 1px solid #e2e8f0;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
    }

    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: #1f2937;
      margin-bottom: 0.25rem;
    }

    .stat-label {
      font-size: 0.875rem;
      color: #6b7280;
    }

    .tab-container {
      margin-bottom: 2rem;
    }

    .tab-buttons {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      border-radius: 1rem;
      padding: 0.5rem;
      flex-wrap: wrap;
    }

    .tab-button {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.75rem;
      background: transparent;
      color: white;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
      font-size: 0.9rem;
    }

    .tab-button.active {
      background: rgba(255, 255, 255, 0.95);
      color: #1f2937;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .full-width {
      grid-column: 1 / -1;
    }

    .hidden {
      display: none;
    }

    .food-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .food-suggestion {
      padding: 0.75rem;
      cursor: pointer;
      border-bottom: 1px solid #f3f4f6;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .food-suggestion:hover {
      background: #f9fafb;
    }

    .food-suggestion:last-child {
      border-bottom: none;
    }

    .food-search {
      position: relative;
    }

    .preview-box {
      background: linear-gradient(135deg, #eff6ff, #dbeafe);
      border: 2px solid #3b82f6;
      border-radius: 1rem;
      padding: 1rem;
      margin-top: 1rem;
    }

    .personal-analysis {
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      border: 2px solid #0284c7;
      border-radius: 1rem;
      padding: 1rem;
      margin-top: 1rem;
    }

    .ai-recommendations {
      background: linear-gradient(135deg, #f3e8ff, #e9d5ff);
      border: 2px solid #8b5cf6;
      border-radius: 1rem;
      padding: 1.5rem;
      margin-top: 1rem;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .modal-content {
      background: white;
      border-radius: 1rem;
      padding: 2rem;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }

    @media (max-width: 1024px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
      
      .header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 0.5rem;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .stats-dashboard {
        grid-template-columns: repeat(2, 1fr);
      }

      .tab-buttons {
        flex-wrap: wrap;
      }

      .tab-button {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="loading" style="display: flex; justify-content: center; align-items: center; min-height: 100vh; color: white;">
      <h2>ì‹œìŠ¤í…œì„ ì´ˆê¸°í™”í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...</h2>
    </div>
  </div>

  <script>
    // í™•ì¥ëœ í•œêµ­ ìŒì‹ ë°ì´í„°ë² ì´ìŠ¤
    let KOREAN_FOOD_DATABASE = {
      // ì£¼ì‹ë¥˜
      'ìŒ€ë°¥': { carbs: 23, protein: 2.5, fat: 0.3, category: 'ì£¼ì‹', serving: 100, glycemicIndex: 73, source: 'ì‹ì•½ì²˜' },
      'ë°±ë¯¸ë°¥': { carbs: 23, protein: 2.5, fat: 0.3, category: 'ì£¼ì‹', serving: 100, glycemicIndex: 73, source: 'ì‹ì•½ì²˜' },
      'í˜„ë¯¸ë°¥': { carbs: 22, protein: 2.8, fat: 0.9, category: 'ì£¼ì‹', serving: 100, glycemicIndex: 56, source: 'ì‹ì•½ì²˜' },
      'ë³´ë¦¬ë°¥': { carbs: 21, protein: 3.2, fat: 0.7, category: 'ì£¼ì‹', serving: 100, glycemicIndex: 25, source: 'ì‹ì•½ì²˜' },
      'ê¹€ë°¥': { carbs: 35, protein: 6, fat: 4, category: 'ì£¼ì‹', serving: 100, glycemicIndex: 65, source: 'ì‹ì•½ì²˜' },
      'ì£¼ë¨¹ë°¥': { carbs: 25, protein: 3, fat: 1, category: 'ì£¼ì‹', serving: 100, glycemicIndex: 70, source: 'ì‹ì•½ì²˜' },
      'ë¹„ë¹”ë°¥': { carbs: 40, protein: 8, fat: 7, category: 'ì£¼ì‹', serving: 100, glycemicIndex: 62, source: 'ì‹ì•½ì²˜' },
      'ë³¶ìŒë°¥': { carbs: 35, protein: 7, fat: 8, category: 'ì£¼ì‹', serving: 100, glycemicIndex: 68, source: 'ì‹ì•½ì²˜' },
      
      // ë©´ë¥˜
      'ë¼ë©´': { carbs: 55, protein: 9, fat: 16, category: 'ë©´ë¥˜', serving: 100, glycemicIndex: 73, source: 'ì‹ì•½ì²˜' },
      'ì§œíŒŒê²Œí‹°': { carbs: 58, protein: 9, fat: 17, category: 'ë©´ë¥˜', serving: 100, glycemicIndex: 70, source: 'ì œí’ˆ' },
      'ëƒ‰ë©´': { carbs: 19, protein: 4, fat: 0.5, category: 'ë©´ë¥˜', serving: 100, glycemicIndex: 40, source: 'ì‹ì•½ì²˜' },
      'ìš°ë™': { carbs: 21, protein: 3, fat: 0.4, category: 'ë©´ë¥˜', serving: 100, glycemicIndex: 55, source: 'ì‹ì•½ì²˜' },
      'ì§œì¥ë©´': { carbs: 45, protein: 8, fat: 10, category: 'ë©´ë¥˜', serving: 100, glycemicIndex: 65, source: 'ì‹ì•½ì²˜' },
      'ì§¬ë½•': { carbs: 42, protein: 12, fat: 8, category: 'ë©´ë¥˜', serving: 100, glycemicIndex: 63, source: 'ì‹ì•½ì²˜' },
      'ì¹¼êµ­ìˆ˜': { carbs: 35, protein: 6, fat: 2, category: 'ë©´ë¥˜', serving: 100, glycemicIndex: 58, source: 'ì‹ì•½ì²˜' },
      'ìŠ¤íŒŒê²Œí‹°': { carbs: 48, protein: 8, fat: 6, category: 'ë©´ë¥˜', serving: 100, glycemicIndex: 60, source: 'ì‹ì•½ì²˜' },
      
      // ë¹µë¥˜
      'ì‹ë¹µ': { carbs: 47, protein: 8, fat: 4, category: 'ë¹µë¥˜', serving: 100, glycemicIndex: 75, source: 'ì‹ì•½ì²˜' },
      'í¬ë¡œì™€ìƒ': { carbs: 45, protein: 7, fat: 21, category: 'ë¹µë¥˜', serving: 100, glycemicIndex: 67, source: 'ì‹ì•½ì²˜' },
      'ë² ì´ê¸€': { carbs: 48, protein: 10, fat: 1.5, category: 'ë¹µë¥˜', serving: 100, glycemicIndex: 72, source: 'ì‹ì•½ì²˜' },
      'ì†Œë³´ë¡œë¹µ': { carbs: 52, protein: 7, fat: 15, category: 'ë¹µë¥˜', serving: 100, glycemicIndex: 68, source: 'ì‹ì•½ì²˜' },
      'ë‹¨íŒ¥ë¹µ': { carbs: 55, protein: 8, fat: 3, category: 'ë¹µë¥˜', serving: 100, glycemicIndex: 70, source: 'ì‹ì•½ì²˜' },
      
      // ê³¼ì¼ë¥˜
      'ì‚¬ê³¼': { carbs: 14, protein: 0.3, fat: 0.2, category: 'ê³¼ì¼', serving: 100, glycemicIndex: 36, source: 'ì‹ì•½ì²˜' },
      'ë°°': { carbs: 11, protein: 0.3, fat: 0.1, category: 'ê³¼ì¼', serving: 100, glycemicIndex: 33, source: 'ì‹ì•½ì²˜' },
      'ë°”ë‚˜ë‚˜': { carbs: 23, protein: 1, fat: 0.2, category: 'ê³¼ì¼', serving: 100, glycemicIndex: 51, source: 'ì‹ì•½ì²˜' },
      'ì˜¤ë Œì§€': { carbs: 12, protein: 0.9, fat: 0.1, category: 'ê³¼ì¼', serving: 100, glycemicIndex: 42, source: 'ì‹ì•½ì²˜' },
      'í¬ë„': { carbs: 16, protein: 0.6, fat: 0.2, category: 'ê³¼ì¼', serving: 100, glycemicIndex: 46, source: 'ì‹ì•½ì²˜' },
      'ìˆ˜ë°•': { carbs: 8, protein: 0.6, fat: 0.2, category: 'ê³¼ì¼', serving: 100, glycemicIndex: 72, source: 'ì‹ì•½ì²˜' },
      'ë”¸ê¸°': { carbs: 8, protein: 0.7, fat: 0.3, category: 'ê³¼ì¼', serving: 100, glycemicIndex: 40, source: 'ì‹ì•½ì²˜' },
      
      // ì±„ì†Œë¥˜
      'ê¹€ì¹˜': { carbs: 3, protein: 1.1, fat: 0.4, category: 'ì±„ì†Œ', serving: 100, glycemicIndex: 15, source: 'ì‹ì•½ì²˜' },
      'ë°°ì¶”ê¹€ì¹˜': { carbs: 3, protein: 1.1, fat: 0.4, category: 'ì±„ì†Œ', serving: 100, glycemicIndex: 15, source: 'ì‹ì•½ì²˜' },
      'ë¬´': { carbs: 2, protein: 0.5, fat: 0.1, category: 'ì±„ì†Œ', serving: 100, glycemicIndex: 10, source: 'ì‹ì•½ì²˜' },
      'ë‹¹ê·¼': { carbs: 8, protein: 0.7, fat: 0.2, category: 'ì±„ì†Œ', serving: 100, glycemicIndex: 47, source: 'ì‹ì•½ì²˜' },
      'ê°ì': { carbs: 17, protein: 2, fat: 0.1, category: 'ì±„ì†Œ', serving: 100, glycemicIndex: 62, source: 'ì‹ì•½ì²˜' },
      'ê³ êµ¬ë§ˆ': { carbs: 20, protein: 1.2, fat: 0.2, category: 'ì±„ì†Œ', serving: 100, glycemicIndex: 48, source: 'ì‹ì•½ì²˜' },
      'ì˜¥ìˆ˜ìˆ˜': { carbs: 19, protein: 3.2, fat: 1.2, category: 'ì±„ì†Œ', serving: 100, glycemicIndex: 52, source: 'ì‹ì•½ì²˜' },
      
      // ìœ¡ë¥˜
      'ë‹­ê°€ìŠ´ì‚´': { carbs: 0, protein: 23, fat: 1.2, category: 'ìœ¡ë¥˜', serving: 100, glycemicIndex: 0, source: 'ì‹ì•½ì²˜' },
      'ì‚¼ê²¹ì‚´': { carbs: 0, protein: 17, fat: 28, category: 'ìœ¡ë¥˜', serving: 100, glycemicIndex: 0, source: 'ì‹ì•½ì²˜' },
      'ì†Œê³ ê¸°': { carbs: 0, protein: 21, fat: 12, category: 'ìœ¡ë¥˜', serving: 100, glycemicIndex: 0, source: 'ì‹ì•½ì²˜' },
      
      // ê³„ë€/ë‘ë¶€
      'ê³„ë€': { carbs: 0.7, protein: 13, fat: 11, category: 'ë‹¨ë°±ì§ˆ', serving: 100, glycemicIndex: 0, source: 'ì‹ì•½ì²˜' },
      'ë‘ë¶€': { carbs: 2, protein: 8, fat: 4, category: 'ë‹¨ë°±ì§ˆ', serving: 100, glycemicIndex: 15, source: 'ì‹ì•½ì²˜' },
      
      // ìœ ì œí’ˆ
      'ìš°ìœ ': { carbs: 5, protein: 3.3, fat: 3.2, category: 'ìœ ì œí’ˆ', serving: 100, glycemicIndex: 39, source: 'ì‹ì•½ì²˜' },
      'ìš”êµ¬ë¥´íŠ¸': { carbs: 7, protein: 3.5, fat: 3, category: 'ìœ ì œí’ˆ', serving: 100, glycemicIndex: 41, source: 'ì‹ì•½ì²˜' },
      'ì¹˜ì¦ˆ': { carbs: 1, protein: 25, fat: 33, category: 'ìœ ì œí’ˆ', serving: 100, glycemicIndex: 0, source: 'ì‹ì•½ì²˜' },
      
      // ê°„ì‹ë¥˜
      'ì´ˆì½œë¦¿': { carbs: 57, protein: 4, fat: 31, category: 'ê°„ì‹', serving: 100, glycemicIndex: 40, source: 'ì‹ì•½ì²˜' },
      'ì¿ í‚¤': { carbs: 67, protein: 6, fat: 24, category: 'ê°„ì‹', serving: 100, glycemicIndex: 77, source: 'ì‹ì•½ì²˜' },
      'ì•„ì´ìŠ¤í¬ë¦¼': { carbs: 24, protein: 3, fat: 11, category: 'ê°„ì‹', serving: 100, glycemicIndex: 51, source: 'ì‹ì•½ì²˜' },
      'ë–¡': { carbs: 44, protein: 4, fat: 0.5, category: 'ê°„ì‹', serving: 100, glycemicIndex: 83, source: 'ì‹ì•½ì²˜' },
      
      // ìŒë£Œ
      'ì½œë¼': { carbs: 11, protein: 0, fat: 0, category: 'ìŒë£Œ', serving: 100, glycemicIndex: 63, source: 'ì‹ì•½ì²˜' },
      'ì‚¬ì´ë‹¤': { carbs: 10, protein: 0, fat: 0, category: 'ìŒë£Œ', serving: 100, glycemicIndex: 68, source: 'ì‹ì•½ì²˜' },
      'ì˜¤ë Œì§€ì£¼ìŠ¤': { carbs: 11, protein: 0.7, fat: 0.2, category: 'ìŒë£Œ', serving: 100, glycemicIndex: 50, source: 'ì‹ì•½ì²˜' },
      
      // íŒ¨ìŠ¤íŠ¸í‘¸ë“œ
      'í–„ë²„ê±°': { carbs: 33, protein: 13, fat: 10, category: 'íŒ¨ìŠ¤íŠ¸í‘¸ë“œ', serving: 100, glycemicIndex: 66, source: 'ì¶”ì •ì¹˜' },
      'í”¼ì': { carbs: 33, protein: 11, fat: 10, category: 'íŒ¨ìŠ¤íŠ¸í‘¸ë“œ', serving: 100, glycemicIndex: 60, source: 'ì¶”ì •ì¹˜' },
      'ì¹˜í‚¨': { carbs: 15, protein: 18, fat: 15, category: 'íŒ¨ìŠ¤íŠ¸í‘¸ë“œ', serving: 100, glycemicIndex: 45, source: 'ì¶”ì •ì¹˜' },
      
      // í•œì‹
      'ëœì¥ì°Œê°œ': { carbs: 7, protein: 5, fat: 3, category: 'êµ­/ì°Œê°œ', serving: 100, glycemicIndex: 33, source: 'ì‹ì•½ì²˜' },
      'ê¹€ì¹˜ì°Œê°œ': { carbs: 5, protein: 8, fat: 4, category: 'êµ­/ì°Œê°œ', serving: 100, glycemicIndex: 35, source: 'ì‹ì•½ì²˜' },
      'ë¶ˆê³ ê¸°': { carbs: 10, protein: 18, fat: 8, category: 'ë°˜ì°¬', serving: 100, glycemicIndex: 25, source: 'ì‹ì•½ì²˜' }
    };

    // ì‚¬ìš©ì ê´€ë¦¬ ì‹œìŠ¤í…œ
    class UserManager {
      constructor() {
        this.currentUser = null;
        this.users = this.loadUsers();
      }

      loadUsers() {
        try {
          const stored = localStorage.getItem('dialife_users_v4');
          return stored ? JSON.parse(stored) : {};
        } catch (error) {
          console.warn('ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
          return {};
        }
      }

      saveUsers() {
        try {
          localStorage.setItem('dialife_users_v4', JSON.stringify(this.users));
        } catch (error) {
          console.warn('ì‚¬ìš©ì ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', error);
        }
      }

      register(userData) {
        const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const user = {
          id: userId,
          ...userData,
          createdAt: new Date().toISOString(),
          lastLogin: new Date().toISOString(),
          records: [],
          preferences: {
            targetGlucose: { min: 80, max: 180 },
            targetA1C: 7.0,
            insulinType: 'rapid'
          },
          personalizedData: {
            totalRecords: 0,
            avgGlucose: 0,
            timeInRange: 0,
            personalICR: 15,
            personalISF: 50,
            foodReactions: {}
          }
        };
        
        this.users[userId] = user;
        this.saveUsers();
        return user;
      }

      login(username, password) {
        const user = Object.values(this.users).find(u => 
          u.username === username && u.password === password
        );
        
        if (user) {
          user.lastLogin = new Date().toISOString();
          this.currentUser = user;
          this.saveUsers();
          return user;
        }
        return null;
      }

      getCurrentUser() {
        return this.currentUser;
      }

      addRecord(record) {
        if (this.currentUser) {
          this.currentUser.records.push(record);
          this.updatePersonalizedData();
          this.saveUsers();
        }
      }

      updatePersonalizedData() {
        if (!this.currentUser) return;

        const records = this.currentUser.records;
        const personalizedData = this.currentUser.personalizedData;

        personalizedData.totalRecords = records.length;
        
        if (records.length > 0) {
          const glucoseValues = records.map(r => parseFloat(r.glucose || 0));
          personalizedData.avgGlucose = Math.round(
            glucoseValues.reduce((sum, val) => sum + val, 0) / glucoseValues.length
          );

          // ëª©í‘œ ë²”ìœ„ ì‹œê°„ ê³„ì‚° (TIR: Time In Range)
          const targetRange = records.filter(r => {
            const glucose = parseFloat(r.glucose);
            return glucose >= 80 && glucose <= 180;
          });
          personalizedData.timeInRange = Math.round((targetRange.length / records.length) * 100);

          // ìŒì‹ë³„ ë°˜ì‘ íŒ¨í„´ ë¶„ì„
          this.analyzeFoodReactions();
        }
      }

      analyzeFoodReactions() {
        const records = this.currentUser.records;
        const foodReactions = {};

        records.forEach(record => {
          const food = record.food;
          if (!food) return;

          if (!foodReactions[food]) {
            foodReactions[food] = {
              count: 0,
              avgGlucose: 0,
              glucoseValues: [],
              avgInsulin: 0,
              avgCarbs: 0
            };
          }

          const reaction = foodReactions[food];
          reaction.count++;
          reaction.glucoseValues.push(parseFloat(record.glucose || 0));
          reaction.avgGlucose = Math.round(
            reaction.glucoseValues.reduce((a, b) => a + b, 0) / reaction.glucoseValues.length
          );
          reaction.avgInsulin = Math.round((reaction.avgInsulin * (reaction.count - 1) + parseFloat(record.insulin || 0)) / reaction.count * 10) / 10;
          reaction.avgCarbs = Math.round((reaction.avgCarbs * (reaction.count - 1) + parseFloat(record.carbs || 0)) / reaction.count);
        });

        this.currentUser.personalizedData.foodReactions = foodReactions;
      }
    }

    // AI ì—”ì§„
    class PersonalizedAIEngine {
      calculatePersonalizedInsulin(glucose, carbs, personalData) {
        const baseICR = 15;
        const baseISF = 50;
        
        let personalICR = personalData.personalICR || baseICR;
        let personalISF = personalData.personalISF || baseISF;
        
        const carbInsulin = carbs / personalICR;
        const correctionInsulin = glucose > 120 ? (glucose - 120) / personalISF : 0;
        
        return {
          carbInsulin: Math.round(carbInsulin * 10) / 10,
          correctionInsulin: Math.round(correctionInsulin * 10) / 10,
          total: Math.round((carbInsulin + correctionInsulin) * 10) / 10,
          confidence: Math.min((personalData.totalRecords || 0) * 10, 100),
          personalICR: personalICR,
          personalISF: personalISF
        };
      }
    }

    // ê¸€ë¡œë²Œ ë³€ìˆ˜
    let userManager = new UserManager();
    let aiEngine = new PersonalizedAIEngine();
    let currentTab = 'dashboard';
    let calculationResult = null;

    // ì‚¬ìš©ì ìŒì‹ ë°ì´í„° ë¡œë“œ
    function loadUserFoods() {
      const userFoods = localStorage.getItem('dialife_user_foods');
      if (userFoods) {
        try {
          const parsed = JSON.parse(userFoods);
          Object.assign(KOREAN_FOOD_DATABASE, parsed);
        } catch (error) {
          console.warn('ì‚¬ìš©ì ìŒì‹ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
        }
      }
    }

    // ì‚¬ìš©ì ìŒì‹ ì €ì¥
    function saveUserFood(foodName, nutritionData) {
      const userFoods = localStorage.getItem('dialife_user_foods');
      const foods = userFoods ? JSON.parse(userFoods) : {};
      foods[foodName] = nutritionData;
      localStorage.setItem('dialife_user_foods', JSON.stringify(foods));
      KOREAN_FOOD_DATABASE[foodName] = nutritionData;
    }

    // AI ì˜ì–‘ì†Œ ì¶”ì •
    function estimateNutrition(foodName) {
      const defaultEstimate = {
        carbs: 30,
        protein: 5,
        fat: 5,
        category: 'ì¶”ì •ì¹˜',
        serving: 100,
        glycemicIndex: 50,
        source: 'AIì¶”ì •'
      };
      
      if (foodName.includes('ë°¥') || foodName.includes('ë©´') || foodName.includes('ë¹µ')) {
        defaultEstimate.carbs = 40;
        defaultEstimate.glycemicIndex = 65;
      } else if (foodName.includes('ê³ ê¸°') || foodName.includes('ìœ¡') || foodName.includes('ë‹­')) {
        defaultEstimate.carbs = 0;
        defaultEstimate.protein = 20;
        defaultEstimate.fat = 10;
        defaultEstimate.glycemicIndex = 0;
      } else if (foodName.includes('ì±„ì†Œ') || foodName.includes('ë‚˜ë¬¼')) {
        defaultEstimate.carbs = 5;
        defaultEstimate.protein = 2;
        defaultEstimate.fat = 0.5;
        defaultEstimate.glycemicIndex = 20;
      } else if (foodName.includes('ê³¼ì¼')) {
        defaultEstimate.carbs = 15;
        defaultEstimate.protein = 1;
        defaultEstimate.fat = 0.2;
        defaultEstimate.glycemicIndex = 45;
      }
      
      return defaultEstimate;
    }

    // ìŒì‹ ê²€ìƒ‰ í•¨ìˆ˜
    function searchFood(query) {
      if (!query || query.length < 1) return [];
      
      const lowerQuery = query.toLowerCase();
      const results = [];
      
      Object.keys(KOREAN_FOOD_DATABASE).forEach(food => {
        if (food.toLowerCase().includes(lowerQuery)) {
          results.push({
            name: food,
            data: KOREAN_FOOD_DATABASE[food]
          });
        }
      });
      
      return results.slice(0, 10);
    }

    // ì‚¬ìš©ì ì •ì˜ ìŒì‹ ë‹¤ì´ì–¼ë¡œê·¸
    function showCustomFoodDialog(context, foodName) {
      const estimated = estimateNutrition(foodName);
      
      const dialog = document.createElement('div');
      dialog.className = 'modal-overlay';
      
      dialog.innerHTML = `
        <div class="modal-content">
          <h2 style="margin-bottom: 1rem; color: #1f2937;">ìŒì‹ ì •ë³´ ì…ë ¥</h2>
          <p style="margin-bottom: 1rem; color: #6b7280;">
            "<strong>${foodName}</strong>"ì˜ ì˜ì–‘ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.
            <br>AI ì¶”ì •ì¹˜ê°€ ì œê³µë˜ë©°, ì§ì ‘ ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.
          </p>
          
          <div class="form-grid">
            <div class="form-group">
              <label for="customCarbs">íƒ„ìˆ˜í™”ë¬¼ (g/100g) *</label>
              <input type="number" id="customCarbs" value="${estimated.carbs}" min="0" step="0.1">
              <small style="color: #6b7280;">AI ì¶”ì •ì¹˜: ${estimated.carbs}g</small>
            </div>
            
            <div class="form-group">
              <label for="customProtein">ë‹¨ë°±ì§ˆ (g/100g)</label>
              <input type="number" id="customProtein" value="${estimated.protein}" min="0" step="0.1">
            </div>
            
            <div class="form-group">
              <label for="customFat">ì§€ë°© (g/100g)</label>
              <input type="number" id="customFat" value="${estimated.fat}" min="0" step="0.1">
            </div>
            
            <div class="form-group">
              <label for="customGI">í˜ˆë‹¹ì§€ìˆ˜ (GI)</label>
              <input type="number" id="customGI" value="${estimated.glycemicIndex}" min="0" max="100">
            </div>
          </div>
          
          <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
            <button onclick="saveCustomFood('${context}', '${foodName}')" class="btn btn-success btn-full">
              ì €ì¥ ë° ì‚¬ìš©
            </button>
            <button onclick="closeCustomFoodDialog()" class="btn btn-primary">
              ì·¨ì†Œ
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(dialog);
    }

    // ì‚¬ìš©ì ì •ì˜ ìŒì‹ ì €ì¥
    function saveCustomFood(context, foodName) {
      const carbs = parseFloat(document.getElementById('customCarbs').value) || 0;
      const protein = parseFloat(document.getElementById('customProtein').value) || 0;
      const fat = parseFloat(document.getElementById('customFat').value) || 0;
      const glycemicIndex = parseInt(document.getElementById('customGI').value) || 50;
      
      if (carbs <= 0) {
        alert('íƒ„ìˆ˜í™”ë¬¼ ì •ë³´ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.');
        return;
      }
      
      const nutritionData = {
        carbs: carbs,
        protein: protein,
        fat: fat,
        category: 'ì‚¬ìš©ìì…ë ¥',
        serving: 100,
        glycemicIndex: glycemicIndex,
        source: 'ì‚¬ìš©ìì…ë ¥'
      };
      
      saveUserFood(foodName, nutritionData);
      
      if (context === 'calc') {
        document.getElementById('calcFood').value = foodName;
        hideCalculatorFoodSuggestions();
        updateCalculatorPreview();
      }
      
      closeCustomFoodDialog();
      alert(`"${foodName}" ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    }

    // ë‹¤ì´ì–¼ë¡œê·¸ ë‹«ê¸°
    function closeCustomFoodDialog() {
      const dialog = document.querySelector('.modal-overlay');
      if (dialog) {
        dialog.remove();
      }
    }

    // ê³„ì‚°ê¸° ìŒì‹ ê²€ìƒ‰ í‘œì‹œ
    function showCalculatorFoodSuggestions(query) {
      const suggestions = searchFood(query);
      const container = document.getElementById('calcFoodSuggestions');
      
      if (!container) return;
      
      // ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìœ¼ë©´ ì‚¬ìš©ì ì…ë ¥ ì˜µì…˜ ì œê³µ
      if (suggestions.length === 0 && query.length > 0) {
        container.innerHTML = `
          <div class="food-suggestion" style="background: #f3f4f6;">
            <div>
              <strong>"${query}"ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</strong>
              <br>
              <small style="color: #6b7280;">í´ë¦­í•˜ì—¬ ì§ì ‘ ì˜ì–‘ ì •ë³´ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ AI ì¶”ì •ì¹˜ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”</small>
            </div>
            <button onclick="showCustomFoodDialog('calc', '${query}')" class="btn btn-primary btn-small">
              ì§ì ‘ ì…ë ¥
            </button>
          </div>
        `;
        container.style.display = 'block';
        return;
      }
      
      if (suggestions.length === 0) {
        hideCalculatorFoodSuggestions();
        return;
      }
      
      container.innerHTML = suggestions.map(item => `
        <div class="food-suggestion" onclick="selectCalculatorFood('${item.name}')">
          <div>
            <strong>${item.name}</strong>
            <br>
            <small>${item.data.category} â€¢ íƒ„ìˆ˜í™”ë¬¼ ${item.data.carbs}g/100g â€¢ GI ${item.data.glycemicIndex}</small>
          </div>
          <div style="text-align: right; font-size: 0.875rem; color: #6b7280;">
            ${item.data.carbs}g
          </div>
        </div>
      `).join('');
      
      container.style.display = 'block';
    }

    function hideCalculatorFoodSuggestions() {
      const container = document.getElementById('calcFoodSuggestions');
      if (container) {
        container.style.display = 'none';
      }
    }

    function selectCalculatorFood(foodName) {
      document.getElementById('calcFood').value = foodName;
      hideCalculatorFoodSuggestions();
      updateCalculatorPreview();
    }

    function updateCalculatorPreview() {
      const food = document.getElementById('calcFood').value;
      const amount = document.getElementById('calcAmount').value;
      const preview = document.getElementById('calcPreview');
      const user = userManager.getCurrentUser();
      
      if (!food || !preview) return;
      
      let content = '';
      
      if (KOREAN_FOOD_DATABASE[food] && amount) {
        const foodData = KOREAN_FOOD_DATABASE[food];
        const carbs = Math.round(foodData.carbs * amount / 100);
        const protein = Math.round(foodData.protein * amount / 100);
        const fat = Math.round(foodData.fat * amount / 100);
        
        content += `
          <div class="preview-box">
            <h4 style="margin-bottom: 0.75rem; color: #1e40af;">ì˜ì–‘ ì •ë³´ ë¶„ì„</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem; text-align: center;">
              <div><strong>${carbs}g</strong><br><small>íƒ„ìˆ˜í™”ë¬¼</small></div>
              <div><strong>${protein}g</strong><br><small>ë‹¨ë°±ì§ˆ</small></div>
              <div><strong>${fat}g</strong><br><small>ì§€ë°©</small></div>
              <div><strong>GI ${foodData.glycemicIndex}</strong><br><small>í˜ˆë‹¹ì§€ìˆ˜</small></div>
            </div>
          </div>
        `;
      }
      
      preview.innerHTML = content;
    }

    function calculateInsulin() {
      const glucose = parseFloat(document.getElementById('calcGlucose').value);
      const food = document.getElementById('calcFood').value;
      const amount = parseFloat(document.getElementById('calcAmount').value);
      
      if (!glucose || !food || !amount) {
        alert('ëª¨ë“  í•„ìˆ˜ í•­ëª©(í˜„ì¬ í˜ˆë‹¹, ìŒì‹ ì´ë¦„, ì„­ì·¨ëŸ‰)ì„ ì…ë ¥í•˜ì„¸ìš”.');
        return;
      }
      
      if (!KOREAN_FOOD_DATABASE[food]) {
        alert('ìŒì‹ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ê²€ìƒ‰ ê²°ê³¼ì—ì„œ ì„ íƒí•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // íƒ„ìˆ˜í™”ë¬¼ ê³„ì‚°
      const foodData = KOREAN_FOOD_DATABASE[food];
      const carbs = Math.round(foodData.carbs * amount / 100 * 10) / 10; // ì†Œìˆ˜ì  1ìë¦¬
      
      const user = userManager.getCurrentUser();
      const personalICR = user.personalizedData.personalICR || 15; // ICR: 1ë‹¨ìœ„ë‹¹ íƒ„ìˆ˜í™”ë¬¼ g
      const personalISF = user.personalizedData.personalISF || 50; // ISF: 1ë‹¨ìœ„ë‹¹ í˜ˆë‹¹ ê°ì†Œ mg/dL
      const targetGlucose = 120; // ëª©í‘œ í˜ˆë‹¹
      
      // ì¸ìŠë¦° ê³„ì‚°
      const carbInsulin = carbs / personalICR; // ì‹ì‚¬ ì¸ìŠë¦°
      const correctionInsulin = glucose > targetGlucose ? (glucose - targetGlucose) / personalISF : 0; // êµì • ì¸ìŠë¦°
      const totalInsulin = carbInsulin + correctionInsulin;
      
      // ê²°ê³¼ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
      calculationResult = {
        glucose,
        food,
        amount,
        carbs,
        carbInsulin: Math.round(carbInsulin * 10) / 10,
        correctionInsulin: Math.round(correctionInsulin * 10) / 10,
        total: Math.round(totalInsulin * 10) / 10,
        timestamp: new Date().toISOString()
      };
      
      // ê²°ê³¼ í‘œì‹œ
      const resultsContainer = document.getElementById('calcResults');
      resultsContainer.innerHTML = `
        <div class="ai-recommendations">
          <h3 style="margin-bottom: 1rem; color: #7c3aed;">ğŸ¯ ì¸ìŠë¦° íˆ¬ì—¬ëŸ‰ ê³„ì‚° ê²°ê³¼</h3>
          
          <div style="background: #f3f4f6; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
            <h4 style="margin-bottom: 0.5rem;">ğŸ“‹ ì…ë ¥ ì •ë³´</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; font-size: 0.9rem;">
              <div>í˜„ì¬ í˜ˆë‹¹: <strong>${glucose} mg/dL</strong></div>
              <div>ìŒì‹: <strong>${food}</strong></div>
              <div>ì„­ì·¨ëŸ‰: <strong>${amount}g</strong></div>
              <div>íƒ„ìˆ˜í™”ë¬¼: <strong>${carbs}g</strong></div>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
            <div style="text-align: center; padding: 1rem; background: rgba(255, 255, 255, 0.8); border-radius: 0.75rem; border: 1px solid #e5e7eb;">
              <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">ì‹ì‚¬ ì¸ìŠë¦°</div>
              <div style="font-size: 1.75rem; font-weight: bold; color: #3b82f6;">${calculationResult.carbInsulin}</div>
              <div style="font-size: 0.75rem; color: #6b7280;">ë‹¨ìœ„</div>
              <div style="font-size: 0.75rem; color: #9ca3af; margin-top: 0.5rem;">${carbs}g Ã· ${personalICR}</div>
            </div>
            
            <div style="text-align: center; padding: 1rem; background: rgba(255, 255, 255, 0.8); border-radius: 0.75rem; border: 1px solid #e5e7eb;">
              <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">êµì • ì¸ìŠë¦°</div>
              <div style="font-size: 1.75rem; font-weight: bold; color: #f59e0b;">${calculationResult.correctionInsulin}</div>
              <div style="font-size: 0.75rem; color: #6b7280;">ë‹¨ìœ„</div>
              <div style="font-size: 0.75rem; color: #9ca3af; margin-top: 0.5rem;">
                ${glucose > targetGlucose ? `(${glucose}-${targetGlucose}) Ã· ${personalISF}` : 'êµì • ë¶ˆí•„ìš”'}
              </div>
            </div>
            
            <div style="text-align: center; padding: 1.5rem; background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px rgba(139, 92, 246, 0.3);">
              <div style="font-size: 0.875rem; margin-bottom: 0.5rem;">ì´ ì¸ìŠë¦°</div>
              <div style="font-size: 2.5rem; font-weight: bold;">${calculationResult.total}</div>
              <div style="font-size: 1rem;">ë‹¨ìœ„</div>
            </div>
          </div>
          
          <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid #10b981; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
            <h4 style="color: #059669; margin-bottom: 0.5rem;">ğŸ“Š ê³„ì‚° ìƒì„¸</h4>
            <div style="font-size: 0.875rem; color: #047857;">
              <p style="margin-bottom: 0.25rem;">â€¢ ì‹ì‚¬ ì¸ìŠë¦° = íƒ„ìˆ˜í™”ë¬¼(${carbs}g) Ã· ICR(${personalICR}) = ${calculationResult.carbInsulin}ë‹¨ìœ„</p>
              ${glucose > targetGlucose ? 
                `<p style="margin-bottom: 0.25rem;">â€¢ êµì • ì¸ìŠë¦° = (í˜„ì¬í˜ˆë‹¹(${glucose}) - ëª©í‘œí˜ˆë‹¹(${targetGlucose})) Ã· ISF(${personalISF}) = ${calculationResult.correctionInsulin}ë‹¨ìœ„</p>` :
                '<p style="margin-bottom: 0.25rem;">â€¢ êµì • ì¸ìŠë¦° = 0ë‹¨ìœ„ (í˜ˆë‹¹ì´ ëª©í‘œ ë²”ìœ„ ë‚´)</p>'
              }
              <p style="font-weight: 600; margin-top: 0.5rem;">â€¢ ì´ í•„ìš” ì¸ìŠë¦° = ${calculationResult.carbInsulin} + ${calculationResult.correctionInsulin} = ${calculationResult.total}ë‹¨ìœ„</p>
            </div>
          </div>
          
          <div style="background: rgba(251, 191, 36, 0.1); border: 1px solid #fbbf24; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
            <h4 style="color: #d97706; margin-bottom: 0.5rem;">âš ï¸ ì£¼ì˜ì‚¬í•­</h4>
            <ul style="font-size: 0.875rem; color: #92400e; margin-left: 1rem;">
              <li>ì´ ê³„ì‚°ì€ í‘œì¤€ ê³µì‹ì— ê¸°ë°˜í•œ ì°¸ê³  ìë£Œì…ë‹ˆë‹¤</li>
              <li>ì‹¤ì œ íˆ¬ì—¬ëŸ‰ì€ ìš´ë™, ìŠ¤íŠ¸ë ˆìŠ¤, ì§ˆë³‘ ë“±ì— ë”°ë¼ ì¡°ì •ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
              <li>ë°˜ë“œì‹œ ë‹´ë‹¹ ì˜ë£Œì§„ì˜ ì§€ì‹œë¥¼ ë”°ë¥´ì„¸ìš”</li>
              <li>ì €í˜ˆë‹¹ ì¦ìƒì´ ìˆìœ¼ë©´ ì¸ìŠë¦° íˆ¬ì—¬ë¥¼ ì—°ê¸°í•˜ê³  í˜ˆë‹¹ì„ ì¬ì¸¡ì •í•˜ì„¸ìš”</li>
            </ul>
          </div>
          
          <div style="display: flex; gap: 1rem;">
            <button onclick="saveCalculation()" class="btn btn-success btn-full">
              ğŸ’¾ ì´ ê³„ì‚° ê²°ê³¼ë¥¼ ê¸°ë¡ì— ì €ì¥
            </button>
            <button onclick="clearCalculator()" class="btn btn-primary">
              ğŸ”„ ìƒˆë¡œ ê³„ì‚°
            </button>
          </div>
        </div>
      `;
    }
    
    function clearCalculator() {
      document.getElementById('calcGlucose').value = '';
      document.getElementById('calcFood').value = '';
      document.getElementById('calcAmount').value = '';
      document.getElementById('calcPreview').innerHTML = '';
      document.getElementById('calcResults').innerHTML = '';
      calculationResult = null;
    }

    // ì•± ì´ˆê¸°í™”
    function initApp() {
      loadUserFoods(); // ì‚¬ìš©ì ìŒì‹ ë°ì´í„° ë¡œë“œ
      
      const currentUser = userManager.getCurrentUser();
      
      if (!currentUser) {
        renderAuthScreen();
      } else {
        renderMainApp();
      }
    }

    // ì¸ì¦ í™”ë©´ ë Œë”ë§
    function renderAuthScreen() {
      document.getElementById('app').innerHTML = `
        <div class="auth-container">
          <div class="auth-card">
            <div class="auth-header">
              <h1>DiaLife Pro</h1>
              <p>ê°œì¸í™”ëœ 1í˜•ë‹¹ë‡¨ ê´€ë¦¬ ì‹œìŠ¤í…œ</p>
            </div>
            
            <div id="loginForm">
              <h3 style="margin-bottom: 1rem; color: #1f2937;">ë¡œê·¸ì¸</h3>
              <div class="form-group" style="margin-bottom: 1rem;">
                <label for="loginUsername">ì‚¬ìš©ìëª…</label>
                <input type="text" id="loginUsername" required placeholder="ì‚¬ìš©ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
              </div>
              <div class="form-group" style="margin-bottom: 1.5rem;">
                <label for="loginPassword">ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="loginPassword" required placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
              </div>
              <button onclick="handleLogin()" class="btn btn-primary btn-full">ë¡œê·¸ì¸</button>
              
              <p style="text-align: center; margin: 1.5rem 0; color: #6b7280;">ë˜ëŠ”</p>
              
              <button onclick="showRegisterForm()" class="btn btn-success btn-full">
                ìƒˆ ê³„ì • ë§Œë“¤ê¸°
              </button>
            </div>
            
            <div id="registerForm" class="hidden">
              <h3 style="margin-bottom: 1rem; color: #1f2937;">íšŒì›ê°€ì…</h3>
              <div class="form-grid">
                <div class="form-group">
                  <label for="regUsername">ì‚¬ìš©ìëª… *</label>
                  <input type="text" id="regUsername" required placeholder="ì‚¬ìš©ìëª…">
                </div>
                <div class="form-group">
                  <label for="regPassword">ë¹„ë°€ë²ˆí˜¸ *</label>
                  <input type="password" id="regPassword" required placeholder="ë¹„ë°€ë²ˆí˜¸">
                </div>
                <div class="form-group">
                  <label for="regName">ì´ë¦„ *</label>
                  <input type="text" id="regName" required placeholder="ì‹¤ëª…">
                </div>
                <div class="form-group">
                  <label for="regAge">ë‚˜ì´</label>
                  <input type="number" id="regAge" placeholder="ë‚˜ì´" min="1" max="120">
                </div>
              </div>
              
              <button onclick="handleRegister()" class="btn btn-success btn-full" style="margin-bottom: 1rem;">
                íšŒì›ê°€ì… ì™„ë£Œ
              </button>
              
              <button onclick="showLoginForm()" class="btn btn-primary btn-full">
                ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function showRegisterForm() {
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('registerForm').classList.remove('hidden');
    }

    function showLoginForm() {
      document.getElementById('registerForm').classList.add('hidden');
      document.getElementById('loginForm').classList.remove('hidden');
    }

    function handleLogin() {
      const username = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;
      
      if (!username || !password) {
        alert('ì‚¬ìš©ìëª…ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
        return;
      }
      
      const user = userManager.login(username, password);
      
      if (user) {
        renderMainApp();
      } else {
        alert('ë¡œê·¸ì¸ ì‹¤íŒ¨. ì‚¬ìš©ìëª…ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
      }
    }

    function handleRegister() {
      const username = document.getElementById('regUsername').value;
      const password = document.getElementById('regPassword').value;
      const name = document.getElementById('regName').value;
      const age = document.getElementById('regAge').value;
      
      if (!username || !password || !name) {
        alert('í•„ìˆ˜ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.');
        return;
      }
      
      const existingUser = Object.values(userManager.users).find(u => u.username === username);
      if (existingUser) {
        alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì‚¬ìš©ìëª…ì…ë‹ˆë‹¤.');
        return;
      }
      
      const userData = {
        username,
        password,
        name,
        age: age ? parseInt(age) : null
      };
      
      const user = userManager.register(userData);
      userManager.currentUser = user;
      
      alert('íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
      renderMainApp();
    }

    function logout() {
      userManager.currentUser = null;
      renderAuthScreen();
    }

    // ë©”ì¸ ì•± ë Œë”ë§
    function renderMainApp() {
      const user = userManager.getCurrentUser();
      
      document.getElementById('app').innerHTML = `
        <div class="container">
          <header class="header">
            <div class="header-left">
              <h1>DiaLife Pro AI</h1>
              <div class="welcome">ì•ˆë…•í•˜ì„¸ìš”, ${user.name}ë‹˜!</div>
            </div>
            <div class="header-right">
              <div class="user-info">
                <div class="user-name">${user.name} ${user.age ? '(' + user.age + 'ì„¸)' : ''}</div>
                <div class="user-stats">
                  í˜ˆë‹¹ ${user.personalizedData.totalRecords}ê°œ â€¢ 
                  í‰ê·  ${user.personalizedData.avgGlucose || 0}mg/dL â€¢ 
                  TIR ${user.personalizedData.timeInRange || 0}%
                </div>
              </div>
              <button onclick="logout()" class="btn btn-logout">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
          </header>

          <div class="tab-container">
            <div class="tab-buttons">
              <button class="tab-button ${currentTab === 'dashboard' ? 'active' : ''}" onclick="switchTab('dashboard')">
                ëŒ€ì‹œë³´ë“œ
              </button>
              <button class="tab-button ${currentTab === 'calculator' ? 'active' : ''}" onclick="switchTab('calculator')">
                ì¸ìŠë¦° ê³„ì‚°
              </button>
            </div>
          </div>

          <div id="tabContent"></div>
        </div>
      `;

      renderTabContent();
    }

    function switchTab(tabName) {
      currentTab = tabName;
      renderMainApp();
    }

    function renderTabContent() {
      const container = document.getElementById('tabContent');
      const user = userManager.getCurrentUser();
      
      if (currentTab === 'dashboard') {
        renderDashboard(container, user);
      } else if (currentTab === 'calculator') {
        renderCalculator(container, user);
      }
    }

    function renderDashboard(container, user) {
      const data = user.personalizedData;
      
      container.innerHTML = `
        <div class="stats-dashboard">
          <div class="stat-card">
            <div class="stat-value">${data.avgGlucose || 0}</div>
            <div class="stat-label">í‰ê·  í˜ˆë‹¹ (mg/dL)</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${data.timeInRange || 0}%</div>
            <div class="stat-label">ëª©í‘œ ë²”ìœ„ ì‹œê°„ (TIR)</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${data.totalRecords}</div>
            <div class="stat-label">ì´ ê¸°ë¡ ìˆ˜</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${data.personalICR}</div>
            <div class="stat-label">ê°œì¸ ICR</div>
          </div>
        </div>

        <div class="card">
          <h2>ìµœê·¼ ê¸°ë¡</h2>
          ${user.records.length === 0 ? 
            '<p style="color: #6b7280; text-align: center; padding: 2rem;">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ì¸ìŠë¦° ê³„ì‚°ê¸°ë¥¼ ì‚¬ìš©í•´ë³´ì„¸ìš”!</p>' :
            user.records.slice(-5).reverse().map(record => `
              <div style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <strong>${record.food || 'ê¸°ë¡'}</strong>
                    <div style="font-size: 0.875rem; color: #6b7280;">
                      ${new Date(record.timestamp).toLocaleString('ko-KR')}
                    </div>
                  </div>
                  <div style="text-align: right;">
                    <div style="font-size: 1.25rem; font-weight: 600; color: ${record.glucose < 70 ? '#ef4444' : record.glucose > 180 ? '#f59e0b' : '#10b981'};">
                      ${record.glucose} mg/dL
                    </div>
                    <div style="font-size: 0.875rem; color: #6b7280;">
                      ${record.carbs}g â€¢ ${record.insulin}ë‹¨ìœ„
                    </div>
                  </div>
                </div>
              </div>
            `).join('')
          }
        </div>
      `;
    }

    function renderCalculator(container, user) {
      container.innerHTML = `
        <div class="card full-width">
          <h2>ğŸ§® AI ê°œì¸í™” ì¸ìŠë¦° ê³„ì‚°ê¸°</h2>
          <div style="background: rgba(239, 68, 68, 0.1); border: 2px solid #ef4444; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
            <p style="color: #dc2626; font-weight: 600; margin-bottom: 0.5rem;">
              âš ï¸ ì¤‘ìš” ì•ˆë‚´
            </p>
            <p style="color: #991b1b; font-size: 0.875rem;">
              ì´ ê³„ì‚°ê¸°ëŠ” ì°¸ê³ ìš©ì…ë‹ˆë‹¤. ì‹¤ì œ ì¸ìŠë¦° íˆ¬ì—¬ ì „ ë°˜ë“œì‹œ ë‹´ë‹¹ ì˜ë£Œì§„ê³¼ ìƒë‹´í•˜ì„¸ìš”.
              ê°œì¸ì˜ ìƒíƒœì— ë”°ë¼ ìš©ëŸ‰ ì¡°ì •ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
          </div>
          
          <div style="background: #f3f4f6; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
            <h3 style="margin-bottom: 0.5rem;">ğŸ“Š í˜„ì¬ ì„¤ì •ê°’</h3>
            <p style="font-size: 0.9rem; color: #6b7280;">
              ICR (ì¸ìŠë¦° ëŒ€ íƒ„ìˆ˜í™”ë¬¼ ë¹„ìœ¨): <strong>1ë‹¨ìœ„ë‹¹ ${user.personalizedData.personalICR}g</strong><br>
              ISF (ì¸ìŠë¦° ë¯¼ê°ë„ ê³„ìˆ˜): <strong>1ë‹¨ìœ„ë‹¹ ${user.personalizedData.personalISF}mg/dL ê°ì†Œ</strong><br>
              ëª©í‘œ í˜ˆë‹¹: <strong>120mg/dL</strong>
            </p>
          </div>
          
          <div class="form-grid">
            <div class="form-group">
              <label for="calcGlucose">í˜„ì¬ í˜ˆë‹¹ (mg/dL) *</label>
              <input type="number" id="calcGlucose" placeholder="ì˜ˆ: 150" min="30" max="600" onchange="updateCalculatorPreview()">
            </div>
            
            <div class="form-group food-search">
              <label for="calcFood">ìŒì‹ ì´ë¦„ *</label>
              <input type="text" id="calcFood" placeholder="ì˜ˆ: ìŒ€ë°¥" autocomplete="off" onkeyup="showCalculatorFoodSuggestions(this.value)">
              <div id="calcFoodSuggestions" class="food-suggestions"></div>
            </div>
            
            <div class="form-group">
              <label for="calcAmount">ì„­ì·¨ëŸ‰ (g) *</label>
              <input type="number" id="calcAmount" placeholder="ì˜ˆ: 200" min="0" step="0.1" onchange="updateCalculatorPreview()">
            </div>
            
            <div class="form-group">
              <label for="calcMealTiming">ì‹ì‚¬ ì‹œì </label>
              <select id="calcMealTiming">
                <option value="before">ì‹ì „</option>
                <option value="after">ì‹í›„</option>
              </select>
            </div>
          </div>
          
          <div id="calcPreview"></div>
          
          <button onclick="calculateInsulin()" class="btn btn-ai btn-full" style="margin-top: 1.5rem; font-size: 1.1rem; padding: 1rem;">
            ğŸ¤– ì¸ìŠë¦° íˆ¬ì—¬ëŸ‰ ê³„ì‚°í•˜ê¸°
          </button>
          
          <div id="calcResults"></div>
          
          <div style="background: #f0f9ff; padding: 1rem; border-radius: 0.5rem; margin-top: 1.5rem;">
            <h4 style="color: #0c4a6e; margin-bottom: 0.5rem;">ğŸ’¡ ì‚¬ìš© ë°©ë²•</h4>
            <ol style="font-size: 0.875rem; color: #075985; margin-left: 1rem;">
              <li>í˜„ì¬ í˜ˆë‹¹ ìˆ˜ì¹˜ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤</li>
              <li>ì„­ì·¨í•  ìŒì‹ì„ ê²€ìƒ‰í•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•©ë‹ˆë‹¤</li>
              <li>ì„­ì·¨ëŸ‰ì„ ê·¸ë¨ ë‹¨ìœ„ë¡œ ì…ë ¥í•©ë‹ˆë‹¤</li>
              <li>"ì¸ìŠë¦° íˆ¬ì—¬ëŸ‰ ê³„ì‚°í•˜ê¸°" ë²„íŠ¼ì„ í´ë¦­í•©ë‹ˆë‹¤</li>
              <li>ê³„ì‚°ëœ ì¸ìŠë¦° ë‹¨ìœ„ë¥¼ í™•ì¸í•©ë‹ˆë‹¤</li>
            </ol>
          </div>
        </div>
      `;
    }

    // ì•± ì‹œì‘
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
