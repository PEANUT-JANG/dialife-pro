<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DiaLife Pro - 통합 당뇨 관리</title>
  <!-- React Production 버전 사용 -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* 로딩 중 표시를 위한 기본 스타일 */
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
    }
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <div id="root">
    <div class="loading">앱을 로딩 중입니다...</div>
  </div>

  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;

    // 음식 데이터베이스
    const FOOD_DATABASE = {
      '밥': { carbs: 23, category: '주식' },
      '사과': { carbs: 14, category: '과일' },
      '바나나': { carbs: 23, category: '과일' },
      '라면': { carbs: 55, category: '면류' },
      '초콜릿': { carbs: 57, category: '간식' },
      '빵': { carbs: 50, category: '주식' },
      '우유': { carbs: 5, category: '유제품' },
      '감자': { carbs: 17, category: '채소' }
    };

    // localStorage 안전 접근 함수들
    const safeLocalStorage = {
      getItem: (key) => {
        try {
          if (typeof Storage !== 'undefined' && window.localStorage) {
            return localStorage.getItem(key);
          }
        } catch (error) {
          console.warn('localStorage 접근 실패:', error);
        }
        return null;
      },
      setItem: (key, value) => {
        try {
          if (typeof Storage !== 'undefined' && window.localStorage) {
            localStorage.setItem(key, value);
            return true;
          }
        } catch (error) {
          console.warn('localStorage 저장 실패:', error);
        }
        return false;
      }
    };

    const App = () => {
      // 상태 초기화
      const [records, setRecords] = useState([]);
      const [isLoaded, setIsLoaded] = useState(false);
      const [newRecord, setNewRecord] = useState({
        glucose: '', 
        food: '', 
        amount: '', 
        insulin: '', 
        timestamp: ''
      });
      const [editingId, setEditingId] = useState(null);
      const [editData, setEditData] = useState({ 
        glucose: '', 
        food: '', 
        amount: '', 
        insulin: '' 
      });

      // 데이터 로드
      useEffect(() => {
        try {
          const saved = safeLocalStorage.getItem('glucose_records');
          if (saved) {
            const parsed = JSON.parse(saved);
            if (Array.isArray(parsed)) {
              setRecords(parsed);
            }
          }
        } catch (error) {
          console.warn('데이터 로드 실패:', error);
        } finally {
          setIsLoaded(true);
        }
      }, []);

      // 현재 시간 업데이트
      useEffect(() => {
        const updateTimestamp = () => {
          setNewRecord(prev => ({
            ...prev,
            timestamp: new Date().toISOString()
          }));
        };
        
        updateTimestamp();
        const interval = setInterval(updateTimestamp, 60000); // 1분마다 업데이트
        
        return () => clearInterval(interval);
      }, []);

      // 탄수화물 계산
      const calculateCarbs = useCallback((food, amount) => {
        if (!food || !amount || !FOOD_DATABASE[food]) return 0;
        const numAmount = parseFloat(amount);
        if (isNaN(numAmount)) return 0;
        return Math.round((FOOD_DATABASE[food].carbs * numAmount) / 100);
      }, []);

      // 기록 저장
      const handleSave = useCallback(() => {
        if (!newRecord.glucose || !newRecord.food) {
          alert('혈당과 음식 이름은 필수입니다.');
          return;
        }

        const record = {
          ...newRecord,
          id: Date.now() + Math.random(), // 더 고유한 ID 생성
          carbs: calculateCarbs(newRecord.food, newRecord.amount),
          timestamp: new Date().toISOString()
        };
        
        const updated = [...records, record];
        setRecords(updated);
        
        // localStorage에 저장
        safeLocalStorage.setItem('glucose_records', JSON.stringify(updated));
        
        // 입력 필드 초기화
        setNewRecord({ 
          glucose: '', 
          food: '', 
          amount: '', 
          insulin: '', 
          timestamp: new Date().toISOString() 
        });
      }, [newRecord, records, calculateCarbs]);

      // 기록 삭제
      const handleDelete = useCallback((id) => {
        if (!confirm('이 기록을 삭제하시겠습니까?')) return;
        
        const updated = records.filter(r => r.id !== id);
        setRecords(updated);
        safeLocalStorage.setItem('glucose_records', JSON.stringify(updated));
      }, [records]);

      // 수정 시작
      const startEdit = useCallback((record) => {
        setEditingId(record.id);
        setEditData({
          glucose: record.glucose || '',
          food: record.food || '',
          amount: record.amount || '',
          insulin: record.insulin || ''
        });
      }, []);

      // 수정 확인
      const confirmEdit = useCallback((id) => {
        const updated = records.map(r =>
          r.id === id ? {
            ...r,
            ...editData,
            carbs: calculateCarbs(editData.food, editData.amount)
          } : r
        );
        setRecords(updated);
        safeLocalStorage.setItem('glucose_records', JSON.stringify(updated));
        setEditingId(null);
        setEditData({ glucose: '', food: '', amount: '', insulin: '' });
      }, [records, editData, calculateCarbs]);

      // 수정 취소
      const cancelEdit = useCallback(() => {
        setEditingId(null);
        setEditData({ glucose: '', food: '', amount: '', insulin: '' });
      }, []);

      // 로딩 중일 때
      if (!isLoaded) {
        return (
          <div className="loading">
            앱을 로딩 중입니다...
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gray-50">
          <div className="max-w-4xl mx-auto py-8 px-4">
            <header className="text-center mb-8">
              <h1 className="text-3xl font-bold text-gray-800 mb-2">
                DiaLife Pro 🍚
              </h1>
              <p className="text-gray-600">당뇨 관리를 위한 혈당 기록 앱</p>
            </header>

            {/* 새 기록 입력 */}
            <div className="bg-white shadow-lg rounded-xl p-6 mb-8">
              <h2 className="text-xl font-semibold mb-4 text-gray-800">새 기록 추가</h2>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    혈당 (mg/dL) *
                  </label>
                  <input 
                    type="number" 
                    className="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                    placeholder="혈당 수치를 입력하세요"
                    value={newRecord.glucose}
                    onChange={(e) => setNewRecord({ ...newRecord, glucose: e.target.value })} 
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    음식 이름 *
                  </label>
                  <input 
                    type="text" 
                    className="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                    placeholder="음식 이름을 입력하세요"
                    value={newRecord.food}
                    onChange={(e) => setNewRecord({ ...newRecord, food: e.target.value })} 
                    list="foodList"
                  />
                  <datalist id="foodList">
                    {Object.keys(FOOD_DATABASE).map(food => (
                      <option key={food} value={food} />
                    ))}
                  </datalist>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    섭취량 (g)
                  </label>
                  <input 
                    type="number" 
                    className="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                    placeholder="섭취량을 입력하세요"
                    value={newRecord.amount}
                    onChange={(e) => setNewRecord({ ...newRecord, amount: e.target.value })} 
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    인슐린 용량 (단위)
                  </label>
                  <input 
                    type="number" 
                    className="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                    placeholder="인슐린 용량을 입력하세요"
                    value={newRecord.insulin}
                    onChange={(e) => setNewRecord({ ...newRecord, insulin: e.target.value })} 
                  />
                </div>
              </div>
              
              {newRecord.food && FOOD_DATABASE[newRecord.food] && newRecord.amount && (
                <div className="mt-4 p-3 bg-blue-50 rounded-lg">
                  <p className="text-sm text-blue-700">
                    예상 탄수화물: <strong>{calculateCarbs(newRecord.food, newRecord.amount)}g</strong>
                  </p>
                </div>
              )}
              
              <button 
                onClick={handleSave} 
                className="w-full bg-blue-500 text-white rounded-lg py-3 px-4 mt-6 hover:bg-blue-600 transition-colors font-medium"
              >
                기록 저장하기
              </button>
            </div>

            {/* 기록 목록 */}
            <div className="bg-white shadow-lg rounded-xl p-6">
              <h2 className="text-xl font-semibold mb-4 text-gray-800">
                기록 목록 ({records.length}개)
              </h2>
              
              {records.length === 0 ? (
                <div className="text-center py-8">
                  <p className="text-gray-500 text-lg">아직 기록이 없습니다.</p>
                  <p className="text-gray-400 text-sm mt-2">위에서 첫 번째 기록을 추가해보세요!</p>
                </div>
              ) : (
                <div className="space-y-4">
                  {records.slice().reverse().map(record => (
                    <div key={record.id} className="bg-gray-50 border border-gray-200 rounded-xl p-4">
                      {editingId === record.id ? (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <input 
                            type="number" 
                            value={editData.glucose} 
                            onChange={(e) => setEditData({ ...editData, glucose: e.target.value })} 
                            className="border border-gray-300 p-2 rounded-lg" 
                            placeholder="혈당"
                          />
                          <input 
                            type="text" 
                            value={editData.food} 
                            onChange={(e) => setEditData({ ...editData, food: e.target.value })} 
                            className="border border-gray-300 p-2 rounded-lg" 
                            placeholder="음식"
                          />
                          <input 
                            type="number" 
                            value={editData.amount} 
                            onChange={(e) => setEditData({ ...editData, amount: e.target.value })} 
                            className="border border-gray-300 p-2 rounded-lg" 
                            placeholder="섭취량"
                          />
                          <input 
                            type="number" 
                            value={editData.insulin} 
                            onChange={(e) => setEditData({ ...editData, insulin: e.target.value })} 
                            className="border border-gray-300 p-2 rounded-lg" 
                            placeholder="인슐린"
                          />
                          <div className="col-span-full flex gap-2">
                            <button 
                              onClick={() => confirmEdit(record.id)} 
                              className="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors"
                            >
                              저장
                            </button>
                            <button 
                              onClick={cancelEdit} 
                              className="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors"
                            >
                              취소
                            </button>
                          </div>
                        </div>
                      ) : (
                        <div className="flex justify-between items-start">
                          <div className="flex-1">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                              <div>
                                <p className="text-lg"><strong>혈당:</strong> <span className="text-blue-600">{record.glucose} mg/dL</span></p>
                                <p><strong>음식:</strong> {record.food} ({record.amount || 0}g)</p>
                              </div>
                              <div>
                                <p><strong>탄수화물:</strong> <span className="text-green-600">{record.carbs || 0}g</span></p>
                                <p><strong>인슐린:</strong> {record.insulin || 0} 단위</p>
                              </div>
                            </div>
                            <p className="text-sm text-gray-500 mt-2">
                              {new Date(record.timestamp).toLocaleString('ko-KR', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                              })}
                            </p>
                          </div>
                          <div className="flex gap-2 ml-4">
                            <button 
                              onClick={() => startEdit(record)} 
                              className="text-blue-600 hover:text-blue-800 px-3 py-1 rounded hover:bg-blue-50 transition-colors"
                            >
                              수정
                            </button>
                            <button 
                              onClick={() => handleDelete(record.id)} 
                              className="text-red-600 hover:text-red-800 px-3 py-1 rounded hover:bg-red-50 transition-colors"
                            >
                              삭제
                            </button>
                          </div>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    // 에러 경계 처리
    class ErrorBoundary extends React.Component {
      constructor(props) {
        super(props);
        this.state = { hasError: false, error: null };
      }

      static getDerivedStateFromError(error) {
        return { hasError: true, error };
      }

      componentDidCatch(error, errorInfo) {
        console.error('React Error:', error, errorInfo);
      }

      render() {
        if (this.state.hasError) {
          return (
            <div className="max-w-2xl mx-auto py-10 px-4 text-center">
              <h1 className="text-2xl font-bold text-red-600 mb-4">오류가 발생했습니다</h1>
              <p className="text-gray-600 mb-4">페이지를 새로고침해 주세요.</p>
              <button 
                onClick={() => window.location.reload()} 
                className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
              >
                새로고침
              </button>
            </div>
          );
        }

        return this.props.children;
      }
    }

    // 앱 렌더링
    try {
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(
        <ErrorBoundary>
          <App />
        </ErrorBoundary>
      );
    } catch (error) {
      console.error('앱 초기화 실패:', error);
      document.getElementById('root').innerHTML = `
        <div style="text-align: center; padding: 50px;">
          <h1 style="color: red;">앱 로드에 실패했습니다</h1>
          <p>페이지를 새로고침해 주세요.</p>
          <button onclick="window.location.reload()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px;">
            새로고침
          </button>
        </div>
      `;
    }
  </script>
</body>
</html>
