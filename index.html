<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DiaLife Pro - í†µí•© ë‹¹ë‡¨ ê´€ë¦¬</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
      line-height: 1.6;
      color: #333;
      background-color: #f8fafc;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }

    .header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .header h1 {
      font-size: 2.5rem;
      font-weight: bold;
      color: #1f2937;
      margin-bottom: 0.5rem;
    }

    .header p {
      color: #6b7280;
      font-size: 1.1rem;
    }

    .card {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
      margin-bottom: 2rem;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-size: 0.875rem;
      font-weight: 500;
      color: #374151;
      margin-bottom: 0.25rem;
    }

    .form-group input, 
    .form-group select {
      padding: 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
      font-size: 1rem;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .btn-primary {
      background-color: #3b82f6;
      color: white;
    }

    .btn-primary:hover {
      background-color: #2563eb;
    }

    .btn-success {
      background-color: #10b981;
      color: white;
    }

    .btn-success:hover {
      background-color: #059669;
    }

    .btn-secondary {
      background-color: #6b7280;
      color: white;
    }

    .btn-secondary:hover {
      background-color: #4b5563;
    }

    .btn-danger {
      background-color: #ef4444;
      color: white;
    }

    .btn-danger:hover {
      background-color: #dc2626;
    }

    .btn-small {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }

    .btn-full {
      width: 100%;
    }

    .carb-preview {
      margin-top: 1rem;
      padding: 0.75rem;
      background-color: #eff6ff;
      border: 1px solid #bfdbfe;
      border-radius: 0.5rem;
      color: #1e40af;
    }

    .record-list {
      margin-top: 2rem;
    }

    .record-item {
      background-color: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 0.75rem;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .record-content {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .record-info {
      flex: 1;
    }

    .record-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 0.5rem;
    }

    .record-actions {
      display: flex;
      gap: 0.5rem;
      margin-left: 1rem;
    }

    .timestamp {
      font-size: 0.875rem;
      color: #6b7280;
      margin-top: 0.5rem;
    }

    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: #6b7280;
    }

    .empty-state h3 {
      font-size: 1.25rem;
      margin-bottom: 0.5rem;
    }

    .edit-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .edit-actions {
      display: flex;
      gap: 0.5rem;
      grid-column: 1 / -1;
    }

    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 50vh;
      font-size: 1.125rem;
      color: #6b7280;
    }

    .error {
      background-color: #fef2f2;
      border: 1px solid #fecaca;
      color: #b91c1c;
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
    }

    @media (max-width: 768px) {
      .container {
        padding: 1rem 0.5rem;
      }
      
      .header h1 {
        font-size: 2rem;
      }
      
      .record-content {
        flex-direction: column;
      }
      
      .record-actions {
        margin-left: 0;
        margin-top: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>DiaLife Pro ğŸš</h1>
      <p>ë‹¹ë‡¨ ê´€ë¦¬ë¥¼ ìœ„í•œ í˜ˆë‹¹ ê¸°ë¡ ì•±</p>
    </header>

    <div id="app">
      <div class="loading">ì•±ì„ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...</div>
    </div>
  </div>

  <script>
    // ìŒì‹ ë°ì´í„°ë² ì´ìŠ¤
    const FOOD_DATABASE = {
      'ë°¥': { carbs: 23, category: 'ì£¼ì‹' },
      'ì‚¬ê³¼': { carbs: 14, category: 'ê³¼ì¼' },
      'ë°”ë‚˜ë‚˜': { carbs: 23, category: 'ê³¼ì¼' },
      'ë¼ë©´': { carbs: 55, category: 'ë©´ë¥˜' },
      'ì´ˆì½œë¦¿': { carbs: 57, category: 'ê°„ì‹' },
      'ë¹µ': { carbs: 50, category: 'ì£¼ì‹' },
      'ìš°ìœ ': { carbs: 5, category: 'ìœ ì œí’ˆ' },
      'ê°ì': { carbs: 17, category: 'ì±„ì†Œ' },
      'ê³ êµ¬ë§ˆ': { carbs: 20, category: 'ì±„ì†Œ' },
      'ë‹­ê°€ìŠ´ì‚´': { carbs: 0, category: 'ë‹¨ë°±ì§ˆ' }
    };

    // ì•± ìƒíƒœ
    let appState = {
      records: [],
      editingId: null,
      isLoading: true
    };

    // localStorage ì•ˆì „ ì ‘ê·¼
    const storage = {
      get: function(key) {
        try {
          if (typeof Storage !== 'undefined') {
            const item = localStorage.getItem(key);
            return item ? JSON.parse(item) : null;
          }
        } catch (error) {
          console.warn('Storage ì½ê¸° ì‹¤íŒ¨:', error);
        }
        return null;
      },
      set: function(key, value) {
        try {
          if (typeof Storage !== 'undefined') {
            localStorage.setItem(key, JSON.stringify(value));
            return true;
          }
        } catch (error) {
          console.warn('Storage ì €ì¥ ì‹¤íŒ¨:', error);
        }
        return false;
      }
    };

    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
    function calculateCarbs(food, amount) {
      if (!food || !amount || !FOOD_DATABASE[food]) return 0;
      const numAmount = parseFloat(amount);
      if (isNaN(numAmount)) return 0;
      return Math.round((FOOD_DATABASE[food].carbs * numAmount) / 100);
    }

    function formatDate(timestamp) {
      return new Date(timestamp).toLocaleString('ko-KR', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function generateId() {
      return Date.now() + Math.random();
    }

    // DOM ì¡°ì‘ í•¨ìˆ˜ë“¤
    function createElement(tag, className, content) {
      const element = document.createElement(tag);
      if (className) element.className = className;
      if (content) element.innerHTML = content;
      return element;
    }

    function clearElement(element) {
      while (element.firstChild) {
        element.removeChild(element.firstChild);
      }
    }

    // ì•± ë Œë”ë§
    function renderApp() {
      const appElement = document.getElementById('app');
      clearElement(appElement);

      if (appState.isLoading) {
        appElement.appendChild(createElement('div', 'loading', 'ì•±ì„ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...'));
        return;
      }

      // ìƒˆ ê¸°ë¡ í¼
      const formCard = createElement('div', 'card');
      formCard.innerHTML = `
        <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: #1f2937;">ìƒˆ ê¸°ë¡ ì¶”ê°€</h2>
        <form id="recordForm">
          <div class="form-grid">
            <div class="form-group">
              <label for="glucose">í˜ˆë‹¹ (mg/dL) *</label>
              <input type="number" id="glucose" name="glucose" placeholder="í˜ˆë‹¹ ìˆ˜ì¹˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
            </div>
            <div class="form-group">
              <label for="food">ìŒì‹ ì´ë¦„ *</label>
              <input type="text" id="food" name="food" placeholder="ìŒì‹ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" list="foodList" required>
              <datalist id="foodList">
                ${Object.keys(FOOD_DATABASE).map(food => `<option value="${food}">`).join('')}
              </datalist>
            </div>
            <div class="form-group">
              <label for="amount">ì„­ì·¨ëŸ‰ (g)</label>
              <input type="number" id="amount" name="amount" placeholder="ì„­ì·¨ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <div class="form-group">
              <label for="insulin">ì¸ìŠë¦° ìš©ëŸ‰ (ë‹¨ìœ„)</label>
              <input type="number" id="insulin" name="insulin" placeholder="ì¸ìŠë¦° ìš©ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>
          </div>
          <div id="carbPreview"></div>
          <button type="submit" class="btn btn-primary btn-full" style="margin-top: 1rem;">ê¸°ë¡ ì €ì¥í•˜ê¸°</button>
        </form>
      `;

      // ê¸°ë¡ ëª©ë¡
      const recordsCard = createElement('div', 'card');
      recordsCard.innerHTML = `
        <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: #1f2937;">
          ê¸°ë¡ ëª©ë¡ (${appState.records.length}ê°œ)
        </h2>
        <div id="recordsList"></div>
      `;

      appElement.appendChild(formCard);
      appElement.appendChild(recordsCard);

      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
      setupEventListeners();
      renderRecords();
      updateCarbPreview();
    }

    function renderRecords() {
      const recordsList = document.getElementById('recordsList');
      clearElement(recordsList);

      if (appState.records.length === 0) {
        recordsList.appendChild(createElement('div', 'empty-state', `
          <h3>ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</h3>
          <p>ìœ„ì—ì„œ ì²« ë²ˆì§¸ ê¸°ë¡ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>
        `));
        return;
      }

      // ìµœì‹  ìˆœìœ¼ë¡œ ì •ë ¬
      const sortedRecords = [...appState.records].reverse();
      
      sortedRecords.forEach(record => {
        const recordElement = createElement('div', 'record-item');
        
        if (appState.editingId === record.id) {
          recordElement.innerHTML = `
            <form id="editForm-${record.id}" class="edit-form">
              <input type="number" name="glucose" value="${record.glucose || ''}" placeholder="í˜ˆë‹¹" required>
              <input type="text" name="food" value="${record.food || ''}" placeholder="ìŒì‹" required>
              <input type="number" name="amount" value="${record.amount || ''}" placeholder="ì„­ì·¨ëŸ‰">
              <input type="number" name="insulin" value="${record.insulin || ''}" placeholder="ì¸ìŠë¦°">
              <div class="edit-actions">
                <button type="submit" class="btn btn-success btn-small">ì €ì¥</button>
                <button type="button" class="btn btn-secondary btn-small" onclick="cancelEdit()">ì·¨ì†Œ</button>
              </div>
            </form>
          `;
        } else {
          recordElement.innerHTML = `
            <div class="record-content">
              <div class="record-info">
                <div class="record-grid">
                  <div>
                    <p><strong>í˜ˆë‹¹:</strong> <span style="color: #3b82f6;">${record.glucose || 0} mg/dL</span></p>
                    <p><strong>ìŒì‹:</strong> ${record.food || ''} (${record.amount || 0}g)</p>
                  </div>
                  <div>
                    <p><strong>íƒ„ìˆ˜í™”ë¬¼:</strong> <span style="color: #10b981;">${record.carbs || 0}g</span></p>
                    <p><strong>ì¸ìŠë¦°:</strong> ${record.insulin || 0} ë‹¨ìœ„</p>
                  </div>
                </div>
                <div class="timestamp">${formatDate(record.timestamp)}</div>
              </div>
              <div class="record-actions">
                <button class="btn btn-primary btn-small" onclick="editRecord(${record.id})">ìˆ˜ì •</button>
                <button class="btn btn-danger btn-small" onclick="deleteRecord(${record.id})">ì‚­ì œ</button>
              </div>
            </div>
          `;
        }
        
        recordsList.appendChild(recordElement);
      });
    }

    function updateCarbPreview() {
      const foodInput = document.getElementById('food');
      const amountInput = document.getElementById('amount');
      const carbPreview = document.getElementById('carbPreview');
      
      if (!foodInput || !amountInput || !carbPreview) return;
      
      const food = foodInput.value;
      const amount = amountInput.value;
      
      if (food && FOOD_DATABASE[food] && amount) {
        const carbs = calculateCarbs(food, amount);
        carbPreview.innerHTML = `
          <div class="carb-preview">
            ì˜ˆìƒ íƒ„ìˆ˜í™”ë¬¼: <strong>${carbs}g</strong>
          </div>
        `;
      } else {
        carbPreview.innerHTML = '';
      }
    }

    function setupEventListeners() {
      // í¼ ì œì¶œ
      const recordForm = document.getElementById('recordForm');
      if (recordForm) {
        recordForm.addEventListener('submit', handleFormSubmit);
      }

      // íƒ„ìˆ˜í™”ë¬¼ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
      const foodInput = document.getElementById('food');
      const amountInput = document.getElementById('amount');
      
      if (foodInput) {
        foodInput.addEventListener('input', updateCarbPreview);
      }
      if (amountInput) {
        amountInput.addEventListener('input', updateCarbPreview);
      }
    }

    function handleFormSubmit(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const glucose = formData.get('glucose');
      const food = formData.get('food');
      const amount = formData.get('amount') || 0;
      const insulin = formData.get('insulin') || 0;
      
      if (!glucose || !food) {
        alert('í˜ˆë‹¹ê³¼ ìŒì‹ ì´ë¦„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
        return;
      }

      const record = {
        id: generateId(),
        glucose: glucose,
        food: food,
        amount: amount,
        insulin: insulin,
        carbs: calculateCarbs(food, amount),
        timestamp: new Date().toISOString()
      };

      appState.records.push(record);
      storage.set('glucose_records', appState.records);
      
      // í¼ ì´ˆê¸°í™”
      event.target.reset();
      updateCarbPreview();
      renderRecords();
    }

    // ì „ì—­ í•¨ìˆ˜ë“¤ (ì¸ë¼ì¸ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ìš©)
    window.editRecord = function(id) {
      appState.editingId = id;
      renderRecords();
      
      // ìˆ˜ì • í¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
      const editForm = document.getElementById(`editForm-${id}`);
      if (editForm) {
        editForm.addEventListener('submit', function(event) {
          event.preventDefault();
          
          const formData = new FormData(event.target);
          const glucose = formData.get('glucose');
          const food = formData.get('food');
          const amount = formData.get('amount') || 0;
          const insulin = formData.get('insulin') || 0;
          
          if (!glucose || !food) {
            alert('í˜ˆë‹¹ê³¼ ìŒì‹ ì´ë¦„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
            return;
          }

          appState.records = appState.records.map(record => 
            record.id === id ? {
              ...record,
              glucose: glucose,
              food: food,
              amount: amount,
              insulin: insulin,
              carbs: calculateCarbs(food, amount)
            } : record
          );
          
          storage.set('glucose_records', appState.records);
          appState.editingId = null;
          renderRecords();
        });
      }
    };

    window.cancelEdit = function() {
      appState.editingId = null;
      renderRecords();
    };

    window.deleteRecord = function(id) {
      if (!confirm('ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      
      appState.records = appState.records.filter(record => record.id !== id);
      storage.set('glucose_records', appState.records);
      renderRecords();
    };

    // ì•± ì´ˆê¸°í™”
    function initApp() {
      try {
        // ë°ì´í„° ë¡œë“œ
        const savedRecords = storage.get('glucose_records');
        if (savedRecords && Array.isArray(savedRecords)) {
          appState.records = savedRecords;
        }
        
        appState.isLoading = false;
        renderApp();
      } catch (error) {
        console.error('ì•± ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        document.getElementById('app').innerHTML = `
          <div class="error">
            <h3>ì•± ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</h3>
            <p>í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ ì£¼ì„¸ìš”.</p>
            <button onclick="window.location.reload()" class="btn btn-primary">ìƒˆë¡œê³ ì¹¨</button>
          </div>
        `;
      }
    }

    // DOM ë¡œë“œ ì™„ë£Œ í›„ ì•± ì‹œì‘
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initApp);
    } else {
      initApp();
    }
  </script>
</body>
</html>
