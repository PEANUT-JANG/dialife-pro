<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DiaLife Pro - AI 기반 1형당뇨 개인화 관리 시스템</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
      line-height: 1.6;
      color: #333;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .auth-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 1rem;
    }

    .auth-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 2rem;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
      padding: 3rem;
      width: 100%;
      max-width: 500px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      text-align: center;
    }

    .auth-header {
      margin-bottom: 2rem;
    }

    .auth-header h1 {
      font-size: 2.5rem;
      font-weight: bold;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.5rem;
    }

    .auth-header p {
      color: #6b7280;
      font-size: 1.1rem;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1rem;
    }

    .header {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 1rem;
      padding: 1.5rem;
      margin-bottom: 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
    }

    .header-left h1 {
      font-size: 2rem;
      font-weight: bold;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      margin-bottom: 0.25rem;
    }

    .header-left .welcome {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .user-info {
      text-align: right;
    }

    .user-info .user-name {
      font-weight: 600;
      font-size: 1.1rem;
    }

    .user-info .user-stats {
      font-size: 0.9rem;
      opacity: 0.8;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 1rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .card h2 {
      font-size: 1.4rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: #1f2937;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-size: 0.875rem;
      font-weight: 500;
      color: #374151;
      margin-bottom: 0.25rem;
    }

    .form-group input, 
    .form-group select,
    .form-group textarea {
      padding: 0.75rem;
      border: 2px solid #e5e7eb;
      border-radius: 0.5rem;
      font-size: 1rem;
      transition: all 0.2s;
      background: white;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    .btn-success {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
    }

    .btn-ai {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      color: white;
    }

    .btn-logout {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
    }

    .btn-full {
      width: 100%;
      justify-content: center;
    }

    .btn-small {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }

    .stats-dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: linear-gradient(135deg, #f8fafc, #e2e8f0);
      padding: 1.5rem;
      border-radius: 1rem;
      text-align: center;
      border: 1px solid #e2e8f0;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
    }

    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: #1f2937;
      margin-bottom: 0.25rem;
    }

    .stat-label {
      font-size: 0.875rem;
      color: #6b7280;
    }

    .tab-container {
      margin-bottom: 2rem;
    }

    .tab-buttons {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      border-radius: 1rem;
      padding: 0.5rem;
      flex-wrap: wrap;
    }

    .tab-button {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.75rem;
      background: transparent;
      color: white;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
      font-size: 0.9rem;
    }

    .tab-button.active {
      background: rgba(255, 255, 255, 0.95);
      color: #1f2937;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .full-width {
      grid-column: 1 / -1;
    }

    .hidden {
      display: none;
    }

    .food-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .food-suggestion {
      padding: 0.75rem;
      cursor: pointer;
      border-bottom: 1px solid #f3f4f6;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .food-suggestion:hover {
      background: #f9fafb;
    }

    .food-suggestion:last-child {
      border-bottom: none;
    }

    .food-search {
      position: relative;
    }

    .preview-box {
      background: linear-gradient(135deg, #eff6ff, #dbeafe);
      border: 2px solid #3b82f6;
      border-radius: 1rem;
      padding: 1rem;
      margin-top: 1rem;
    }

    .personal-analysis {
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      border: 2px solid #0284c7;
      border-radius: 1rem;
      padding: 1rem;
      margin-top: 1rem;
    }

    .ai-recommendations {
      background: linear-gradient(135deg, #f3e8ff, #e9d5ff);
      border: 2px solid #8b5cf6;
      border-radius: 1rem;
      padding: 1.5rem;
      margin-top: 1rem;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .modal-content {
      background: white;
      border-radius: 1rem;
      padding: 2rem;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }

    @media (max-width: 1024px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
      
      .header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 0.5rem;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .stats-dashboard {
        grid-template-columns: repeat(2, 1fr);
      }

      .tab-buttons {
        flex-wrap: wrap;
      }

      .tab-button {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="loading" style="display: flex; justify-content: center; align-items: center; min-height: 100vh; color: white;">
      <h2>시스템을 초기화하는 중입니다...</h2>
    </div>
  </div>

  <script>
    // 확장된 한국 음식 데이터베이스
    let KOREAN_FOOD_DATABASE = {
      // 주식류
      '쌀밥': { carbs: 23, protein: 2.5, fat: 0.3, category: '주식', serving: 100, glycemicIndex: 73, source: '식약처' },
      '백미밥': { carbs: 23, protein: 2.5, fat: 0.3, category: '주식', serving: 100, glycemicIndex: 73, source: '식약처' },
      '현미밥': { carbs: 22, protein: 2.8, fat: 0.9, category: '주식', serving: 100, glycemicIndex: 56, source: '식약처' },
      '보리밥': { carbs: 21, protein: 3.2, fat: 0.7, category: '주식', serving: 100, glycemicIndex: 25, source: '식약처' },
      '김밥': { carbs: 35, protein: 6, fat: 4, category: '주식', serving: 100, glycemicIndex: 65, source: '식약처' },
      '주먹밥': { carbs: 25, protein: 3, fat: 1, category: '주식', serving: 100, glycemicIndex: 70, source: '식약처' },
      '비빔밥': { carbs: 40, protein: 8, fat: 7, category: '주식', serving: 100, glycemicIndex: 62, source: '식약처' },
      '볶음밥': { carbs: 35, protein: 7, fat: 8, category: '주식', serving: 100, glycemicIndex: 68, source: '식약처' },
      
      // 면류
      '라면': { carbs: 55, protein: 9, fat: 16, category: '면류', serving: 100, glycemicIndex: 73, source: '식약처' },
      '짜파게티': { carbs: 58, protein: 9, fat: 17, category: '면류', serving: 100, glycemicIndex: 70, source: '제품' },
      '냉면': { carbs: 19, protein: 4, fat: 0.5, category: '면류', serving: 100, glycemicIndex: 40, source: '식약처' },
      '우동': { carbs: 21, protein: 3, fat: 0.4, category: '면류', serving: 100, glycemicIndex: 55, source: '식약처' },
      '짜장면': { carbs: 45, protein: 8, fat: 10, category: '면류', serving: 100, glycemicIndex: 65, source: '식약처' },
      '짬뽕': { carbs: 42, protein: 12, fat: 8, category: '면류', serving: 100, glycemicIndex: 63, source: '식약처' },
      '칼국수': { carbs: 35, protein: 6, fat: 2, category: '면류', serving: 100, glycemicIndex: 58, source: '식약처' },
      '스파게티': { carbs: 48, protein: 8, fat: 6, category: '면류', serving: 100, glycemicIndex: 60, source: '식약처' },
      
      // 빵류
      '식빵': { carbs: 47, protein: 8, fat: 4, category: '빵류', serving: 100, glycemicIndex: 75, source: '식약처' },
      '크로와상': { carbs: 45, protein: 7, fat: 21, category: '빵류', serving: 100, glycemicIndex: 67, source: '식약처' },
      '베이글': { carbs: 48, protein: 10, fat: 1.5, category: '빵류', serving: 100, glycemicIndex: 72, source: '식약처' },
      '소보로빵': { carbs: 52, protein: 7, fat: 15, category: '빵류', serving: 100, glycemicIndex: 68, source: '식약처' },
      '단팥빵': { carbs: 55, protein: 8, fat: 3, category: '빵류', serving: 100, glycemicIndex: 70, source: '식약처' },
      
      // 과일류
      '사과': { carbs: 14, protein: 0.3, fat: 0.2, category: '과일', serving: 100, glycemicIndex: 36, source: '식약처' },
      '배': { carbs: 11, protein: 0.3, fat: 0.1, category: '과일', serving: 100, glycemicIndex: 33, source: '식약처' },
      '바나나': { carbs: 23, protein: 1, fat: 0.2, category: '과일', serving: 100, glycemicIndex: 51, source: '식약처' },
      '오렌지': { carbs: 12, protein: 0.9, fat: 0.1, category: '과일', serving: 100, glycemicIndex: 42, source: '식약처' },
      '포도': { carbs: 16, protein: 0.6, fat: 0.2, category: '과일', serving: 100, glycemicIndex: 46, source: '식약처' },
      '수박': { carbs: 8, protein: 0.6, fat: 0.2, category: '과일', serving: 100, glycemicIndex: 72, source: '식약처' },
      '딸기': { carbs: 8, protein: 0.7, fat: 0.3, category: '과일', serving: 100, glycemicIndex: 40, source: '식약처' },
      
      // 채소류
      '김치': { carbs: 3, protein: 1.1, fat: 0.4, category: '채소', serving: 100, glycemicIndex: 15, source: '식약처' },
      '배추김치': { carbs: 3, protein: 1.1, fat: 0.4, category: '채소', serving: 100, glycemicIndex: 15, source: '식약처' },
      '무': { carbs: 2, protein: 0.5, fat: 0.1, category: '채소', serving: 100, glycemicIndex: 10, source: '식약처' },
      '당근': { carbs: 8, protein: 0.7, fat: 0.2, category: '채소', serving: 100, glycemicIndex: 47, source: '식약처' },
      '감자': { carbs: 17, protein: 2, fat: 0.1, category: '채소', serving: 100, glycemicIndex: 62, source: '식약처' },
      '고구마': { carbs: 20, protein: 1.2, fat: 0.2, category: '채소', serving: 100, glycemicIndex: 48, source: '식약처' },
      '옥수수': { carbs: 19, protein: 3.2, fat: 1.2, category: '채소', serving: 100, glycemicIndex: 52, source: '식약처' },
      
      // 육류
      '닭가슴살': { carbs: 0, protein: 23, fat: 1.2, category: '육류', serving: 100, glycemicIndex: 0, source: '식약처' },
      '삼겹살': { carbs: 0, protein: 17, fat: 28, category: '육류', serving: 100, glycemicIndex: 0, source: '식약처' },
      '소고기': { carbs: 0, protein: 21, fat: 12, category: '육류', serving: 100, glycemicIndex: 0, source: '식약처' },
      
      // 계란/두부
      '계란': { carbs: 0.7, protein: 13, fat: 11, category: '단백질', serving: 100, glycemicIndex: 0, source: '식약처' },
      '두부': { carbs: 2, protein: 8, fat: 4, category: '단백질', serving: 100, glycemicIndex: 15, source: '식약처' },
      
      // 유제품
      '우유': { carbs: 5, protein: 3.3, fat: 3.2, category: '유제품', serving: 100, glycemicIndex: 39, source: '식약처' },
      '요구르트': { carbs: 7, protein: 3.5, fat: 3, category: '유제품', serving: 100, glycemicIndex: 41, source: '식약처' },
      '치즈': { carbs: 1, protein: 25, fat: 33, category: '유제품', serving: 100, glycemicIndex: 0, source: '식약처' },
      
      // 간식류
      '초콜릿': { carbs: 57, protein: 4, fat: 31, category: '간식', serving: 100, glycemicIndex: 40, source: '식약처' },
      '쿠키': { carbs: 67, protein: 6, fat: 24, category: '간식', serving: 100, glycemicIndex: 77, source: '식약처' },
      '아이스크림': { carbs: 24, protein: 3, fat: 11, category: '간식', serving: 100, glycemicIndex: 51, source: '식약처' },
      '떡': { carbs: 44, protein: 4, fat: 0.5, category: '간식', serving: 100, glycemicIndex: 83, source: '식약처' },
      
      // 음료
      '콜라': { carbs: 11, protein: 0, fat: 0, category: '음료', serving: 100, glycemicIndex: 63, source: '식약처' },
      '사이다': { carbs: 10, protein: 0, fat: 0, category: '음료', serving: 100, glycemicIndex: 68, source: '식약처' },
      '오렌지주스': { carbs: 11, protein: 0.7, fat: 0.2, category: '음료', serving: 100, glycemicIndex: 50, source: '식약처' },
      
      // 패스트푸드
      '햄버거': { carbs: 33, protein: 13, fat: 10, category: '패스트푸드', serving: 100, glycemicIndex: 66, source: '추정치' },
      '피자': { carbs: 33, protein: 11, fat: 10, category: '패스트푸드', serving: 100, glycemicIndex: 60, source: '추정치' },
      '치킨': { carbs: 15, protein: 18, fat: 15, category: '패스트푸드', serving: 100, glycemicIndex: 45, source: '추정치' },
      
      // 한식
      '된장찌개': { carbs: 7, protein: 5, fat: 3, category: '국/찌개', serving: 100, glycemicIndex: 33, source: '식약처' },
      '김치찌개': { carbs: 5, protein: 8, fat: 4, category: '국/찌개', serving: 100, glycemicIndex: 35, source: '식약처' },
      '불고기': { carbs: 10, protein: 18, fat: 8, category: '반찬', serving: 100, glycemicIndex: 25, source: '식약처' }
    };

    // 사용자 관리 시스템
    class UserManager {
      constructor() {
        this.currentUser = null;
        this.users = this.loadUsers();
      }

      loadUsers() {
        try {
          const stored = localStorage.getItem('dialife_users_v4');
          return stored ? JSON.parse(stored) : {};
        } catch (error) {
          console.warn('사용자 데이터 로드 실패:', error);
          return {};
        }
      }

      saveUsers() {
        try {
          localStorage.setItem('dialife_users_v4', JSON.stringify(this.users));
        } catch (error) {
          console.warn('사용자 데이터 저장 실패:', error);
        }
      }

      register(userData) {
        const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const user = {
          id: userId,
          ...userData,
          createdAt: new Date().toISOString(),
          lastLogin: new Date().toISOString(),
          records: [],
          preferences: {
            targetGlucose: { min: 80, max: 180 },
            targetA1C: 7.0,
            insulinType: 'rapid'
          },
          personalizedData: {
            totalRecords: 0,
            avgGlucose: 0,
            timeInRange: 0,
            personalICR: 15,
            personalISF: 50,
            foodReactions: {}
          }
        };
        
        this.users[userId] = user;
        this.saveUsers();
        return user;
      }

      login(username, password) {
        const user = Object.values(this.users).find(u => 
          u.username === username && u.password === password
        );
        
        if (user) {
          user.lastLogin = new Date().toISOString();
          this.currentUser = user;
          this.saveUsers();
          return user;
        }
        return null;
      }

      getCurrentUser() {
        return this.currentUser;
      }

      addRecord(record) {
        if (this.currentUser) {
          this.currentUser.records.push(record);
          this.updatePersonalizedData();
          this.saveUsers();
        }
      }

      updatePersonalizedData() {
        if (!this.currentUser) return;

        const records = this.currentUser.records;
        const personalizedData = this.currentUser.personalizedData;

        personalizedData.totalRecords = records.length;
        
        if (records.length > 0) {
          const glucoseValues = records.map(r => parseFloat(r.glucose || 0));
          personalizedData.avgGlucose = Math.round(
            glucoseValues.reduce((sum, val) => sum + val, 0) / glucoseValues.length
          );

          // 목표 범위 시간 계산 (TIR: Time In Range)
          const targetRange = records.filter(r => {
            const glucose = parseFloat(r.glucose);
            return glucose >= 80 && glucose <= 180;
          });
          personalizedData.timeInRange = Math.round((targetRange.length / records.length) * 100);

          // 음식별 반응 패턴 분석
          this.analyzeFoodReactions();
        }
      }

      analyzeFoodReactions() {
        const records = this.currentUser.records;
        const foodReactions = {};

        records.forEach(record => {
          const food = record.food;
          if (!food) return;

          if (!foodReactions[food]) {
            foodReactions[food] = {
              count: 0,
              avgGlucose: 0,
              glucoseValues: [],
              avgInsulin: 0,
              avgCarbs: 0
            };
          }

          const reaction = foodReactions[food];
          reaction.count++;
          reaction.glucoseValues.push(parseFloat(record.glucose || 0));
          reaction.avgGlucose = Math.round(
            reaction.glucoseValues.reduce((a, b) => a + b, 0) / reaction.glucoseValues.length
          );
          reaction.avgInsulin = Math.round((reaction.avgInsulin * (reaction.count - 1) + parseFloat(record.insulin || 0)) / reaction.count * 10) / 10;
          reaction.avgCarbs = Math.round((reaction.avgCarbs * (reaction.count - 1) + parseFloat(record.carbs || 0)) / reaction.count);
        });

        this.currentUser.personalizedData.foodReactions = foodReactions;
      }
    }

    // AI 엔진
    class PersonalizedAIEngine {
      calculatePersonalizedInsulin(glucose, carbs, personalData) {
        const baseICR = 15;
        const baseISF = 50;
        
        let personalICR = personalData.personalICR || baseICR;
        let personalISF = personalData.personalISF || baseISF;
        
        const carbInsulin = carbs / personalICR;
        const correctionInsulin = glucose > 120 ? (glucose - 120) / personalISF : 0;
        
        return {
          carbInsulin: Math.round(carbInsulin * 10) / 10,
          correctionInsulin: Math.round(correctionInsulin * 10) / 10,
          total: Math.round((carbInsulin + correctionInsulin) * 10) / 10,
          confidence: Math.min((personalData.totalRecords || 0) * 10, 100),
          personalICR: personalICR,
          personalISF: personalISF
        };
      }
    }

    // 글로벌 변수
    let userManager = new UserManager();
    let aiEngine = new PersonalizedAIEngine();
    let currentTab = 'dashboard';
    let calculationResult = null;

    // 사용자 음식 데이터 로드
    function loadUserFoods() {
      const userFoods = localStorage.getItem('dialife_user_foods');
      if (userFoods) {
        try {
          const parsed = JSON.parse(userFoods);
          Object.assign(KOREAN_FOOD_DATABASE, parsed);
        } catch (error) {
          console.warn('사용자 음식 데이터 로드 실패:', error);
        }
      }
    }

    // 사용자 음식 저장
    function saveUserFood(foodName, nutritionData) {
      const userFoods = localStorage.getItem('dialife_user_foods');
      const foods = userFoods ? JSON.parse(userFoods) : {};
      foods[foodName] = nutritionData;
      localStorage.setItem('dialife_user_foods', JSON.stringify(foods));
      KOREAN_FOOD_DATABASE[foodName] = nutritionData;
    }

    // AI 영양소 추정
    function estimateNutrition(foodName) {
      const defaultEstimate = {
        carbs: 30,
        protein: 5,
        fat: 5,
        category: '추정치',
        serving: 100,
        glycemicIndex: 50,
        source: 'AI추정'
      };
      
      if (foodName.includes('밥') || foodName.includes('면') || foodName.includes('빵')) {
        defaultEstimate.carbs = 40;
        defaultEstimate.glycemicIndex = 65;
      } else if (foodName.includes('고기') || foodName.includes('육') || foodName.includes('닭')) {
        defaultEstimate.carbs = 0;
        defaultEstimate.protein = 20;
        defaultEstimate.fat = 10;
        defaultEstimate.glycemicIndex = 0;
      } else if (foodName.includes('채소') || foodName.includes('나물')) {
        defaultEstimate.carbs = 5;
        defaultEstimate.protein = 2;
        defaultEstimate.fat = 0.5;
        defaultEstimate.glycemicIndex = 20;
      } else if (foodName.includes('과일')) {
        defaultEstimate.carbs = 15;
        defaultEstimate.protein = 1;
        defaultEstimate.fat = 0.2;
        defaultEstimate.glycemicIndex = 45;
      }
      
      return defaultEstimate;
    }

    // 음식 검색 함수
    function searchFood(query) {
      if (!query || query.length < 1) return [];
      
      const lowerQuery = query.toLowerCase();
      const results = [];
      
      Object.keys(KOREAN_FOOD_DATABASE).forEach(food => {
        if (food.toLowerCase().includes(lowerQuery)) {
          results.push({
            name: food,
            data: KOREAN_FOOD_DATABASE[food]
          });
        }
      });
      
      return results.slice(0, 10);
    }

    // 사용자 정의 음식 다이얼로그
    function showCustomFoodDialog(context, foodName) {
      const estimated = estimateNutrition(foodName);
      
      const dialog = document.createElement('div');
      dialog.className = 'modal-overlay';
      
      dialog.innerHTML = `
        <div class="modal-content">
          <h2 style="margin-bottom: 1rem; color: #1f2937;">음식 정보 입력</h2>
          <p style="margin-bottom: 1rem; color: #6b7280;">
            "<strong>${foodName}</strong>"의 영양 정보를 입력해주세요.
            <br>AI 추정치가 제공되며, 직접 수정 가능합니다.
          </p>
          
          <div class="form-grid">
            <div class="form-group">
              <label for="customCarbs">탄수화물 (g/100g) *</label>
              <input type="number" id="customCarbs" value="${estimated.carbs}" min="0" step="0.1">
              <small style="color: #6b7280;">AI 추정치: ${estimated.carbs}g</small>
            </div>
            
            <div class="form-group">
              <label for="customProtein">단백질 (g/100g)</label>
              <input type="number" id="customProtein" value="${estimated.protein}" min="0" step="0.1">
            </div>
            
            <div class="form-group">
              <label for="customFat">지방 (g/100g)</label>
              <input type="number" id="customFat" value="${estimated.fat}" min="0" step="0.1">
            </div>
            
            <div class="form-group">
              <label for="customGI">혈당지수 (GI)</label>
              <input type="number" id="customGI" value="${estimated.glycemicIndex}" min="0" max="100">
            </div>
          </div>
          
          <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
            <button onclick="saveCustomFood('${context}', '${foodName}')" class="btn btn-success btn-full">
              저장 및 사용
            </button>
            <button onclick="closeCustomFoodDialog()" class="btn btn-primary">
              취소
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(dialog);
    }

    // 사용자 정의 음식 저장
    function saveCustomFood(context, foodName) {
      const carbs = parseFloat(document.getElementById('customCarbs').value) || 0;
      const protein = parseFloat(document.getElementById('customProtein').value) || 0;
      const fat = parseFloat(document.getElementById('customFat').value) || 0;
      const glycemicIndex = parseInt(document.getElementById('customGI').value) || 50;
      
      if (carbs <= 0) {
        alert('탄수화물 정보는 필수입니다.');
        return;
      }
      
      const nutritionData = {
        carbs: carbs,
        protein: protein,
        fat: fat,
        category: '사용자입력',
        serving: 100,
        glycemicIndex: glycemicIndex,
        source: '사용자입력'
      };
      
      saveUserFood(foodName, nutritionData);
      
      if (context === 'calc') {
        document.getElementById('calcFood').value = foodName;
        hideCalculatorFoodSuggestions();
        updateCalculatorPreview();
      }
      
      closeCustomFoodDialog();
      alert(`"${foodName}" 정보가 저장되었습니다.`);
    }

    // 다이얼로그 닫기
    function closeCustomFoodDialog() {
      const dialog = document.querySelector('.modal-overlay');
      if (dialog) {
        dialog.remove();
      }
    }

    // 계산기 음식 검색 표시
    function showCalculatorFoodSuggestions(query) {
      const suggestions = searchFood(query);
      const container = document.getElementById('calcFoodSuggestions');
      
      if (!container) return;
      
      // 검색 결과가 없으면 사용자 입력 옵션 제공
      if (suggestions.length === 0 && query.length > 0) {
        container.innerHTML = `
          <div class="food-suggestion" style="background: #f3f4f6;">
            <div>
              <strong>"${query}"에 대한 검색 결과가 없습니다</strong>
              <br>
              <small style="color: #6b7280;">클릭하여 직접 영양 정보를 입력하거나 AI 추정치를 사용하세요</small>
            </div>
            <button onclick="showCustomFoodDialog('calc', '${query}')" class="btn btn-primary btn-small">
              직접 입력
            </button>
          </div>
        `;
        container.style.display = 'block';
        return;
      }
      
      if (suggestions.length === 0) {
        hideCalculatorFoodSuggestions();
        return;
      }
      
      container.innerHTML = suggestions.map(item => `
        <div class="food-suggestion" onclick="selectCalculatorFood('${item.name}')">
          <div>
            <strong>${item.name}</strong>
            <br>
            <small>${item.data.category} • 탄수화물 ${item.data.carbs}g/100g • GI ${item.data.glycemicIndex}</small>
          </div>
          <div style="text-align: right; font-size: 0.875rem; color: #6b7280;">
            ${item.data.carbs}g
          </div>
        </div>
      `).join('');
      
      container.style.display = 'block';
    }

    function hideCalculatorFoodSuggestions() {
      const container = document.getElementById('calcFoodSuggestions');
      if (container) {
        container.style.display = 'none';
      }
    }

    function selectCalculatorFood(foodName) {
      document.getElementById('calcFood').value = foodName;
      hideCalculatorFoodSuggestions();
      updateCalculatorPreview();
    }

    function updateCalculatorPreview() {
      const food = document.getElementById('calcFood').value;
      const amount = document.getElementById('calcAmount').value;
      const preview = document.getElementById('calcPreview');
      const user = userManager.getCurrentUser();
      
      if (!food || !preview) return;
      
      let content = '';
      
      if (KOREAN_FOOD_DATABASE[food] && amount) {
        const foodData = KOREAN_FOOD_DATABASE[food];
        const carbs = Math.round(foodData.carbs * amount / 100);
        const protein = Math.round(foodData.protein * amount / 100);
        const fat = Math.round(foodData.fat * amount / 100);
        
        content += `
          <div class="preview-box">
            <h4 style="margin-bottom: 0.75rem; color: #1e40af;">영양 정보 분석</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem; text-align: center;">
              <div><strong>${carbs}g</strong><br><small>탄수화물</small></div>
              <div><strong>${protein}g</strong><br><small>단백질</small></div>
              <div><strong>${fat}g</strong><br><small>지방</small></div>
              <div><strong>GI ${foodData.glycemicIndex}</strong><br><small>혈당지수</small></div>
            </div>
          </div>
        `;
      }
      
      preview.innerHTML = content;
    }

    function calculateInsulin() {
      const glucose = parseFloat(document.getElementById('calcGlucose').value);
      const food = document.getElementById('calcFood').value;
      const amount = parseFloat(document.getElementById('calcAmount').value);
      
      if (!glucose || !food || !amount) {
        alert('모든 필수 항목을 입력하세요.');
        return;
      }
      
      if (!KOREAN_FOOD_DATABASE[food]) {
        alert('음식 정보가 없습니다. 직접 입력해주세요.');
        return;
      }
      
      const carbs = Math.round(KOREAN_FOOD_DATABASE[food].carbs * amount / 100);
      const user = userManager.getCurrentUser();
      
      const result = aiEngine.calculatePersonalizedInsulin(glucose, carbs, user.personalizedData);
      
      calculationResult = {
        glucose,
        food,
        amount,
        carbs,
        ...result,
        timestamp: new Date().toISOString()
      };
      
      const resultsContainer = document.getElementById('calcResults');
      resultsContainer.innerHTML = `
        <div class="ai-recommendations">
          <h3 style="margin-bottom: 1rem; color: #7c3aed;">AI 개인화 인슐린 계산 결과</h3>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
            <div style="text-align: center; padding: 1rem; background: rgba(255, 255, 255, 0.5); border-radius: 0.75rem;">
              <div style="font-size: 1.5rem; font-weight: bold; color: #7c3aed;">${result.carbInsulin}</div>
              <div style="font-size: 0.875rem; color: #6b7280;">탄수화물 인슐린</div>
            </div>
            
            <div style="text-align: center; padding: 1rem; background: rgba(255, 255, 255, 0.5); border-radius: 0.75rem;">
              <div style="font-size: 1.5rem; font-weight: bold; color: #7c3aed;">${result.correctionInsulin}</div>
              <div style="font-size: 0.875rem; color: #6b7280;">교정 인슐린</div>
            </div>
            
            <div style="text-align: center; padding: 1rem; background: rgba(139, 92, 246, 0.2); border-radius: 0.75rem; border: 2px solid #8b5cf6;">
              <div style="font-size: 2rem; font-weight: bold; color: #7c3aed;">${result.total}</div>
              <div style="font-size: 1rem; font-weight: 600; color: #7c3aed;">총 인슐린 단위</div>
            </div>
          </div>
        </div>
      `;
    }

    function saveCalculation() {
      if (!calculationResult) {
        alert('먼저 인슐린을 계산하세요.');
        return;
      }
      
      const record = {
        id: Date.now(),
        timestamp: calculationResult.timestamp,
        glucose: calculationResult.glucose,
        food: calculationResult.food,
        amount: calculationResult.amount,
        carbs: calculationResult.carbs,
        insulin: calculationResult.total
      };
      
      userManager.addRecord(record);
      alert('기록이 저장되었습니다!');
      
      document.getElementById('calcGlucose').value = '';
      document.getElementById('calcFood').value = '';
      document.getElementById('calcAmount').value = '';
      document.getElementById('calcPreview').innerHTML = '';
      document.getElementById('calcResults').innerHTML = '';
      calculationResult = null;
    }

    // 앱 초기화
    function initApp() {
      loadUserFoods(); // 사용자 음식 데이터 로드
      
      const currentUser = userManager.getCurrentUser();
      
      if (!currentUser) {
        renderAuthScreen();
      } else {
        renderMainApp();
      }
    }

    // 인증 화면 렌더링
    function renderAuthScreen() {
      document.getElementById('app').innerHTML = `
        <div class="auth-container">
          <div class="auth-card">
            <div class="auth-header">
              <h1>DiaLife Pro</h1>
              <p>개인화된 1형당뇨 관리 시스템</p>
            </div>
            
            <div id="loginForm">
              <h3 style="margin-bottom: 1rem; color: #1f2937;">로그인</h3>
              <div class="form-group" style="margin-bottom: 1rem;">
                <label for="loginUsername">사용자명</label>
                <input type="text" id="loginUsername" required placeholder="사용자명을 입력하세요">
              </div>
              <div class="form-group" style="margin-bottom: 1.5rem;">
                <label for="loginPassword">비밀번호</label>
                <input type="password" id="loginPassword" required placeholder="비밀번호를 입력하세요">
              </div>
              <button onclick="handleLogin()" class="btn btn-primary btn-full">로그인</button>
              
              <p style="text-align: center; margin: 1.5rem 0; color: #6b7280;">또는</p>
              
              <button onclick="showRegisterForm()" class="btn btn-success btn-full">
                새 계정 만들기
              </button>
            </div>
            
            <div id="registerForm" class="hidden">
              <h3 style="margin-bottom: 1rem; color: #1f2937;">회원가입</h3>
              <div class="form-grid">
                <div class="form-group">
                  <label for="regUsername">사용자명 *</label>
                  <input type="text" id="regUsername" required placeholder="사용자명">
                </div>
                <div class="form-group">
                  <label for="regPassword">비밀번호 *</label>
                  <input type="password" id="regPassword" required placeholder="비밀번호">
                </div>
                <div class="form-group">
                  <label for="regName">이름 *</label>
                  <input type="text" id="regName" required placeholder="실명">
                </div>
                <div class="form-group">
                  <label for="regAge">나이</label>
                  <input type="number" id="regAge" placeholder="나이" min="1" max="120">
                </div>
              </div>
              
              <button onclick="handleRegister()" class="btn btn-success btn-full" style="margin-bottom: 1rem;">
                회원가입 완료
              </button>
              
              <button onclick="showLoginForm()" class="btn btn-primary btn-full">
                로그인으로 돌아가기
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function showRegisterForm() {
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('registerForm').classList.remove('hidden');
    }

    function showLoginForm() {
      document.getElementById('registerForm').classList.add('hidden');
      document.getElementById('loginForm').classList.remove('hidden');
    }

    function handleLogin() {
      const username = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;
      
      if (!username || !password) {
        alert('사용자명과 비밀번호를 입력하세요.');
        return;
      }
      
      const user = userManager.login(username, password);
      
      if (user) {
        renderMainApp();
      } else {
        alert('로그인 실패. 사용자명과 비밀번호를 확인하세요.');
      }
    }

    function handleRegister() {
      const username = document.getElementById('regUsername').value;
      const password = document.getElementById('regPassword').value;
      const name = document.getElementById('regName').value;
      const age = document.getElementById('regAge').value;
      
      if (!username || !password || !name) {
        alert('필수 정보를 모두 입력하세요.');
        return;
      }
      
      const existingUser = Object.values(userManager.users).find(u => u.username === username);
      if (existingUser) {
        alert('이미 존재하는 사용자명입니다.');
        return;
      }
      
      const userData = {
        username,
        password,
        name,
        age: age ? parseInt(age) : null
      };
      
      const user = userManager.register(userData);
      userManager.currentUser = user;
      
      alert('회원가입이 완료되었습니다!');
      renderMainApp();
    }

    function logout() {
      userManager.currentUser = null;
      renderAuthScreen();
    }

    // 메인 앱 렌더링
    function renderMainApp() {
      const user = userManager.getCurrentUser();
      
      document.getElementById('app').innerHTML = `
        <div class="container">
          <header class="header">
            <div class="header-left">
              <h1>DiaLife Pro AI</h1>
              <div class="welcome">안녕하세요, ${user.name}님!</div>
            </div>
            <div class="header-right">
              <div class="user-info">
                <div class="user-name">${user.name} ${user.age ? '(' + user.age + '세)' : ''}</div>
                <div class="user-stats">
                  혈당 ${user.personalizedData.totalRecords}개 • 
                  평균 ${user.personalizedData.avgGlucose || 0}mg/dL • 
                  TIR ${user.personalizedData.timeInRange || 0}%
                </div>
              </div>
              <button onclick="logout()" class="btn btn-logout">로그아웃</button>
            </div>
          </header>

          <div class="tab-container">
            <div class="tab-buttons">
              <button class="tab-button ${currentTab === 'dashboard' ? 'active' : ''}" onclick="switchTab('dashboard')">
                대시보드
              </button>
              <button class="tab-button ${currentTab === 'calculator' ? 'active' : ''}" onclick="switchTab('calculator')">
                인슐린 계산
              </button>
            </div>
          </div>

          <div id="tabContent"></div>
        </div>
      `;

      renderTabContent();
    }

    function switchTab(tabName) {
      currentTab = tabName;
      renderMainApp();
    }

    function renderTabContent() {
      const container = document.getElementById('tabContent');
      const user = userManager.getCurrentUser();
      
      if (currentTab === 'dashboard') {
        renderDashboard(container, user);
      } else if (currentTab === 'calculator') {
        renderCalculator(container, user);
      }
    }

    function renderDashboard(container, user) {
      const data = user.personalizedData;
      
      container.innerHTML = `
        <div class="stats-dashboard">
          <div class="stat-card">
            <div class="stat-value">${data.avgGlucose || 0}</div>
            <div class="stat-label">평균 혈당 (mg/dL)</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${data.timeInRange || 0}%</div>
            <div class="stat-label">목표 범위 시간 (TIR)</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${data.totalRecords}</div>
            <div class="stat-label">총 기록 수</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${data.personalICR}</div>
            <div class="stat-label">개인 ICR</div>
          </div>
        </div>

        <div class="card">
          <h2>최근 기록</h2>
          ${user.records.length === 0 ? 
            '<p style="color: #6b7280; text-align: center; padding: 2rem;">아직 기록이 없습니다. 인슐린 계산기를 사용해보세요!</p>' :
            user.records.slice(-5).reverse().map(record => `
              <div style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <strong>${record.food || '기록'}</strong>
                    <div style="font-size: 0.875rem; color: #6b7280;">
                      ${new Date(record.timestamp).toLocaleString('ko-KR')}
                    </div>
                  </div>
                  <div style="text-align: right;">
                    <div style="font-size: 1.25rem; font-weight: 600; color: ${record.glucose < 70 ? '#ef4444' : record.glucose > 180 ? '#f59e0b' : '#10b981'};">
                      ${record.glucose} mg/dL
                    </div>
                    <div style="font-size: 0.875rem; color: #6b7280;">
                      ${record.carbs}g • ${record.insulin}단위
                    </div>
                  </div>
                </div>
              </div>
            `).join('')
          }
        </div>
      `;
    }

    function renderCalculator(container, user) {
      container.innerHTML = `
        <div class="card full-width">
          <h2>AI 개인화 인슐린 계산기</h2>
          <p style="color: #6b7280; margin-bottom: 1.5rem;">
            개인 데이터를 학습하여 맞춤형 인슐린 용량을 계산합니다.
            <strong>모든 계산 결과는 의료진과 상의 후 사용하세요.</strong>
          </p>
          
          <div class="form-grid">
            <div class="form-group">
              <label for="calcGlucose">현재 혈당 (mg/dL) *</label>
              <input type="number" id="calcGlucose" placeholder="혈당을 입력하세요" min="30" max="600">
            </div>
            
            <div class="form-group food-search">
              <label for="calcFood">음식 이름 *</label>
              <input type="text" id="calcFood" placeholder="음식을 검색하세요" autocomplete="off" onkeyup="showCalculatorFoodSuggestions(this.value)">
              <div id="calcFoodSuggestions" class="food-suggestions"></div>
            </div>
            
            <div class="form-group">
              <label for="calcAmount">섭취량 (g) *</label>
              <input type="number" id="calcAmount" placeholder="그램 단위" min="0" step="0.1" onchange="updateCalculatorPreview()">
            </div>
            
            <div class="form-group">
              <label for="calcMealTiming">식사 시점</label>
              <select id="calcMealTiming">
                <option value="before">식전</option>
                <option value="after">식후</option>
              </select>
            </div>
          </div>
          
          <div id="calcPreview"></div>
          
          <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
            <button onclick="calculateInsulin()" class="btn btn-ai btn-full">
              AI 인슐린 계산
            </button>
            <button onclick="saveCalculation()" class="btn btn-success">
              기록으로 저장
            </button>
          </div>
          
          <div id="calcResults"></div>
        </div>
      `;
    }

    // 앱 시작
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
